/**
 * PRICING CALCULATOR
 * Calculate shipping fees based on order information
 */
window.PricingCalculator = (function () {
  "use strict";

  let currentOrderData = {
    senderProvince: null,
    senderDistrict: null,
    receiverProvince: null,
    receiverDistrict: null,
    weight: 0,
    packageValue: 0,
    featuresCost: 0, // Ph·ª• ph√≠ t·ª´ package features (ƒë√£ t√≠nh s·∫µn)
    serviceCode: "SCN",
    additionalServicesCost: 0, // ph√≠ d·ªãch v·ª• c·ªông th√™m
    promotionDiscount: 0, // gi·∫£m gi√° khuy·∫øn m√£i
  };

  /**
   * Update order data
   */
  function updateOrderData(data) {
    currentOrderData = { ...currentOrderData, ...data };
    console.log("üí∞ Order data updated:", currentOrderData);

    // Log ki·ªÉm tra selectedServices
    if (Array.isArray(currentOrderData.selectedServices)) {
      console.log(
        "[OrderData] selectedServices:",
        currentOrderData.selectedServices
      );
    } else {
      console.log(
        "[OrderData] selectedServices is missing or not an array:",
        currentOrderData.selectedServices
      );
    }

    calculateAndDisplay();

    // Ph√°t s·ª± ki·ªán ƒë·ªÉ c√°c UI kh√°c c·∫≠p nh·∫≠t
    setTimeout(() => {
      document.dispatchEvent(
        new CustomEvent("orderDataChanged", { detail: currentOrderData })
      );
    }, 0);
  }

  /**
   * Calculate base shipping fee
   */
  function calculateShippingFee() {
    const {
      senderProvince,
      senderDistrict,
      receiverProvince,
      receiverDistrict,
      weight,
    } = currentOrderData;

    console.group("üì¶ [Ki·ªÉm tra d·ªØ li·ªáu t√≠nh ph√≠]");
    console.table({
      senderProvince,
      senderDistrict,
      receiverProvince,
      receiverDistrict,
      weight,
      packageValue: currentOrderData.packageValue,
      featuresCost: currentOrderData.featuresCost,
      serviceCode: currentOrderData.serviceCode,
      additionalServicesCost: currentOrderData.additionalServicesCost,
      promotionDiscount: currentOrderData.promotionDiscount,
    });
    console.groupEnd();

    // Ki·ªÉm tra ƒë·ªß d·ªØ li·ªáu
    if (
      !receiverProvince ||
      !senderProvince ||
      !receiverDistrict ||
      !senderDistrict ||
      !weight ||
      weight <= 0 ||
      !currentOrderData.packageValue
    ) {
      console.warn("‚ö†Ô∏è Ch∆∞a ƒë·ªß th√¥ng tin ƒë·ªÉ t√≠nh ph√≠!", {
        receiverProvince,
        receiverDistrict,
        senderProvince,
        senderDistrict,
        weight,
        packageValue: currentOrderData.packageValue,
      });
      return null;
    }

    if (!window.ScopeData) {
      console.error("‚ùå ScopeData not available");
      return null;
    }

    const scopeCode = window.ScopeData.determineScope(
      senderProvince,
      senderDistrict || "",
      receiverProvince,
      receiverDistrict || ""
    );
    const baseFee = window.ScopeData.calculateShippingFee(scopeCode, weight);

    if (baseFee === null) return null;

    return { baseFee, scopeCode };
  }

  /**
   * Get special product fees (already calculated by Package module)
   */
  function getSpecialProductFees() {
    return currentOrderData.featuresCost || 0;
  }

  /**
   * Calculate total fee
   */
  function calculateTotalFee() {
    const shippingResult = calculateShippingFee();
    if (!shippingResult) return null;

    const promotionDiscount = currentOrderData.promotionDiscount || 0;
    const codFee = currentOrderData.codFee || 0;
    const featuresCost = currentOrderData.featuresCost || 0;

    // ‚úÖ T√≠nh ph√≠ d·ªãch v·ª• c·ªông th√™m
    let additionalServicesCost = currentOrderData.additionalServicesCost || 0;
    if (
      Array.isArray(currentOrderData.selectedServices) &&
      additionalServicesCost === 0
    ) {
      additionalServicesCost = currentOrderData.selectedServices.reduce(
        (sum, code) => {
          return sum + (window.ServiceData?.getServiceCost(code) || 0);
        },
        0
      );
    }

    const totalFee =
      shippingResult.baseFee +
      featuresCost +
      codFee +
      additionalServicesCost -
      promotionDiscount;

    const estimateTime =
      window.ScopeData && typeof window.ScopeData.getEstimateTime === "function"
        ? window.ScopeData.getEstimateTime(shippingResult.scopeCode)
        : 1;

    return {
      baseFee: shippingResult.baseFee,
      additionalServicesCost,
      codFee,
      featuresCost,
      promotionDiscount,
      totalFee,
      estimateTime,
      scopeCode: shippingResult.scopeCode,
    };
  }

  /**
   * Calculate and display pricing
   */
  function calculateAndDisplay() {
    console.group("üßÆ [DEBUG] QUY TR√åNH T√çNH PH√ç");
    console.table({
      senderProvince: currentOrderData.senderProvince,
      senderDistrict: currentOrderData.senderDistrict,
      receiverProvince: currentOrderData.receiverProvince,
      receiverDistrict: currentOrderData.receiverDistrict,
      weight: currentOrderData.weight,
      value: currentOrderData.packageValue,
    });

    const result = calculateTotalFee();

    if (!result) {
      console.warn(
        "‚ö†Ô∏è Kh√¥ng t√≠nh ƒë∆∞·ª£c ph√≠ v√¨ thi·∫øu d·ªØ li·ªáu ho·∫∑c baseFee null!"
      );
    } else {
      console.log("‚úÖ K·∫øt qu·∫£ t√≠nh ph√≠:", result);
    }

    console.groupEnd();
    displayPricing(result);
  }

  /**
   * Display pricing in the UI
   */
  function displayPricing(result) {
    const pricingSummaryBar = document.getElementById("pricingSummaryBar");
    if (!pricingSummaryBar) return;

    const basicSummary = pricingSummaryBar.querySelector(
      "#basicSummary .summary-value"
    );
    if (basicSummary)
      basicSummary.textContent = result
        ? formatCurrency(result.totalFee)
        : "0 ƒë";

    if (!result) return;

    // C·∫≠p nh·∫≠t chi ti·∫øt
    const detailedSummary = pricingSummaryBar.querySelector("#detailedSummary");
    if (detailedSummary) {
      const summaryItems = detailedSummary.querySelectorAll(".summary-item");

      if (summaryItems[0])
        summaryItems[0].querySelector(".summary-value").textContent =
          formatCurrency(result.totalFee);

      if (summaryItems[3])
        summaryItems[3].querySelector(
          ".summary-value"
        ).textContent = `${result.estimateTime} ng√†y`;
    }

    // Log breakdown (fix l·ªói specialFees undefined)
    const selectedServices = Array.isArray(currentOrderData.selectedServices)
      ? currentOrderData.selectedServices
      : [];

    const serviceCosts = selectedServices.map((code) => ({
      code,
      cost: window.ServiceData?.getServiceCost(code) || 0,
    }));

    console.log("üìä Pricing breakdown:", {
      baseFee: formatCurrency(result.baseFee),
      featuresCost: formatCurrency(result.featuresCost),
      additionalServicesCost: formatCurrency(result.additionalServicesCost),
      codFee: formatCurrency(result.codFee),
      totalFee: formatCurrency(result.totalFee),
      estimateTime: result.estimateTime + " ng√†y",
      scopeCode: result.scopeCode,
      selectedServices,
      serviceCosts,
    });

    // üîî NEW: G·ª≠i event ƒë·ªÉ module COD c·∫≠p nh·∫≠t ti·ªÅn tr·∫£ ng∆∞·ªùi g·ª≠i
    document.dispatchEvent(
      new CustomEvent("orderDataChanged", {
        detail: { totalFee: result.totalFee },
      })
    );
  }

  /**
   * Format currency VND
   */
  function formatCurrency(amount) {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount || 0);
  }

  /**
   * Get current pricing
   */
  function getCurrentPricing() {
    return calculateTotalFee();
  }

  /**
   * Reset calculator
   */
  function reset() {
    currentOrderData = {
      receiverProvince: null,
      receiverDistrict: null,
      senderProvince: null,
      senderDistrict: null,
      weight: 0,
      packageValue: 0,
      featuresCost: 0,
      serviceCode: "SCN",
      additionalServicesCost: 0,
      promotionDiscount: 0,
    };
    displayPricing(null);
  }

  /**
   * Initialize pricing calculator listeners
   */
  function init() {
    setupAddressListeners();
    setupWeightListeners();
    setupSpecialProductListeners();
    console.log("üí∞ Pricing Calculator initialized");
    document.addEventListener("codChanged", (e) => {
      console.log("üí¨ COD changed:", e.detail);
      // N·∫øu c√≥ ph√≠ thu h·ªô trong t∆∞∆°ng lai, th√™m x·ª≠ l√Ω t·∫°i ƒë√¢y
      calculateAndDisplay();
    });
  }

  /**
   * Setup address change listeners
   */
  function setupAddressListeners() {
    // Ng∆∞·ªùi g·ª≠i l√† receiver (dropdown ng∆∞·ªùi g·ª≠i)
    document.addEventListener("receiverChanged", (e) => {
      console.log("üìç Ng∆∞·ªùi g·ª≠i changed:", e.detail);
      if (!e.detail || !e.detail.address) {
        console.warn("D·ªØ li·ªáu ng∆∞·ªùi g·ª≠i thi·∫øu th√¥ng tin address:", e.detail);
        return;
      }
      const addr = e.detail.address;
      updateOrderData({
        receiverProvince: addr.province,
        receiverDistrict: addr.district,
        receiverWard: addr.ward,
      });
    });

    // Ng∆∞·ªùi nh·∫≠n l√† sender
    const senderProvinceSelect = document.getElementById("provinceSelect");
    const senderDistrictSelect = document.getElementById("districtSelect");

    if (senderProvinceSelect) {
      senderProvinceSelect.addEventListener("locationChange", (e) => {
        console.log("üìç Ng∆∞·ªùi nh·∫≠n (sender) province changed:", e.detail);
        let value =
          typeof e.detail.text === "string" ? e.detail.text.trim() : "";
        updateOrderData({ senderProvince: value, senderDistrict: null });
      });
    }

    if (senderDistrictSelect) {
      senderDistrictSelect.addEventListener("locationChange", (e) => {
        console.log("üìç Ng∆∞·ªùi nh·∫≠n (sender) district changed:", e.detail);
        let value =
          typeof e.detail.text === "string" ? e.detail.text.trim() : "";
        updateOrderData({ senderDistrict: value });
      });
    }
  }

  /**
   * Setup weight change listeners
   */
  function setupWeightListeners() {
    document.addEventListener("packageItemsChanged", (e) => {
      updateOrderData({
        weight: e.detail.totalWeight || 0,
        packageValue: e.detail.totalValue || 0,
        featuresCost: e.detail.featuresCost || 0,
      });
    });
  }

  /**
   * Setup special product type listeners
   */
  function setupSpecialProductListeners() {
    // featuresCost ƒë√£ ƒë∆∞·ª£c t√≠nh trong packageItemsChanged event
  }

  // Public API
  return {
    init,
    updateOrderData,
    calculateTotalFee,
    getCurrentPricing,
    displayPricing,
    reset,
  };
})();
