// /**
//  * PRICING CALCULATOR
//  * Calculate shipping fees based on order information
//  */
// window.PricingCalculator = (function () {
//   "use strict";

//   let currentOrderData = {
//     senderProvince: null,
//     senderDistrict: null,
//     receiverProvince: null,
//     receiverDistrict: null,
//     weight: 0,
//     packageValue: 0,
//     featuresCost: 0, // Ph·ª• ph√≠ t·ª´ package features (ƒë√£ t√≠nh s·∫µn)
//     serviceCode: "SCN",
//     additionalServicesCost: 0, // ph√≠ d·ªãch v·ª• c·ªông th√™m
//     promotionDiscount: 0, // gi·∫£m gi√° khuy·∫øn m√£i
//   };

//   /**
//    * Update order data
//    */
//   function updateOrderData(data) {
//     currentOrderData = { ...currentOrderData, ...data };
//     // ...

//     calculateAndDisplay();

//     // Ph√°t s·ª± ki·ªán ƒë·ªÉ c√°c UI kh√°c c·∫≠p nh·∫≠t
//     setTimeout(() => {
//       document.dispatchEvent(
//         new CustomEvent("orderDataChanged", { detail: currentOrderData })
//       );
//     }, 0);
//   }

//   /**
//    * Calculate base shipping fee
//    */
//   function calculateShippingFee() {
//     const {
//       senderProvince,
//       senderDistrict,
//       receiverProvince,
//       receiverDistrict,
//       weight,
//     } = currentOrderData;

//     // ...

//     // Ki·ªÉm tra ƒë·ªß d·ªØ li·ªáu
//     if (
//       !receiverProvince ||
//       !senderProvince ||
//       !receiverDistrict ||
//       !senderDistrict ||
//       !weight ||
//       weight <= 0 ||
//       !currentOrderData.packageValue
//     ) {
//       // ...
//       return null;
//     }

//     if (!window.ScopeData) {
//   // ...
//       return null;
//     }

//     const scopeCode = window.ScopeData.determineScope(
//       senderProvince,
//       senderDistrict || "",
//       receiverProvince,
//       receiverDistrict || ""
//     );
//     const baseFee = window.ScopeData.calculateShippingFee(scopeCode, weight);
//     // ====== T·ª∞ ƒê·ªòNG T√çNH PH√ç & C·∫¨P NH·∫¨T SAU M·ªåI THAY ƒê·ªîI ======
// const recalculationEvents = [
//   "userChanged", 
//   "receiverChanged", 
//   "postOfficeSelected", 
//   "packageItemsChanged", 
//   "codChanged", 
//   "serviceChanged"
// ];

// recalculationEvents.forEach(eventName => {
//   document.addEventListener(eventName, async () => {
//     if (!window.PricingCalculator?.calculateTotalFee) return;

//     const pricingResult = window.PricingCalculator.calculateTotalFee();

//     if (pricingResult) {
//       // C·∫≠p nh·∫≠t v√†o CreateOrderData
//       window.CreateOrderData.totalPrice = pricingResult.totalFee;
//       window.CreateOrderData.deliveryTime = pricingResult.estimateTime;
//       window.CreateOrderData.codCost = pricingResult.codFee || 0;

//       // N·∫øu c√≥ kho·∫£ng c√°ch, c·∫≠p nh·∫≠t lu√¥n
//       if (pricingResult.distance) {
//         window.CreateOrderData.distance = pricingResult.distance;
//       } else if (window.ScopeData?.calculateDistance) {
//         const d = window.ScopeData.calculateDistance(
//           window.CreateOrderData.sender?.address?.province,
//           window.CreateOrderData.sender?.address?.district,
//           window.CreateOrderData.receiver?.address?.province,
//           window.CreateOrderData.receiver?.address?.district
//         );
//         if (d) window.CreateOrderData.distance = d;
//       }

//       logOrderDataSummary && logOrderDataSummary();
//     }
//   });
// });

//     if (baseFee === null) return null;

//     return { baseFee, scopeCode };
//   }

//   /**
//    * Get special product fees (already calculated by Package module)
//    */
//   function getSpecialProductFees() {
//     return currentOrderData.featuresCost || 0;
//   }

//   /**
//    * Calculate total fee
//    */
//   function calculateTotalFee() {
//     // Log ƒë·∫ßu v√†o ƒë·ªÉ ki·ªÉm tra h√†m c√≥ ƒë∆∞·ª£c g·ªçi kh√¥ng
//     console.log('[PRICING DEBUG] calculateTotalFee called', JSON.parse(JSON.stringify(currentOrderData)));
//     const shippingResult = calculateShippingFee();
//     if (!shippingResult) {
//       console.warn('[PRICING DEBUG] shippingResult is null, not enough data to calculate fee', JSON.parse(JSON.stringify(currentOrderData)));
//       return null;
//     }
//     if (!shippingResult) return null;

//     const promotionDiscount = currentOrderData.promotionDiscount || 0;
//     const codFee = currentOrderData.codFee || 0;
//     const featuresCost = currentOrderData.featuresCost || 0;

//     // ‚úÖ T√≠nh ph√≠ d·ªãch v·ª• c·ªông th√™m
//     let additionalServicesCost = currentOrderData.additionalServicesCost || 0;
//     if (
//       Array.isArray(currentOrderData.selectedServices) &&
//       additionalServicesCost === 0
//     ) {
//       additionalServicesCost = currentOrderData.selectedServices.reduce(
//         (sum, code) => {
//           return sum + (window.ServiceData?.getServiceCost(code) || 0);
//         },
//         0
//       );
//     }

//     // T·ªïng ph√≠
//     var totalPrice =
//       shippingResult.baseFee +
//       featuresCost +
//       codFee +
//       additionalServicesCost -
//       promotionDiscount;

//     // T√≠nh deliveryTime (ISODate)
//     var deliveryTime = null;
//     try {
//       var senderPickup = window.CreateOrderData && window.CreateOrderData.sender ? window.CreateOrderData.sender.pickupTime : null;
//       var pickupDate = senderPickup ? new Date(senderPickup) : new Date();
//       var estimateDays = 1;
//       if (window.ScopeData && typeof window.ScopeData.getEstimateTime === "function") {
//         estimateDays = window.ScopeData.getEstimateTime(shippingResult.scopeCode) || 1;
//       }
//       // N·∫øu c√≥ shippingService th√¨ l·∫•y estimate_time_hours
//       var shippingServiceObj = window.CreateOrderData && window.CreateOrderData.shippingService ? window.CreateOrderData.shippingService : null;
//       var estimateHours = null;
//       if (shippingServiceObj && shippingServiceObj.estimate_time_hours) {
//         estimateHours = shippingServiceObj.estimate_time_hours;
//       }
//       if (estimateHours) {
//         pickupDate.setHours(pickupDate.getHours() + estimateHours);
//       } else {
//         pickupDate.setDate(pickupDate.getDate() + estimateDays);
//       }
//       deliveryTime = pickupDate.toISOString();
//     } catch (err) {
//       deliveryTime = null;
//     }

//     // T√≠nh distance (gi·∫£ l·∫≠p, d√πng ƒë·ªãa ch·ªâ ng∆∞·ªùi g·ª≠i/nh·∫≠n)
//     var distance = null;
//     try {
//       var senderAddr = window.CreateOrderData && window.CreateOrderData.sender ? window.CreateOrderData.sender.address : null;
//       var receiverAddr = window.CreateOrderData && window.CreateOrderData.receiver ? window.CreateOrderData.receiver.address : null;
//       if (senderAddr && receiverAddr) {
//         if (senderAddr.province && receiverAddr.province) {
//           if (senderAddr.province === receiverAddr.province) {
//             distance = 5.0;
//           } else {
//             distance = 1650.0;
//           }
//         }
//       }
//     } catch (err) {
//       distance = null;
//     }

//     // Ch·ªâ d√πng d·ªãch v·ª• Chuy·ªÉn ph√°t nhanh
//     var shippingService = null;
//     if (window.CreateOrderData && window.CreateOrderData.shippingService) {
//       shippingService = window.CreateOrderData.shippingService;
//     } else {
//       if (window.ServiceData && window.ServiceData.getShippingServiceByCode) {
//         shippingService = window.ServiceData.getShippingServiceByCode('EXPRESS_SOUTH') || null;
//       }
//     }

//     // estimateTime (ng√†y) v·∫´n gi·ªØ cho UI
//     var estimateTime = window.ScopeData && typeof window.ScopeData.getEstimateTime === "function"
//       ? window.ScopeData.getEstimateTime(shippingResult.scopeCode)
//       : 1;

//     // Log c√°c gi√° tr·ªã c·∫ßn ki·ªÉm tra
//     console.log('[PRICING DEBUG]', {
//       baseFee: shippingResult.baseFee,
//       additionalServicesCost: additionalServicesCost,
//       codFee: codFee,
//       featuresCost: featuresCost,
//       promotionDiscount: promotionDiscount,
//       totalFee: totalPrice,
//       totalPrice: totalPrice
//     });
//     return {
//       baseFee: shippingResult.baseFee,
//       additionalServicesCost: additionalServicesCost,
//       codFee: codFee,
//       featuresCost: featuresCost,
//       promotionDiscount: promotionDiscount,
//       totalFee: totalPrice,
//       totalPrice: totalPrice,
//       deliveryTime: deliveryTime,
//       distance: distance,
//       estimateTime: estimateTime,
//       scopeCode: shippingResult.scopeCode,
//       shippingService: shippingService
//     };
//   }

//   /**
//    * Calculate and display pricing
//    */
//   function calculateAndDisplay() {
//     const result = calculateTotalFee();
//     displayPricing(result);
//     // ‚úÖ C·∫≠p nh·∫≠t CreateOrderData m·ªói l·∫ßn t√≠nh ph√≠
//   if (result && window.CreateOrderData) {
//     window.CreateOrderData.totalPrice = result.totalFee || 0;
//     window.CreateOrderData.deliveryTime = result.estimateTime || null;
//     window.CreateOrderData.distance = result.distance || null;

//     console.log("[DEBUG][ORDER DATA SUMMARY]", {
//       totalPrice: window.CreateOrderData.totalPrice,
//       deliveryTime: window.CreateOrderData.deliveryTime,
//       distance: window.CreateOrderData.distance,
//       codCost: window.CreateOrderData.codInfo?.codCost || 0
//     });
//   }

//   // üîî G·ª≠i event ƒë·ªÉ UI update
//   document.dispatchEvent(new CustomEvent("orderPricingCalculated", {
//     detail: result
//   }));
//   }

//   /**
//    * Display pricing in the UI
//    */
//   function displayPricing(result) {
//     const pricingSummaryBar = document.getElementById("pricingSummaryBar");
//     if (!pricingSummaryBar) return;

//     const basicSummary = pricingSummaryBar.querySelector(
//       "#basicSummary .summary-value"
//     );
//     if (basicSummary)
//       basicSummary.textContent = result
//         ? formatCurrency(result.totalFee)
//         : "0 ƒë";

//     if (!result) return;

//     // C·∫≠p nh·∫≠t chi ti·∫øt
//     const detailedSummary = pricingSummaryBar.querySelector("#detailedSummary");
//     if (detailedSummary) {
//       const summaryItems = detailedSummary.querySelectorAll(".summary-item");

//       if (summaryItems[0])
//         summaryItems[0].querySelector(".summary-value").textContent =
//           formatCurrency(result.totalFee);

//       if (summaryItems[3])
//         summaryItems[3].querySelector(
//           ".summary-value"
//         ).textContent = `${result.estimateTime} ng√†y`;
//     }

//     // Log breakdown (fix l·ªói specialFees undefined)
//     const selectedServices = Array.isArray(currentOrderData.selectedServices)
//       ? currentOrderData.selectedServices
//       : [];

//     const serviceCosts = selectedServices.map((code) => ({
//       code,
//       cost: window.ServiceData?.getServiceCost(code) || 0,
//     }));

//     // ...

//     // üîî G·ª≠i event m·ªõi v·ªõi to√†n b·ªô k·∫øt qu·∫£ t√≠nh ph√≠
//     document.dispatchEvent(
//       new CustomEvent("orderPricingCalculated", {
//         detail: result
//       })
//     );
//   }

//   /**
//    * Format currency VND
//    */
//   function formatCurrency(amount) {
//     return new Intl.NumberFormat("vi-VN", {
//       style: "currency",
//       currency: "VND",
//     }).format(amount || 0);
//   }

//   /**
//    * Get current pricing
//    */
//   function getCurrentPricing() {
//     return calculateTotalFee();
//   }

//   /**
//    * Reset calculator
//    */
//   function reset() {
//     currentOrderData = {
//       receiverProvince: null,
//       receiverDistrict: null,
//       senderProvince: null,
//       senderDistrict: null,
//       weight: 0,
//       packageValue: 0,
//       featuresCost: 0,
//       serviceCode: "SCN",
//       additionalServicesCost: 0,
//       promotionDiscount: 0,
//     };
//     displayPricing(null);
//   }

//   /**
//    * Initialize pricing calculator listeners
//    */
//   function init() {
//     setupAddressListeners();
//     setupWeightListeners();
//     setupSpecialProductListeners();
//   // ...
//     document.addEventListener("codChanged", (e) => {
//       // N·∫øu c√≥ ph√≠ thu h·ªô trong t∆∞∆°ng lai, th√™m x·ª≠ l√Ω t·∫°i ƒë√¢y
//       calculateAndDisplay();
//     });
//   }

//   /**
//    * Setup address change listeners
//    */
//   function setupAddressListeners() {
//     // Ng∆∞·ªùi g·ª≠i l√† receiver (dropdown ng∆∞·ªùi g·ª≠i)
//     document.addEventListener("receiverChanged", (e) => {
//       if (!e.detail || !e.detail.address) {
//         return;
//       }
//       const addr = e.detail.address;
//       updateOrderData({
//         receiverProvince: addr.province,
//         receiverDistrict: addr.district,
//         receiverWard: addr.ward,
//       });
//     });

//     // Ng∆∞·ªùi nh·∫≠n l√† sender
//     const senderProvinceSelect = document.getElementById("provinceSelect");
//     const senderDistrictSelect = document.getElementById("districtSelect");

//     if (senderProvinceSelect) {
//       senderProvinceSelect.addEventListener("locationChange", (e) => {
//   // ...
//         let value =
//           typeof e.detail.text === "string" ? e.detail.text.trim() : "";
//         updateOrderData({ senderProvince: value, senderDistrict: null });
//       });
//     }

//     if (senderDistrictSelect) {
//       senderDistrictSelect.addEventListener("locationChange", (e) => {
//   // ...
//         let value =
//           typeof e.detail.text === "string" ? e.detail.text.trim() : "";
//         updateOrderData({ senderDistrict: value });
//       });
//     }
//   }

//   /**
//    * Setup weight change listeners
//    */
//   function setupWeightListeners() {
//     document.addEventListener("packageItemsChanged", (e) => {
//       updateOrderData({
//         weight: e.detail.totalWeight || 0,
//         packageValue: e.detail.totalValue || 0,
//         featuresCost: e.detail.featuresCost || 0,
//       });
//     });
//   }

//   /**
//    * Setup special product type listeners
//    */
//   function setupSpecialProductListeners() {
//     // featuresCost ƒë√£ ƒë∆∞·ª£c t√≠nh trong packageItemsChanged event
//   }

//   // Public API
//   return {
//     init,
//     updateOrderData,
//     calculateTotalFee,
//     getCurrentPricing,
//     displayPricing,
//     reset,
//   };
// })();
// document.dispatchEvent(new CustomEvent("orderPricingCalculated", {
//   detail: result
// }));
