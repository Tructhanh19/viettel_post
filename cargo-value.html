<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý dòng tiền & Thống kê - Viettel Post</title>
    <link rel="stylesheet" href="assets/cargo-value.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

    <div class="page-container">
        <nav class="tab-nav">
            <a href="#thong-ke" class="tab-link active" data-tab="thong-ke">Thống kê</a>
            <a href="#dong-tien" class="tab-link" data-tab="dong-tien">Dòng tiền</a>
        </nav>

        <main>
            <div id="thong-ke" class="tab-content active">
                <div class="stats-header">
                    <div class="header-left">
                        <h2>Tiền hàng theo trạng thái (Tính theo ngày gửi)</h2>
                        <div class="total-orders"><span>Số lượng đơn hàng</span><b>0</b></div>
                    </div>
                    <div class="header-right">
                        <div class="summary-item"><span>Tổng tiền thu hộ <i class="fa-regular fa-circle-question"></i></span><b>0 ₫</b></div>
                        <div class="summary-item"><span>Tổng tiền cước <i class="fa-regular fa-circle-question"></i></span><b>0 ₫</b></div>
                        <div class="filter-control dropdown-wrapper"><select><option>COD gồm cước người nhận trả</option><option>COD không gồm cước người nhận trả</option></select></div>
                        <div class="filter-control date-picker-wrapper"><input type="text" id="statsDatePicker" placeholder="Chọn khoảng thời gian"><i class="fa-regular fa-calendar-days calendar-icon"></i></div>
                    </div>
                </div>
                <div class="stats-body">
                    <div class="chart-container card"><div class="chart-placeholder circle"></div></div>
                    <div class="tables-container">
                        <div class="table-card card">
                             <table>
                                <thead><tr><th>Trạng thái</th><th>Số đơn</th><th>Tiền thu hộ (VNĐ)</th><th>Tiền cước</th></tr></thead>
                                <tbody>
                                    <tr><td><span class="dot" style="background-color: #f0ad4e;"></span>Đối soát</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #9b59b6;"></span>Đang vận chuyển</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #5bc0de;"></span>Đang giao hàng</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #777;"></span>Chờ phát lại</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #5cb85c;"></span>Giao thành công</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #8d6e63;"></span>Chờ xử lý</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                </tbody>
                            </table>
                        </div>
                         <div class="table-card card">
                             <table>
                                <thead><tr><th>Trạng thái khác <i class="fa-regular fa-circle-question"></i></th><th>Số đơn</th><th>Tiền thu hộ (VNĐ)</th><th>Tiền cước</th></tr></thead>
                                <tbody>
                                    <tr><td><span class="dot" style="background-color: #337ab7;"></span>Tạo mới</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #81d4fa;"></span>Đã tiếp nhận</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #81d4fa;"></span>Đang lấy hàng</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr class="active-row"><td><span class="dot" style="background-color: #ef4444;"></span>Tồn - Lấy không thành công</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #bcaaa4;"></span>Đã hủy giao</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #ef4444;"></span>VTP hủy lấy</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #ffcc80;"></span>Shop hủy lấy</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #ffd600;"></span>Đang xác minh bồi thường</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                    <tr><td><span class="dot" style="background-color: #bcaaa4;"></span>Đã bồi thường</td><td>0</td><td>0 ₫</td><td>0 ₫</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dong-tien" class="tab-content">
                 <div class="cashflow-header">
                    <div class="header-left">
                        <h1>Quản lý dòng tiền</h1>
                        <span>(Cập nhật lần cuối lúc 23:03)</span>
                    </div>
                    <div class="header-right">
                        <div class="cash-summary-item blue"><i class="fa-solid fa-wallet"></i><div><span>Số dư <i class="fa-regular fa-circle-question"></i></span><b>0 ₫</b></div></div>
                        <div class="cash-summary-item red-outline"><i class="fa-solid fa-money-bill-transfer"></i><div><span>Rút tiền</span><b>0 ₫</b></div></div>
                        <div class="cash-summary-item white"><i class="fa-solid fa-hand-holding-dollar"></i><div><span>Nạp cước <i class="fa-regular fa-circle-question"></i></span><b>0 ₫</b></div></div>
                        <button class="btn btn-red">Thanh toán</button>
                    </div>
                </div>
                <div class="cashflow-body">
                    <div class="cashflow-column">
                        <h2>Tiền hàng</h2>
                        <div class="card-row">
                            <div class="info-card card"><span>Đang luân chuyển</span><b>0 ₫</b><i class="fa-solid fa-arrow-right-long"></i></div>
                            <div class="info-card card"><span>Chờ trả</span><b>0 ₫</b><i class="fa-solid fa-arrow-right-long"></i></div>
                        </div>
                        <div class="chart-card card">
                            <div class="chart-header">
                                <div>
                                    <h3>Thông tin kê tiền hàng <i class="fa-regular fa-circle-question"></i></h3>
                                    <span class="chart-subtitle">(Đơn vị tính: VNĐ)</span>
                                </div>
                                <div class="chart-legend">
                                    <span><span class="dot" style="background-color: #ffc107;"></span>Tiền thu hộ</span>
                                    <span><span class="dot" style="background-color: #28a745;"></span>Tiền hàng hoàn</span>
                                    <span><span class="dot" style="background-color: #007bff;"></span>Tiền đã trả</span>
                                </div>
                            </div>
                            <div class="chart-controls">
                                <a href="#" class="chart-link">Xem DS bảng kê đã trả</a>
                                <div class="filter-control date-picker-wrapper">
                                    <input type="text" class="date-range-picker-simple" placeholder="Chọn ngày">
                                    <i class="fa-regular fa-calendar-days calendar-icon"></i>
                                </div>
                            </div>
                            <div class="chart-placeholder-area">
                                <svg width="100%" height="250" class="line-chart-svg">
                                    <text x="0" y="245" dy=".3em">0</text><text x="0" y="195" dy=".3em">200k</text><text x="0" y="145" dy=".3em">400k</text><text x="0" y="95" dy=".3em">600k</text><text x="0" y="45" dy=".3em">800k</text><text x="0" y="5" dy=".3em">1Tr</text>
                                    <line x1="40" y1="245" x2="100%" y2="245"></line><line x1="40" y1="195" x2="100%" y2="195"></line><line x1="40" y1="145" x2="100%" y2="145"></line><line x1="40" y1="95" x2="100%" y2="95"></line><line x1="40" y1="45" x2="100%" y2="45"></line>
                                    <polyline points="80,245 150,245 220,245 290,245 360,245 430,245 500,245 570,245" />
                                    <circle cx="80" cy="245" r="4"></circle><circle cx="150" cy="245" r="4"></circle><circle cx="220" cy="245" r="4"></circle><circle cx="290" cy="245" r="4"></circle><circle cx="360" cy="245" r="4"></circle><circle cx="430" cy="245" r="4"></circle><circle cx="500" cy="245" r="4"></circle><circle cx="570" cy="245" r="4"></circle>
                                    <text x="80" y="265">01/10</text><text x="150" y="265">02/10</text><text x="220" y="265">03/10</text><text x="290" y="265">04/10</text><text x="360" y="265">05/10</text><text x="430" y="265">06/10</text><text x="500" y="265">07/10</text><text x="570" y="265">08/10</text>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="cashflow-column">
                        <h2>Cước phí</h2>
                        <div class="card-row">
                            <div class="info-card card"><span>Nợ cước chưa trả</span><b>0 ₫</b><i class="fa-solid fa-arrow-right-long"></i></div>
                            <div class="info-card card"><span>Tổng cước đã trả (7 ngày qua)</span><b>0 ₫</b><i class="fa-solid fa-arrow-right-long"></i></div>
                        </div>
                        <div class="chart-card card">
                            <div class="chart-header">
                                <h3>Thông tin kê cước phí <i class="fa-regular fa-circle-question"></i></h3>
                                 <div class="filter-control date-picker-wrapper">
                                    <input type="text" class="date-range-picker-simple" placeholder="Chọn ngày">
                                    <i class="fa-regular fa-calendar-days calendar-icon"></i>
                                </div>
                            </div>
                             <div class="chart-placeholder-area bar-chart">
                                <div class="bar-chart-y-axis">
                                    <span>Tổng cước phí</span><span>Phí giao hàng</span><span>Phí hoàn</span><span>Phí chuyển tiếp</span>
                                </div>
                                <div class="bar-chart-grid">
                                    <div class="bar-chart-x-axis">
                                        <span>0</span><span>100k</span><span>200k</span><span>300k</span><span>400k</span><span>500k</span><span>600k</span><span>700k</span><span>800k</span><span>900k</span><span>1Tr</span>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <button class="chat-button"><i class="fa-solid fa-comment-dots"></i></button>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
    <script>
    // --- BỌC TẤT CẢ VÀO HÀM INIT ---
    function initCargoValuePage() {
        console.log("🚀 Initializing Cargo Value Page UI..."); // Thêm log
        // --- Tab Switching ---
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabLinks.forEach(link => {
            // Xóa listener cũ trước khi thêm mới (đề phòng gọi init nhiều lần)
            link.removeEventListener('click', handleTabClick);
            link.addEventListener('click', handleTabClick);
        });

        function handleTabClick(e) {
             e.preventDefault();
             const targetTab = e.currentTarget.dataset.tab;
             console.log(` Mở tab: ${targetTab}`);
             tabLinks.forEach(l => l.classList.remove('active'));
             tabContents.forEach(c => c.classList.remove('active'));
             e.currentTarget.classList.add('active');
             const targetContent = document.getElementById(targetTab);
             if (targetContent) targetContent.classList.add('active');
        }


        // --- Date Picker cho tab Thống kê (phức tạp) ---
         // Thêm kiểm tra nếu flatpickr tồn tại
        if (typeof flatpickr !== 'undefined') {
            flatpickr("#statsDatePicker", {
                mode: "range", dateFormat: "d/m/Y", locale: "vn",
                defaultDate: ["25/09/2025", "08/10/2025"], showMonths: 2,
                onReady: function(selectedDates, dateStr, instance) {
                    console.log("📅 Flatpickr #statsDatePicker sẵn sàng.");
                    const shortcuts = document.createElement('div');
                    shortcuts.className = 'flatpickr-shortcuts';
                    const options = ['Hôm nay', 'Hôm qua', '7 ngày trước', '14 ngày trước', '30 ngày trước', 'Tháng này', 'Tháng trước'];

                    options.forEach(optionText => {
                        const btn = document.createElement('button');
                        btn.className = 'shortcut-button';
                        // Đặt active dựa trên defaultDate (14 ngày trước)
                        const fourteenDaysAgo = new Date();
                        fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 13);
                        const defaultStart = new Date("2025-09-25"); // Lấy từ defaultDate
                         // So sánh ngày thay vì toàn bộ Date object
                        if (optionText === '14 ngày trước' &&
                            fourteenDaysAgo.toDateString() === defaultStart.toDateString() ) {
                               btn.classList.add('active');
                        }

                        btn.textContent = optionText;
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const now = new Date();
                            let start = new Date(now), end = new Date(now);
                            // ... (switch case giữ nguyên) ...
                             switch(optionText) {
                                case 'Hôm nay': break;
                                case 'Hôm qua': start.setDate(now.getDate() - 1); end.setDate(now.getDate() - 1); break;
                                case '7 ngày trước': start.setDate(now.getDate() - 6); break;
                                case '14 ngày trước': start.setDate(now.getDate() - 13); break;
                                case '30 ngày trước': start.setDate(now.getDate() - 29); break;
                                case 'Tháng này': start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); break;
                                case 'Tháng trước': start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); break;
                            }
                            // Bỏ active tất cả nút shortcut khác
                            shortcuts.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active'); // Đặt active cho nút được click
                            instance.setDate([start, end], true); // Cập nhật lịch và trigger onChange
                        });
                        shortcuts.appendChild(btn);
                    });
                     // Chèn shortcuts vào đầu calendarContainer
                    if (instance.calendarContainer) {
                        instance.calendarContainer.prepend(shortcuts);
                    } else {
                        console.warn("⚠️ calendarContainer không tìm thấy để chèn shortcuts.");
                    }
                },
                // --- THÊM onChange ĐỂ GỌI LẠI API ---
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        console.log("🗓️ Date range #statsDatePicker thay đổi, tải lại CargoData...");
                         // Bỏ active tất cả nút shortcut khi chọn ngày thủ công
                         instance.calendarContainer.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));

                        if (window.CargoData && typeof window.CargoData.init === 'function') {
                             // Gọi lại init để load lại dữ liệu với ngày mới
                             window.CargoData.init();
                        } else {
                            console.error("❌ CargoData.init không khả dụng khi date range thay đổi!");
                        }
                    }
                }
                 // --- KẾT THÚC onChange ---
            });

             // --- Date Picker cho tab Dòng tiền (đơn giản) ---
             document.querySelectorAll('.date-range-picker-simple').forEach(picker => {
                 flatpickr(picker, {
                     mode: "range",
                     dateFormat: "d/m/Y",
                     locale: "vn",
                     defaultDate: ["01/10/2025", "08/10/2025"],
                     // --- THÊM onChange (nếu cần load lại phần biểu đồ dòng tiền) ---
                     onChange: function(selectedDates, dateStr, instance) {
                         if (selectedDates.length === 2) {
                             const from = selectedDates[0].toISOString();
                             const to = selectedDates[1].toISOString();
                             console.log(`🗓️ Date range simple picker thay đổi: ${from} to ${to}. TODO: Tải lại dữ liệu biểu đồ nếu cần.`);
                             // Ví dụ: if (window.SomeChartModule) { window.SomeChartModule.loadChartData(from, to); }
                         }
                     }
                     // --- KẾT THÚC onChange ---
                 });
             });

        } else {
            console.error("❌ Thư viện Flatpickr chưa được tải!");
             // Có thể hiển thị thông báo lỗi cho người dùng
             const datePickers = document.querySelectorAll('#statsDatePicker, .date-range-picker-simple');
             datePickers.forEach(dp => dp.placeholder = "Lỗi tải lịch");
        }


        // --- Clickable Table Rows ---
        const allTableRows = document.querySelectorAll('.table-card tbody tr');
        allTableRows.forEach(row => {
             row.removeEventListener('click', handleTableRowClick); // Xóa listener cũ
             row.addEventListener('click', handleTableRowClick); // Thêm listener mới
        });

         function handleTableRowClick(event) {
             console.log("🖱️ Clicked table row");
             // Bỏ active tất cả các dòng trong cùng bảng hoặc tất cả các bảng
             const parentTable = event.currentTarget.closest('table');
             parentTable.querySelectorAll('tbody tr').forEach(r => r.classList.remove('active-row'));
             // Đặt active cho dòng được click
             event.currentTarget.classList.add('active-row');
         }

        // --- GỌI HÀM TẢI DỮ LIỆU TỪ cargo-data.js ---
        if (window.CargoData && typeof window.CargoData.init === 'function') {
            console.log("🚀 Calling CargoData.init() from cargo-value.html");
            window.CargoData.init(); // Tải dữ liệu ban đầu
        } else {
            console.error("❌ CargoData or CargoData.init not available!");
             // Hiển thị lỗi trên UI
             showGenericErrorUI("Lỗi: Không thể tải module dữ liệu dòng tiền.");
        }
        // --- KẾT THÚC GỌI HÀM TẢI DỮ LIỆU ---

        console.log("✅ Cargo Value Page UI Initialized"); // Thêm log cuối
    } // --- End initCargoValuePage ---

    // --- Helper function to show generic errors ---
     function showGenericErrorUI(message) {
         const mainContainer = document.querySelector('main');
         if (!mainContainer) return;
         let errorDiv = mainContainer.querySelector('.generic-error-ui');
         if (!errorDiv) {
             errorDiv = document.createElement('div');
             errorDiv.className = 'generic-error-ui';
             errorDiv.style.cssText = "background:#f8d7da; color:#721c24; padding:10px 15px; margin:15px 0; text-align:center; border:1px solid #f5c6cb; border-radius: 6px; font-size:14px;";
             mainContainer.prepend(errorDiv); // Thêm vào đầu thẻ main
         }
         errorDiv.textContent = message;
     }


    // --- LOGIC KIỂM TRA ĐỂ GỌI HÀM INIT ---
    if (document.readyState === "loading") {
        // Chạy độc lập: Đợi DOM load xong
        document.addEventListener("DOMContentLoaded", initCargoValuePage);
    } else {
        // Chạy qua index.html (DOM đã load): Chạy ngay!
        initCargoValuePage();
    }
    </script>
    <script src="assets/api/config.js"></script>
    <script src="assets/api/cargo-data.js"></script> </body>
</html>