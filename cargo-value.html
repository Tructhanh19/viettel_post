<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω d√≤ng ti·ªÅn & Th·ªëng k√™ - Viettel Post</title>
    <link rel="stylesheet" href="assets/cargo-value.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

    <div class="page-container">
        <nav class="tab-nav">
            <a href="#thong-ke" class="tab-link active" data-tab="thong-ke">Th·ªëng k√™</a>
            <a href="#dong-tien" class="tab-link" data-tab="dong-tien">D√≤ng ti·ªÅn</a>
        </nav>

        <main>
            <div class="generic-error-ui" style="display: none; background:#f8d7da; color:#721c24; padding:10px 15px; margin:15px 20px; text-align:center; border:1px solid #f5c6cb; border-radius: 6px; font-size:14px;"></div>

            <div id="thong-ke" class="tab-content active">
                <div class="stats-header">
                    <div class="header-left">
                        <h2>Ti·ªÅn h√†ng theo tr·∫°ng th√°i (T√≠nh theo ng√†y g·ª≠i)</h2>
                        <div class="total-orders"><span>S·ªë l∆∞·ª£ng ƒë∆°n h√†ng</span><b>0</b></div>
                    </div>
                    <div class="header-right">
                        <div class="summary-item"><span>T·ªïng ti·ªÅn thu h·ªô <i class="fa-regular fa-circle-question"></i></span><b>0 ‚Ç´</b></div>
                        <div class="summary-item"><span>T·ªïng ti·ªÅn c∆∞·ªõc <i class="fa-regular fa-circle-question"></i></span><b>0 ‚Ç´</b></div>
                        <div class="filter-control dropdown-wrapper"><select><option>COD g·ªìm c∆∞·ªõc ng∆∞·ªùi nh·∫≠n tr·∫£</option><option>COD kh√¥ng g·ªìm c∆∞·ªõc ng∆∞·ªùi nh·∫≠n tr·∫£</option></select></div>
                        <div class="filter-control date-picker-wrapper"><input type="text" id="statsDatePicker" placeholder="Ch·ªçn kho·∫£ng th·ªùi gian"><i class="fa-regular fa-calendar-days calendar-icon"></i></div>
                    </div>
                </div>
                <div class="stats-body">
                    <div class="chart-container card"><div class="chart-placeholder circle"></div></div>
                    <div class="tables-container">
                        <div class="table-card card">
                             <table>
                                <thead><tr><th>Tr·∫°ng th√°i</th><th>S·ªë ƒë∆°n</th><th>Ti·ªÅn thu h·ªô (VNƒê)</th><th>Ti·ªÅn c∆∞·ªõc</th></tr></thead>
                                <tbody>
                                    <tr><td><span class="dot" style="background-color: #f0ad4e;"></span>ƒê·ªëi so√°t</td><td>0</td><td>0 ‚Ç´</td><td>0 ‚Ç´</td></tr>
                                    <tr><td><span class="dot" style="background-color: #9b59b6;"></span>ƒêang v·∫≠n chuy·ªÉn</td><td>0</td><td>0 ‚Ç´</td><td>0 ‚Ç´</td></tr>
                                    <tr><td><span class="dot" style="background-color: #5bc0de;"></span>ƒêang giao h√†ng</td><td>0</td><td>0 ‚Ç´</td><td>0 ‚Ç´</td></tr>
                                    <tr><td><span class="dot" style="background-color: #777;"></span>Ch·ªù ph√°t l·∫°i</td><td>0</td><td>0 ‚Ç´</td><td>0 ‚Ç´</td></tr>
                                    <tr><td><span class="dot" style="background-color: #5cb85c;"></span>Giao th√†nh c√¥ng</td><td>0</td><td>0 ‚Ç´</td><td>0 ‚Ç´</td></tr>
                                    <tr><td><span class="dot" style="background-color: #8d6e63;"></span>Ch·ªù x·ª≠ l√Ω</td><td>0</td><td>0 ‚Ç´</td><td>0 ‚Ç´</td></tr>
                                    <tr><td><span class="dot" style="background-color: #aaaaaa;"></span>ƒê∆°n nh√°p</td><td>0</td><td>0 ‚Ç´</td><td>0 ‚Ç´</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dong-tien" class="tab-content">
                 <div class="cashflow-header">
                    <div class="header-left">
                        <h1>Qu·∫£n l√Ω d√≤ng ti·ªÅn</h1>
                        <span>(C·∫≠p nh·∫≠t l·∫ßn cu·ªëi l√∫c <span id="cashflowLastUpdated">--:--</span>)</span>
                    </div>
                    <div class="header-right">
                        <div class="cash-summary-item blue"><i class="fa-solid fa-wallet"></i><div><span>S·ªë d∆∞ <i class="fa-regular fa-circle-question"></i></span><b>0 ‚Ç´</b></div></div>
                        <div class="cash-summary-item red-outline"><i class="fa-solid fa-money-bill-transfer"></i><div><span>R√∫t ti·ªÅn</span><b>0 ‚Ç´</b></div></div>
                        <div class="cash-summary-item white"><i class="fa-solid fa-hand-holding-dollar"></i><div><span>N·∫°p c∆∞·ªõc <i class="fa-regular fa-circle-question"></i></span><b>0 ‚Ç´</b></div></div>
                        <button class="btn btn-red">Thanh to√°n</button>
                    </div>
                </div>
                <div class="cashflow-body">
                    <div class="cashflow-column">
                        <h2>Ti·ªÅn h√†ng</h2>
                        <div class="card-row">
                            <div class="info-card card"><span>ƒêang lu√¢n chuy·ªÉn</span><b>0 ‚Ç´</b><i class="fa-solid fa-arrow-right-long"></i></div>
                            <div class="info-card card"><span>Ch·ªù tr·∫£</span><b>0 ‚Ç´</b><i class="fa-solid fa-arrow-right-long"></i></div>
                        </div>
                        <div class="chart-card card">
                            <div class="chart-header">
                                <div>
                                    <h3>Th√¥ng tin k√™ ti·ªÅn h√†ng <i class="fa-regular fa-circle-question"></i></h3>
                                    <span class="chart-subtitle">(ƒê∆°n v·ªã t√≠nh: VNƒê)</span>
                                </div>
                                <div class="chart-legend">
                                    <span><span class="dot" style="background-color: #ffc107;"></span>Ti·ªÅn thu h·ªô</span>
                                    <span><span class="dot" style="background-color: #28a745;"></span>Ti·ªÅn h√†ng ho√†n</span>
                                    <span><span class="dot" style="background-color: #007bff;"></span>Ti·ªÅn ƒë√£ tr·∫£</span>
                                </div>
                            </div>
                            <div class="chart-controls">
                                <a href="#" class="chart-link">Xem DS b·∫£ng k√™ ƒë√£ tr·∫£</a>
                                <div class="filter-control date-picker-wrapper">
                                    <input type="text" class="date-range-picker-simple" id="cashflowDatePicker1" placeholder="Ch·ªçn ng√†y">
                                    <i class="fa-regular fa-calendar-days calendar-icon"></i>
                                </div>
                            </div>
                            <div class="chart-placeholder-area">
                                <svg width="100%" height="250" class="line-chart-svg">
                                     <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#aaa">Bi·ªÉu ƒë·ªì ti·ªÅn h√†ng (ch∆∞a c√≥)</text>
                                    <line x1="40" y1="245" x2="100%" y2="245" stroke="#eee"></line>
                                    <line x1="40" y1="5" x2="40" y2="245" stroke="#eee"></line>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="cashflow-column">
                        <h2>C∆∞·ªõc ph√≠</h2>
                        <div class="card-row">
                            <div class="info-card card"><span>N·ª£ c∆∞·ªõc ch∆∞a tr·∫£</span><b>0 ‚Ç´</b><i class="fa-solid fa-arrow-right-long"></i></div>
                            <div class="info-card card"><span>T·ªïng c∆∞·ªõc ƒë√£ tr·∫£ (7 ng√†y qua)</span><b>0 ‚Ç´</b><i class="fa-solid fa-arrow-right-long"></i></div>
                        </div>
                        <div class="chart-card card">
                            <div class="chart-header">
                                <h3>Th√¥ng tin k√™ c∆∞·ªõc ph√≠ <i class="fa-regular fa-circle-question"></i></h3>
                                 <div class="filter-control date-picker-wrapper">
                                    <input type="text" class="date-range-picker-simple" id="cashflowDatePicker2" placeholder="Ch·ªçn ng√†y">
                                    <i class="fa-regular fa-calendar-days calendar-icon"></i>
                                </div>
                            </div>
                             <div class="chart-placeholder-area bar-chart">
                                <div style="display: flex; height: 100%; align-items: center; justify-content: center; color: #aaa;">Bi·ªÉu ƒë·ªì c∆∞·ªõc ph√≠ (ch∆∞a c√≥)</div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <button class="chat-button"><i class="fa-solid fa-comment-dots"></i></button>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
    <script>
    // --- B·ªåC T·∫§T C·∫¢ V√ÄO H√ÄM INIT ---
    function initCargoValuePage() {
        console.log("üöÄ Initializing Cargo Value Page UI...");

        // --- Helper function to show errors ---
         function showCargoPageError(message) {
             const errorDiv = document.querySelector('.generic-error-ui'); // L·∫•y div l·ªói chung
             if (errorDiv) {
                 errorDiv.textContent = `‚ùå ${message}`;
                 errorDiv.style.display = 'block'; // Hi·ªÉn th·ªã div l·ªói
             } else { // Fallback n·∫øu div kh√¥ng t·ªìn t·∫°i
                 console.error("L·ªñI HI·ªÇN TH·ªä:", message);
             }
             // T√πy ch·ªçn: ·∫®n l·ªói sau v√†i gi√¢y
             // setTimeout(() => { if (errorDiv) errorDiv.style.display = 'none'; }, 7000);
         }
         // H√†m ·∫©n l·ªói khi c·∫ßn
         function hideCargoPageError() {
              const errorDiv = document.querySelector('.generic-error-ui');
              if (errorDiv) errorDiv.style.display = 'none';
         }


        // --- Tab Switching ---
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabLinks.forEach(link => {
            link.removeEventListener('click', handleTabClick);
            link.addEventListener('click', handleTabClick);
        });

        function handleTabClick(e) { /* ... gi·ªØ nguy√™n ... */
             e.preventDefault();
             const targetTab = e.currentTarget.dataset.tab;
             console.log(` M·ªü tab: ${targetTab}`);
             tabLinks.forEach(l => l.classList.remove('active'));
             tabContents.forEach(c => c.classList.remove('active'));
             e.currentTarget.classList.add('active');
             const targetContent = document.getElementById(targetTab);
             if (targetContent) targetContent.classList.add('active');
        }

        // --- Date Picker Initialization ---
        let isCargoDataLoadedInitially = false;
        if (typeof flatpickr !== 'undefined') {
            // Stats Date Picker
            flatpickr("#statsDatePicker", {
                mode: "range", dateFormat: "d/m/Y", locale: "vn",
                defaultDate: ["25/09/2025", "08/10/2025"], showMonths: 2,
                onReady: function(selectedDates, dateStr, instance) {
                    console.log("üìÖ Flatpickr #statsDatePicker s·∫µn s√†ng.");
                    const shortcuts = document.createElement('div');
                    shortcuts.className = 'flatpickr-shortcuts';
                    const options = ['H√¥m nay', 'H√¥m qua', '7 ng√†y tr∆∞·ªõc', '14 ng√†y tr∆∞·ªõc', '30 ng√†y tr∆∞·ªõc', 'Th√°ng n√†y', 'Th√°ng tr∆∞·ªõc'];

                    options.forEach(optionText => { /* ... t·∫°o shortcut buttons gi·ªØ nguy√™n ... */
                        const btn = document.createElement('button');
                        btn.className = 'shortcut-button';
                        if (optionText === '14 ng√†y tr∆∞·ªõc') btn.classList.add('active');
                        btn.textContent = optionText;
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const now = new Date(); let start = new Date(now), end = new Date(now);
                            switch(optionText) {
                                case 'H√¥m nay': break;
                                case 'H√¥m qua': start.setDate(now.getDate() - 1); end.setDate(now.getDate() - 1); break;
                                case '7 ng√†y tr∆∞·ªõc': start.setDate(now.getDate() - 6); break;
                                case '14 ng√†y tr∆∞·ªõc': start.setDate(now.getDate() - 13); break;
                                case '30 ng√†y tr∆∞·ªõc': start.setDate(now.getDate() - 29); break;
                                case 'Th√°ng n√†y': start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); break;
                                case 'Th√°ng tr∆∞·ªõc': start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); break;
                            }
                            shortcuts.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            instance.setDate([start, end], true);
                        });
                        shortcuts.appendChild(btn);
                    });
                     if (instance.calendarContainer) instance.calendarContainer.prepend(shortcuts);

                     // --- G·ªåI H√ÄM T·∫¢I D·ªÆ LI·ªÜU BAN ƒê·∫¶U T·ª™ onReady ---
                     if (!isCargoDataLoadedInitially) {
                          hideCargoPageError(); // ·∫®n l·ªói c≈© tr∆∞·ªõc khi t·∫£i
                          if (window.CargoData && typeof window.CargoData.init === 'function') {
                             console.log("üöÄ Calling CargoData.init() from Flatpickr onReady...");
                             window.CargoData.init();
                             isCargoDataLoadedInitially = true;
                         } else {
                             console.error("‚ùå CargoData.init kh√¥ng kh·∫£ d·ª•ng trong onReady!");
                             showCargoPageError("L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu d√≤ng ti·ªÅn (module l·ªói).");
                         }
                     }
                     // --- K·∫æT TH√öC G·ªåI H√ÄM T·∫¢I D·ªÆ LI·ªÜU BAN ƒê·∫¶U ---

                },
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        console.log("üóìÔ∏è Date range #statsDatePicker thay ƒë·ªïi, t·∫£i l·∫°i CargoData...");
                         if (instance.calendarContainer) instance.calendarContainer.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));

                         hideCargoPageError(); // ·∫®n l·ªói c≈© tr∆∞·ªõc khi t·∫£i l·∫°i
                         if (window.CargoData && typeof window.CargoData.init === 'function') {
                            window.CargoData.init(); // G·ªçi l·∫°i init ƒë·ªÉ load d·ªØ li·ªáu m·ªõi
                        } else {
                            console.error("‚ùå CargoData.init kh√¥ng kh·∫£ d·ª•ng khi date range thay ƒë·ªïi!");
                            showCargoPageError("L·ªói: Kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu theo ng√†y.");
                        }
                    }
                }
            });

            // Simple Date Pickers (Cashflow tab)
            document.querySelectorAll('.date-range-picker-simple').forEach(picker => {
                flatpickr(picker, { /* ... options gi·ªØ nguy√™n ... */
                    mode: "range",
                    dateFormat: "d/m/Y",
                    locale: "vn",
                    defaultDate: ["01/10/2025", "08/10/2025"],
                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length === 2) {
                            const from = selectedDates[0].toISOString();
                            const to = selectedDates[1].toISOString();
                            console.log(`üóìÔ∏è Date range simple picker (${picker.id}) thay ƒë·ªïi: ${from} to ${to}. TODO: T·∫£i l·∫°i d·ªØ li·ªáu bi·ªÉu ƒë·ªì n·∫øu c·∫ßn.`);
                        }
                    }
                });
            });

        } else { // Tr∆∞·ªùng h·ª£p Flatpickr kh√¥ng t·∫£i ƒë∆∞·ª£c
            console.error("‚ùå Th∆∞ vi·ªán Flatpickr ch∆∞a ƒë∆∞·ª£c t·∫£i!");
            showCargoPageError("L·ªói: Kh√¥ng th·ªÉ kh·ªüi t·∫°o b·ªô ch·ªçn ng√†y.");
             document.querySelectorAll('#statsDatePicker, .date-range-picker-simple').forEach(dp => {
                 if(dp) dp.placeholder = "L·ªói t·∫£i l·ªãch";
             });
             // V·∫´n g·ªçi t·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu (d√πng ng√†y m·∫∑c ƒë·ªãnh b√™n trong CargoData.init)
             if (!isCargoDataLoadedInitially) {
                 hideCargoPageError(); // ·∫®n l·ªói c≈©
                 if (window.CargoData && typeof window.CargoData.init === 'function') {
                     console.warn("‚ö†Ô∏è Flatpickr l·ªói, g·ªçi CargoData.init() kh√¥ng c√≥ ng√†y c·ª• th·ªÉ.");
                     window.CargoData.init();
                     isCargoDataLoadedInitially = true;
                 } else {
                      console.error("‚ùå Flatpickr l·ªói V√Ä CargoData.init kh√¥ng kh·∫£ d·ª•ng!");
                      showCargoPageError("L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.");
                 }
             }
        }

        // --- Clickable Table Rows (Event Delegation) ---
        const tablesContainer = document.querySelector('#thong-ke .tables-container');
         if (tablesContainer) {
             tablesContainer.removeEventListener('click', handleTableRowClick);
             tablesContainer.addEventListener('click', handleTableRowClick);
         }

        function handleTableRowClick(event) { /* ... gi·ªØ nguy√™n ... */
             const row = event.target.closest('tbody tr');
             if (!row || !row.parentElement) return;
             console.log("üñ±Ô∏è Clicked table row");
             row.parentElement.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
             row.classList.add('active-row');
        }

        console.log("‚úÖ Cargo Value Page UI Initialized");
    } // --- End initCargoValuePage ---


    // --- LOGIC KI·ªÇM TRA ƒê·ªÇ G·ªåI H√ÄM INIT ---
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCargoValuePage);
    } else {
        initCargoValuePage();
    }
    </script>
    <script src="assets/api/config.js"></script>
    <script src="assets/api/cargo-data.js"></script> </body>
</html>