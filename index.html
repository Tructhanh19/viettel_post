<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Viettel Post UI</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/style.css" />
    <link rel="stylesheet" href="assets/notifications.css" />
    <link rel="stylesheet" href="assets/branch-search.css" />
  </head>
  <body>
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle">
          <span class="hamburger"></span>
          <span class="hamburger"></span>
          <span class="hamburger"></span>
        </button>
        <div class="logo">viettel <span>post</span></div>
      </div>
      <div class="search">
        <input type="text" placeholder="Tra cứu đơn hàng" />
        <button class="search-btn"><i class="fas fa-search"></i></button>
      </div>
      <div class="user">
        <div class="user-dropdown" id="userDropdown">
          <div class="user-info">
            <span class="username user-name">User</span>
            <div class="user-avatar">
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </div>
          </div>
          <div class="user-menu">
            <ul>
              <li>
                <a href="#"><i class="fas fa-cog"></i> Cài đặt tài khoản</a>
              </li>
              <li>
                <a href="#" id="logoutBtn" data-logout
                  ><i class="fas fa-sign-out-alt"></i> Đăng xuất</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <nav class="sidebar-nav">
        <ul class="menu">
          <li class="menu-item active">
            <a href="#" class="menu-link" data-content="home">
              <i class="icon fas fa-home"></i>
              <span class="menu-text">Trang chủ</span>
            </a>
          </li>
          <li class="menu-item">
            <a
              href="#"
              class="menu-link"
              data-content="order/create-order-content.html"
            >
              <i class="icon fas fa-plus-circle"></i>
              <span class="menu-text">Tạo đơn</span>
            </a>
          </li>
          <li class="menu-item has-submenu" id="quanLyMenu">
            <a href="#" class="menu-link">
              <i class="icon fas fa-tasks"></i>
              <span class="menu-text">Quản lý</span>
              <i class="dropdown-icon fas fa-chevron-down"></i>
            </a>
            <ul class="submenu">
              <li>
                <a href="#" class="menu-link" data-content="shipments.html"
                  >Quản lý vận đơn</a
                >
              </li>
              <li>
                <a href="#" class="menu-link" data-content="cargo-value.html"
                  >Thống kê tiền hàng</a
                >
              </li>
              <li>
                <a href="#" class="menu-link" data-content="revenue.html"
                  >Thống kê doanh thu</a
                >
              </li>
              <li>
                <a href="#" class="menu-link" data-content="recipients.html"
                  >Danh sách người nhận</a
                >
              </li>
              <li>
                <a href="#" class="menu-link" data-content="feedback.html"
                  >Góp ý - Khiếu nại</a
                >
              </li>
            </ul>
          </li>
          <li class="menu-item has-submenu" id="traCuuMenu">
            <a href="#" class="menu-link">
              <i class="icon fas fa-map-marker-alt"></i>
              <span class="menu-text">Tra cứu</span>
              <i class="dropdown-icon fas fa-chevron-down"></i>
            </a>
            <ul class="submenu">
              <li>
                <a href="#" data-content="branch-search.html"
                  >Tra cứu bưu cục</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="menu-link"
                  data-content="research/postage.html"
                  >Ước tính cước phí</a
                >
              </li>
            </ul>
          </li>
          <li class="menu-item" id="accountSettingsMenu">
            <a href="./AccountSetting/sidebar.html" class="menu-link">
              <i class="icon fas fa-cog"></i>
              <span class="menu-text">Cài đặt tài khoản</span>
            </a>
          </li>
          <li class="menu-item has-submenu" id="hoiDapMenu">
            <a href="#" class="menu-link">
              <i class="icon fas fa-life-ring"></i>
              <span class="menu-text">Hỏi đáp trợ giúp</span>
              <i class="dropdown-icon fas fa-chevron-down"></i>
            </a>
            <ul class="submenu">
              <li><a href="#">Câu hỏi thường gặp FAQs</a></li>
              <li><a href="#">Điều khoản & quy định</a></li>
              <li><a href="#">Chính sách bảo mật thông tin</a></li>
            </ul>
          </li>
          <li class="menu-item">
            <a href="#" class="menu-link">
              <i class="icon fas fa-chart-bar"></i>
              <span class="menu-text">Khảo sát</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content" id="mainContent">
      <div class="content-header">
        <h1>Xin chào <strong id="userFullname">User</strong></h1>
        <div class="date-picker">
          <input type="date" value="2025-09-23" /> -
          <input type="date" value="2025-10-06" />
        </div>
      </div>

      <div class="dashboard">
        <div class="stats-section">
          <h2><i class="fas fa-chart-line"></i> THỐNG KÊ ĐƠN HÀNG</h2>
          <div class="stats-cards">
            <div class="stat-card success">
              <div class="stat-info">
                <span class="stat-label"
                  ><i class="fas fa-check-circle"></i> Giao thành công</span
                >
                <span class="stat-value">0 (0%)</span>
              </div>
            </div>
            <div class="stat-card failed">
              <div class="stat-info">
                <span class="stat-label"
                  ><i class="fas fa-undo"></i> Đã hoàn</span
                >
                <span class="stat-value">0</span>
              </div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="orderChart" width="400" height="200"></canvas>
          </div>
        </div>

        <div class="top-products">
          <h2><i class="fas fa-chart-pie"></i> TOP 10 SẢN LƯỢNG</h2>
          <p>Cập nhật lần cuối lúc 17:21</p>
          <div class="pie-chart">
            <canvas id="pieChart" width="200" height="200"></canvas>
          </div>
        </div>
      </div>
    </main>

    <!-- JavaScript Files -->
    <script src="assets/api/config.js"></script>
    <script src="assets/utils.js"></script>
    <script src="assets/auth.js"></script>
    <script src="assets/script.js"></script>
    <script>
    (function(){
      'use strict';
      async function resolveUserName(){
        const el = document.getElementById('userFullname');
        if (!el) return;
        let name = null;
        try {
          // 1) Try API_CONFIG helpers that may return user object or name directly
          try {
            if (window.API_CONFIG) {
              if (typeof API_CONFIG.getUserName === 'function') {
                const v = await API_CONFIG.getUserName();
                if (v) name = v;
              }
              if (!name && typeof API_CONFIG.getCurrentUser === 'function') {
                const u = await API_CONFIG.getCurrentUser();
                name = u?.name || u?.fullName || u?.username || name;
              }
              if (!name && typeof API_CONFIG.getUserProfile === 'function') {
                const u = await API_CONFIG.getUserProfile();
                name = u?.name || u?.fullName || u?.username || name;
              }
            }
          } catch(e){
            console.warn('[index] API_CONFIG lookup failed', e);
          }

          // 2) Try UserData helper (preferred alternative)
          if (!name && window.UserData) {
            try {
              if (typeof UserData.getCurrentUser === 'function') {
                const u = await UserData.getCurrentUser();
                name = u?.name || u?.fullName || u?.username || name;
              } else if (typeof UserData.init === 'function') {
                await UserData.init();
                const id = typeof window.API_CONFIG?.getUserId === 'function' ? window.API_CONFIG.getUserId() : null;
                if (id && typeof UserData.getUserById === 'function') {
                  const u = UserData.getUserById(id);
                  name = u?.name || u?.fullName || u?.username || name;
                } else if (typeof UserData.getAllUsers === 'function') {
                  const list = UserData.getAllUsers() || [];
                  const u = list[0] || null;
                  name = u?.name || u?.fullName || u?.username || name;
                }
              }
            } catch(e){
              console.warn('[index] UserData look-up failed', e);
            }
          }

          // 3) Fallback: try to decode JWT token from storage to extract name
          if (!name) {
            const tokenKeys = ['accessToken','id_token','token','authToken'];
            let token = null;
            for (const k of tokenKeys) {
              token = localStorage.getItem(k) || sessionStorage.getItem(k);
              if (token) break;
            }
            if (token) {
              try {
                const parts = token.split('.');
                if (parts.length >= 2) {
                  const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
                  name = payload?.name || payload?.fullName || payload?.username || payload?.preferred_username || payload?.sub || name;
                }
              } catch(e){
                console.warn('[index] token decode failed', e);
              }
            }
          }

          // 4) Last resort: if API_CONFIG.getUserId returns a username-like value, use it
          if (!name && typeof window.API_CONFIG?.getUserId === 'function') {
            const v = window.API_CONFIG.getUserId();
            if (v) name = v;
          }
        } catch(e){
          console.warn('[index] resolveUserName error', e);
        }
        if (!name) name = 'User';
        el.textContent = name;
      }
      document.addEventListener('DOMContentLoaded', resolveUserName);
    })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Thêm Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Thêm script xử lý dashboard -->
<script src="assets/api/dashboard-stats.js"></script>
  </body>
</html>
