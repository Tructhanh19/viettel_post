<div class="create-order-content">
    <div class="order-form-container">
        <div class="row">
            <!-- Left Column: receiver, Receiver, Service -->
            <div class="col-md-6">
                <div id="sender-info"></div>
                <div id="receiver-info"></div>
                <div id="service-selection"></div>
            </div>
            
            <!-- Right Column: Package Info, COD -->
            <div class="col-md-6">
                <div id="package-info"></div>
                <div id="cod-info"></div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Pricing Summary Bar -->
<div class="pricing-summary-floating" id="pricingSummaryBar">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <!-- Left side - Summary info -->
      <div class="d-flex align-items-center gap-4">
        <!-- Detailed Summary (Hidden by default) -->
        <div class="detailed-summary-items d-flex gap-4" id="detailedSummary">
          <div class="summary-item">
            <div class="summary-label">
              <i class="fas fa-info-circle me-1"></i>
              Tổng cước
            </div>
            <div class="summary-value" id="totalFeeDisplay">0 đ</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Tiền thu hộ</div>
            <div class="summary-value">0 đ</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Tiền trả người gửi</div>
            <div class="summary-value">0 đ</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Thời gian dự kiến</div>
            <div class="summary-value">1 ngày</div>
          </div>
        </div>
      </div>
      
      <!-- Right side - Actions -->
      <div class="d-flex align-items-center gap-3">
        <div class="form-check d-flex align-items-center me-2">
          <input class="form-check-input me-2" type="checkbox" id="agreeTerms" checked>
          <label class="form-check-label small text-white" for="agreeTerms">
            Tôi đã đọc và đồng ý với <a href="#" class="text-primary">Điều khoản quy định</a>
          </label>
        </div>
        <button type="button" class="btn btn-outline-light px-4 me-2">Gửi ngay</button>
        <button type="button" class="btn btn-secondary px-3">Lưu nhập</button>
        <button type="button" class="btn btn-secondary px-3">Làm mới</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="../assets/order/css/create-order.css">

<!-- ① API CONFIG + DATA LAYER -->
<script src="../assets/api/config.js"></script>
<script src="../assets/api/user-data.js"></script>
<script src="../assets/api/receiver-data.js"></script>

<!-- ② FETCH DATA LAYER (dùng API để lấy dữ liệu, render UI) -->
<script src="../assets/fetchData/address.js"></script>
<script src="../assets/fetchData/branch.js"></script>
<script src="../assets/fetchData/receiver.js"></script>
<script src="../assets/fetchData/package.js"></script>
<script src="../assets/fetchData/product.js"></script>
<script src="../assets/fetchData/service.js"></script>
<script src="../assets/fetchData/tag.js"></script>
<script src="../assets/fetchData/scope.js"></script>
<script src="../assets/fetchData/user.js"></script>

<!-- ③ ORDER MODULES (logic trang đặt hàng, event DOM, validation, pricing...) -->
<script src="../assets/order/js/utils.js"></script>
<script src="../assets/order/js/validation.js"></script>
<script src="../assets/order/js/pricing.js"></script>
<script src="../assets/order/js/user.js"></script>
<script src="../assets/order/js/receiver.js"></script>
<script src="../assets/order/js/service.js"></script>
<script src="../assets/order/js/package.js"></script>
<script src="../assets/order/js/pickup.js"></script>
<script src="../assets/order/js/tags.js"></script>
<script src="../assets/order/js/cod.js"></script>

<!-- ④ MAIN CONTROLLER -->
<script src="../assets/api/order-data.js"></script>
<script src="../assets/order/js/create-order.js"></script>
<script>
  // Toast notification
  function showToast(message, type = 'error') {
    let toast = document.createElement('div');
    toast.className = 'custom-toast custom-toast-' + type;
    toast.innerHTML = `<span>${message.replace(/\n/g, '<br>')}</span>`;
    document.body.appendChild(toast);
    setTimeout(() => { toast.classList.add('show'); }, 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 400);
    }, 3500);
  }

  // Load status map from JSON file (order_status.json)
  let statusMap = {};
  let statusList = [];
  function loadStatusMap() {
    if (Object.keys(statusMap).length > 0) return Promise.resolve();
    return fetch('../assets/data/order_status.json')
      .then(res => res.json())
      .then(list => {
        statusList = list;
        statusMap = {};
        list.forEach(item => {
          statusMap[item.code] = { code: item.code, name: item.name };
        });
      });
  }

  // Helper: Lấy dữ liệu đơn hàng từ window.CreateOrderData và chuẩn hóa
  async function getOrderPayload(statusCode) {
    await loadStatusMap();
    const data = window.CreateOrderData ? JSON.parse(JSON.stringify(window.CreateOrderData)) : {};

    data.status = statusMap[statusCode] || { code: statusCode, name: statusCode };

    if (data.receiver) {
      if (data.receiver.phone) {
        data.receiver.phoneNumber = data.receiver.phone;
        delete data.receiver.phone;
      }
      if (data.receiver.phone_number) {
        data.receiver.phoneNumber = data.receiver.phone_number;
        delete data.receiver.phone_number;
      }
    }

    if (data.sender) {
      if (data.sender.phone_number) {
        data.sender.phoneNumber = data.sender.phone_number;
        delete data.sender.phone_number;
      } else if (data.sender.phone) {
        data.sender.phoneNumber = data.sender.phone;
        delete data.sender.phone;
      }
    }

    if (data.shippingService) {
      if (data.shippingService.estimate_time_hours) {
        data.shippingService.estimateTimeHours = data.shippingService.estimate_time_hours;
        delete data.shippingService.estimate_time_hours;
      }
      if (typeof data.shippingService.totalPrice === 'undefined' && typeof data.shippingService.price !== 'undefined') {
        data.shippingService.totalPrice = data.shippingService.price;
      }
    }

    delete data.debug;
    return data;
  }

  // Đảm bảo OrderData đã load
  function waitForOrderData(cb) {
    if (window.OrderData && typeof window.OrderData.createOrder === 'function') {
      cb();
    } else {
      setTimeout(() => waitForOrderData(cb), 100);
    }
  }

  // Kiểm tra các trường bắt buộc
  function validateOrderRequiredFields(payload) {
    const errors = [];

    function phoneExists(person) {
      return Boolean(person && (person.phoneNumber || person.phone_number || person.phone || person.mobile));
    }

    if (!payload.sender || !payload.sender.name || !phoneExists(payload.sender)) {
      const parts = [];
      if (!payload.sender) parts.push('không có thông tin người gửi');
      else {
        if (!payload.sender.name) parts.push('tên người gửi');
        if (!phoneExists(payload.sender)) parts.push('số điện thoại người gửi');
      }
      errors.push('Thông tin người gửi chưa đầy đủ: ' + parts.join(', ') + '.');
    }

    if (!payload.receiver || !payload.receiver.name || !phoneExists(payload.receiver) || !payload.receiver.address) {
      const parts = [];
      if (!payload.receiver) parts.push('không có thông tin người nhận');
      else {
        if (!payload.receiver.name) parts.push('tên người nhận');
        if (!phoneExists(payload.receiver)) parts.push('số điện thoại người nhận');
        if (!payload.receiver.address) parts.push('địa chỉ người nhận');
      }
      errors.push('Thông tin người nhận chưa đầy đủ: ' + parts.join(', ') + '.');
    }

    const svc = payload.shippingService || payload.shipping_service;
    if (!svc || !(svc.serviceCode || svc.code)) {
      errors.push('Bạn chưa chọn dịch vụ vận chuyển.');
    }

    const pkgs = payload.packages || payload.packages_info || payload.items;
    if (!pkgs || !Array.isArray(pkgs) || pkgs.length === 0) {
      errors.push('Bạn chưa nhập thông tin kiện hàng.');
    }

    return errors;
  }

  // === XỬ LÝ NÚT - DÙNG EVENT DELEGATION (HOẠT ĐỘNG DÙ DOM BỊ THAY ĐỔI) ===
  document.addEventListener('click', async function(e) {
    const target = e.target;

    // Gửi ngay
    if (target.matches('.btn.btn-outline-light.px-4.me-2')) {
      e.preventDefault();
      e.stopPropagation();

      waitForOrderData(async () => {
        const payload = await getOrderPayload('RECEIVED');
        const errors = validateOrderRequiredFields(payload);
        if (errors.length > 0) {
          showToast('Vui lòng điền đầy đủ thông tin bắt buộc:<br>' + errors.map(e => '- ' + e).join('<br>'), 'error');
          return;
        }
        try {
          const res = await window.OrderData.createOrder(payload);
          showToast('Tạo đơn hàng thành công!', 'success');
          setTimeout(() => {
            try { window.CreateOrderData = {}; } catch(e) {}
            location.reload();
          }, 900);
        } catch (err) {
          showToast('Lỗi khi tạo đơn hàng: ' + (err?.message || err), 'error');
        }
      });
    }

    // Lưu nhập
    else if (target.matches('.btn.btn-secondary.px-3') && target.textContent.includes('Lưu nhập')) {
      e.preventDefault();
      e.stopPropagation();

      waitForOrderData(async () => {
        const payload = await getOrderPayload('DRAFT');
        try {
          await window.OrderData.createOrder(payload);
          showToast('Đã lưu đơn nháp!', 'success');
        } catch (err) {
          showToast('Lỗi khi lưu đơn nháp: ' + (err?.message || err), 'error');
        }
      });
    }

    // Làm mới
    else if (target.matches('.btn.btn-secondary.px-3') && target.textContent.includes('Làm mới')) {
      e.preventDefault();
      e.stopPropagation();

      if (confirm('Bạn có chắc muốn làm mới toàn bộ form?')) {
        window.CreateOrderData = {};
        location.reload();
      }
    }
  });

  // === HIỂN THỊ SUMMARY BAR ===
  document.addEventListener('DOMContentLoaded', () => {
    const summary = document.getElementById("detailedSummary");
    if (summary) {
      summary.style.display = "flex";
    }
  });

  // === GỌI LẠI KHI TRANG ĐƯỢC RENDER LẠI (nếu dùng SPA) ===
  // Nếu bạn dùng create-order.js để render form, hãy gọi hàm này ở cuối file đó:
  // window.dispatchEvent(new Event('orderFormReady'));
  window.addEventListener('orderFormReady', () => {
    const summary = document.getElementById("detailedSummary");
    if (summary) summary.style.display = "flex";
  });
</script>

