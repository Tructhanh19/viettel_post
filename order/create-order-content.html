<div class="create-order-content">
    <div class="order-form-container">
        <div class="row">
            <!-- Left Column: receiver, Receiver, Service -->
            <div class="col-md-6">
                <div id="sender-info"></div>
                <div id="receiver-info"></div>
                <div id="service-selection"></div>
            </div>
            
            <!-- Right Column: Package Info, COD -->
            <div class="col-md-6">
                <div id="package-info"></div>
                <div id="cod-info"></div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Pricing Summary Bar -->
<div class="pricing-summary-floating" id="pricingSummaryBar">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <!-- Left side - Summary info -->
      <div class="d-flex align-items-center gap-4">
        <!-- Detailed Summary (Hidden by default) -->
        <div class="detailed-summary-items d-flex gap-4" id="detailedSummary">
          <div class="summary-item">
            <div class="summary-label">
              <i class="fas fa-info-circle me-1"></i>
              Tổng cước
            </div>
            <div class="summary-value" id="totalFeeDisplay">0 đ</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Tiền thu hộ</div>
            <div class="summary-value">0 đ</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Tiền trả người gửi</div>
            <div class="summary-value">0 đ</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Thời gian dự kiến</div>
            <div class="summary-value">1 ngày</div>
          </div>
        </div>
      </div>
      
      <!-- Right side - Actions -->
      <div class="d-flex align-items-center gap-3">
        <div class="form-check d-flex align-items-center me-2">
          <input class="form-check-input me-2" type="checkbox" id="agreeTerms" checked>
          <label class="form-check-label small text-white" for="agreeTerms">
            Tôi đã đọc và đồng ý với <a href="#" class="text-primary">Điều khoản quy định</a>
          </label>
        </div>
        <button type="button" class="btn btn-outline-light px-4 me-2">Gửi ngay</button>
        <button type="button" class="btn btn-secondary px-3">Lưu nhập</button>
        <button type="button" class="btn btn-secondary px-3">Làm mới</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="../assets/order/css/create-order.css">

<!-- ① API CONFIG + DATA LAYER -->
<script src="../assets/api/config.js"></script>
<script src="../assets/api/user-data.js"></script>
<script src="../assets/api/receiver-data.js"></script>

<!-- ② FETCH DATA LAYER (dùng API để lấy dữ liệu, render UI) -->
<script src="../assets/fetchData/address.js"></script>
<script src="../assets/fetchData/branch.js"></script>
<script src="../assets/fetchData/receiver.js"></script>
<script src="../assets/fetchData/package.js"></script>
<script src="../assets/fetchData/product.js"></script>
<script src="../assets/fetchData/service.js"></script>
<script src="../assets/fetchData/tag.js"></script>
<script src="../assets/fetchData/scope.js"></script>
<script src="../assets/fetchData/user.js"></script>

<!-- ③ ORDER MODULES (logic trang đặt hàng, event DOM, validation, pricing...) -->
<script src="../assets/order/js/utils.js"></script>
<script src="../assets/order/js/validation.js"></script>
<script src="../assets/order/js/pricing.js"></script>
<script src="../assets/order/js/user.js"></script>
<script src="../assets/order/js/receiver.js"></script>
<script src="../assets/order/js/service.js"></script>
<script src="../assets/order/js/package.js"></script>
<script src="../assets/order/js/pickup.js"></script>
<script src="../assets/order/js/tags.js"></script>
<script src="../assets/order/js/cod.js"></script>

<!-- ④ MAIN CONTROLLER -->
<script src="../assets/api/order-data.js"></script>
<script src="../assets/order/js/create-order.js"></script>
<script>
  document.getElementById("detailedSummary").style.display = "flex";

  // Helper: Lấy dữ liệu đơn hàng từ window.CreateOrderData và chuyển đổi trường cho đúng backend
  function getOrderPayload(statusCode) {
    const data = window.CreateOrderData ? JSON.parse(JSON.stringify(window.CreateOrderData)) : {};

    // 1. Status: object { code, name }
    const statusMap = {
      'PENDING': { code: 'PENDING', name: 'Chờ xử lý' },
      'DRAFT': { code: 'DRAFT', name: 'Đơn nháp' },
      'IN_TRANSIT': { code: 'IN_TRANSIT', name: 'Đang vận chuyển' },
      // ...bổ sung nếu cần
    };
    data.status = statusMap[statusCode] || { code: statusCode, name: statusCode };

    // 2. receiver: phoneNumber, không có phone
    if (data.receiver) {
      if (data.receiver.phone) {
        data.receiver.phoneNumber = data.receiver.phone;
        delete data.receiver.phone;
      }
    }

    // 3. shippingService: estimateTimeHours, totalPrice
    if (data.shippingService) {
      // Đổi estimate_time_hours -> estimateTimeHours
      if (data.shippingService.estimate_time_hours) {
        data.shippingService.estimateTimeHours = data.shippingService.estimate_time_hours;
        delete data.shippingService.estimate_time_hours;
      }
      // Đảm bảo có totalPrice
      if (typeof data.shippingService.totalPrice === 'undefined' && typeof data.shippingService.price !== 'undefined') {
        data.shippingService.totalPrice = data.shippingService.price;
      }
    }

    // 7. Xóa các trường không cần thiết nếu có
    delete data.debug;

    return data;
  }

  // Đảm bảo OrderData đã load
  function waitForOrderData(cb) {
    if (window.OrderData && typeof window.OrderData.createOrder === 'function') {
      cb();
    } else {
      setTimeout(() => waitForOrderData(cb), 100);
    }
  }


  // Xử lý nút "Gửi ngay"
  document.querySelector('.btn.btn-outline-light.px-4.me-2').addEventListener('click', function() {
    waitForOrderData(async function() {
      const payload = getOrderPayload('PENDING'); // "Chờ xử lý"
      console.log('[DEBUG][ORDER PAYLOAD gửi ngay]', payload);
      try {
        const res = await window.OrderData.createOrder(payload);
        alert('Tạo đơn hàng thành công!');
        // Có thể redirect hoặc reset form ở đây nếu muốn
      } catch (err) {
        alert('Lỗi khi tạo đơn hàng: ' + (err?.message || err));
      }
    });
  });

  // Xử lý nút "Lưu nhập"
  document.querySelectorAll('.btn.btn-secondary.px-3')[0].addEventListener('click', function() {
    waitForOrderData(async function() {
      const payload = getOrderPayload('DRAFT'); // "Đơn nháp"
      console.log('[DEBUG][ORDER PAYLOAD lưu nháp]', payload);
      try {
        const res = await window.OrderData.createOrder(payload);
        alert('Đã lưu đơn nháp!');
      } catch (err) {
        alert('Lỗi khi lưu đơn nháp: ' + (err?.message || err));
      }
    });
  });

  // Xử lý nút "Làm mới"
  document.querySelectorAll('.btn.btn-secondary.px-3')[1].addEventListener('click', function() {
    if (confirm('Bạn có chắc muốn làm mới toàn bộ form?')) {
      // Xóa sạch dữ liệu CreateOrderData và reload lại trang
      window.CreateOrderData = {};
      location.reload();
    }
  });
</script>

