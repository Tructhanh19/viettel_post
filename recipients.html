<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách Khách hàng - Viettel Post</title>

  <link rel="stylesheet" href="assets/recipients.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root { --gap:12px; --radius:10px; --field-height:42px; --red:#d32f2f; }
    body { font-family: 'Roboto', sans-serif; background:#f6f7fb; margin:0; color:#222; }
    .container { max-width:1200px; margin:28px auto; padding:0 16px; }
    .content-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .title { font-size:20px; margin:0; font-weight:700; letter-spacing:0.6px; color:#0b2545; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; cursor:pointer; border:0; }
    .btn-primary { background:var(--red); color:#fff; box-shadow: 0 6px 18px rgba(211,47,47,0.12); }
    .card { background:#fff; border-radius:12px; box-shadow:0 4px 18px rgba(18,28,52,0.06); padding:18px; }
    .filters { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
    .custom-select, .search-input { height:var(--field-height); padding:8px 12px; border-radius:8px; border:1px solid #e3e6ee; background:#fff; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { text-align:left; padding:12px 10px; border-bottom:1px solid #f1f3f6; vertical-align:middle; }
    thead th { background:#fbfcff; font-weight:600; color:#1b2b4a; }
    .tag { background:#eef2ff; color:#2b4fff; padding:4px 8px; border-radius:12px; font-size:12px; margin-right:4px; display:inline-block; }
    .no-data { text-align:center; padding:18px; color:#888; }
    .pagination { display:flex; justify-content:space-between; align-items:center; margin-top:14px; gap:10px; }
    .page-info { display:flex; gap:12px; align-items:center; }
    .nav-arrows span { cursor:pointer; padding:6px; border-radius:6px; user-select:none; }
    .nav-arrows span:hover { background:#f1f3f6; }

    /* Modal */
    .modal-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(10,20,40,0.45); z-index:1200; padding:20px; }
    .modal-content { width:100%; max-width:920px; background:#fff; border-radius:12px; box-shadow:0 20px 60px rgba(2,10,45,0.2); overflow:hidden; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #f0f2f6; }
    .modal-header h2 { margin:0; font-size:18px; color:#102039; }
    .close-btn { background:transparent; border:0; font-size:22px; cursor:pointer; color:#888; }
    .modal-body { padding:18px 20px; }
    .modal-footer { padding:14px 20px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #f0f2f6; }
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .form-group { display:flex; flex-direction:column; gap:6px; }
    label { font-size:13px; color:#344; }
    input[type="text"], input[type="tel"], select { border:1px solid #e6e9f2; height:var(--field-height); padding:8px 10px; border-radius:8px; font-size:14px; }
    .form-helper { font-size:12px; color:#6b7280; }
    .btn-secondary { background:#eee; color:#222; border-radius:8px; padding:8px 12px; }
    .btn-danger { background:var(--red); color:#fff; border-radius:8px; padding:8px 14px; border:0; cursor:pointer; }
    .btn-sm { padding:6px 8px; font-size:13px; border-radius:8px; }
    .address-actions { display:flex; gap:8px; margin-top:8px; }
    .address-note { font-size:12px; color:#6b7280; margin-top:6px; }

    /* highlight success rate */
    .rate-high { background: rgba(198, 255, 213, 0.6); }

    /* Responsive */
    @media (max-width:900px) {
      .form-grid { grid-template-columns: 1fr; }
      .modal-content { max-width:700px; }
    }
    @media (max-width:480px) {
      .container { padding:12px; }
      .modal-content { max-width:100%; }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="main-content">
      <div class="content-header">
        <h1 class="title" id="pageTitle">DANH SÁCH NGƯỜI NHẬN</h1>
        <button class="btn btn-primary" id="addNewBtn"><span class="plus-icon">+</span> Thêm mới</button>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="filters">
            <div class="dropdown-container">
              <select class="custom-select" id="listTypeSelect">
                <option value="recipients">Danh sách người nhận</option>
                <option value="senders">Danh sách người gửi</option>
              </select>
            </div>
            <input type="text" class="search-input" id="customerSearchInput" placeholder="Nhập tên/số điện thoại">
            <button class="btn" id="customerSearchBtn"><i class="fas fa-search"></i></button>
          </div>

          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>STT</th>
                  <th id="nameColumnHeader">TÊN NGƯỜI NHẬN</th>
                  <th>THẺ TAG</th>
                  <th id="successRateColumnHeader">TỶ LỆ GIAO THÀNH CÔNG</th>
                  <th>ĐỊA CHỈ</th>
                  <th>THAO TÁC</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="6" class="no-data">Đang tải dữ liệu...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="pagination">
            <div class="records-per-page">
              <span>Bản Ghi Mỗi Trang</span>
               <div class="dropdown-container small">
                  <select class="custom-select" id="itemsPerPageSelect">
                      <option value="10">10</option>
                      <option value="20">20</option>
                      <option value="50">50</option>
                  </select>
               </div>
            </div>
            <div class="page-info">
              <span id="paginationInfo">0 of 0</span>
              <div class="nav-arrows">
                <span id="firstPageBtn">&lt;&lt;</span>
                <span id="prevPageBtn">&lt;</span>
                <span id="nextPageBtn">&gt;</span>
                <span id="lastPageBtn">&gt;&gt;</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Single Modal used for both Add & Edit -->
  <div id="addCustomerModal" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle">Thêm mới thông tin khách hàng</h2>
        <button class="close-btn" id="closeModalBtn" aria-label="Đóng">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCustomerId" value="">
        <form id="customerForm" novalidate>
          <div class="form-grid">
            <div>
              <div class="form-group">
                <label for="fullName" class="required">Họ tên</label>
                <input type="text" id="fullName" name="fullName" required placeholder="Nguyễn Văn A">
              </div>
              <div class="form-group">
                <label for="phoneNumber" class="required">Số điện thoại</label>
                <input type="tel" id="phoneNumber" name="phoneNumber" required pattern="^(0[3|5|7|8|9])[0-9]{8}$" placeholder="09xxxxxxxx">
              </div>
              <div class="form-group">
                <label for="addressDetail" class="required">Số nhà / Tên đường</label>
                <input type="text" id="addressDetail" name="addressDetail" required placeholder="Số nhà, tên đường">
                <small class="form-helper">Chỉ nhập số nhà, tên đường. Chọn Tỉnh/Quận/Xã bên phải (hoặc Thay đổi/Reset).</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="provinceSelect" class="required">Tỉnh/Thành phố</label>
                <select id="provinceSelect" required disabled><option value="">-- Chọn Tỉnh/TP --</option></select>
              </div>
              <div class="form-group">
                <label for="districtSelect" class="required">Quận/Huyện</label>
                <select id="districtSelect" required disabled><option value="">-- Chọn Quận/Huyện --</option></select>
              </div>
              <div class="form-group">
                <label for="wardSelect" class="required">Phường/Xã</label>
                <select id="wardSelect" required disabled><option value="">-- Chọn Phường/Xã --</option></select>
              </div>

              <div class="address-actions">
                <button type="button" class="btn btn-sm" id="btnEnableChange">Thay đổi địa chỉ</button>
                <button type="button" class="btn btn-sm" id="btnResetAddress">Reset địa chỉ</button>
              </div>
              <div class="address-note" id="addressNote" aria-live="polite"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelBtn">Thoát</button>
        <button type="submit" form="customerForm" class="btn btn-danger" id="submitCustomerBtn">Thêm mới</button>
      </div>
    </div>
  </div>

  <!-- Config + AddressData must be loaded before this script -->
  <script src="assets/api/config.js"></script>
  <script src="assets/fetchData/address.js"></script>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    if (!window.API_CONFIG) console.error("API_CONFIG missing - ensure assets/api/config.js is loaded and sets window.API_CONFIG");
    if (!window.AddressData) console.error("AddressData missing - ensure assets/fetchData/address.js is loaded");

    const API_BASE = window.API_CONFIG?.BASE_URL || "";
    const getAccessToken = window.API_CONFIG?.getAccessToken || (()=>null);

    // UI refs
    const tbody = $(".main-content tbody");
    const listTypeSelect = $("#listTypeSelect");
    const pageTitle = $("#pageTitle");
    const nameColumnHeader = $("#nameColumnHeader");
    const successRateHeader = $("#successRateColumnHeader");
    const searchInput = $("#customerSearchInput");
    const searchBtn = $("#customerSearchBtn");
    const itemsPerPageSelect = $("#itemsPerPageSelect");
    const paginationInfo = $("#paginationInfo");
    const firstPageBtn = $("#firstPageBtn");
    const prevPageBtn = $("#prevPageBtn");
    const nextPageBtn = $("#nextPageBtn");
    const lastPageBtn = $("#lastPageBtn");

    const addNewBtn = $("#addNewBtn");
    const modal = $("#addCustomerModal");
    const closeModalBtn = $("#closeModalBtn");
    const cancelBtn = $("#cancelBtn");
    const customerForm = $("#customerForm");
    const editCustomerIdInput = $("#editCustomerId");
    const fullNameInput = $("#fullName");
    const phoneInput = $("#phoneNumber");
    const addressDetailInput = $("#addressDetail");
    const provinceSelect = $("#provinceSelect");
    const districtSelect = $("#districtSelect");
    const wardSelect = $("#wardSelect");
    const submitCustomerBtn = $("#submitCustomerBtn");
    const btnEnableChange = $("#btnEnableChange");
    const btnResetAddress = $("#btnResetAddress");
    const addressNote = $("#addressNote");

    // state
    let currentListType = 'recipients';
    let allRecipients = [];
    let allSenders = [];
    let allOrders = [];
    let filteredData = null;
    let currentPage = 1;
    let itemsPerPage = Number(itemsPerPageSelect?.value || 10);
  // hold tags for the currently edited/created recipient so we don't lose them on update
  let currentEditingTags = [];

    // helpers
    function buildHeaders(){ const t = getAccessToken ? getAccessToken() : null; const h = {'Content-Type':'application/json'}; if(t) h['Authorization'] = t.startsWith('Bearer ') ? t : `Bearer ${t}`; return h; }
    async function fetchJson(url, opts = {}) { const res = await fetch(url, opts); if(!res.ok){ const txt = await res.text().catch(()=>res.statusText); throw new Error(`HTTP ${res.status}: ${txt}`); } return await res.json(); }

    // Populate provinces/districts/wards using AddressData
    async function initAddressSelects() {
      try { await AddressData.init(); } catch(e){ console.warn('AddressData.init failed', e); }

      const provinces = (typeof AddressData.getProvinces63 === 'function') ? AddressData.getProvinces63() : [];
      provinceSelect.innerHTML = '<option value="">-- Chọn Tỉnh/TP --</option>';
      provinces.forEach(p => {
        const o = document.createElement('option'); o.value = p.code; o.textContent = p.name; provinceSelect.appendChild(o);
      });

      provinceSelect.addEventListener('change', () => {
        const code = provinceSelect.value;
        districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>'; wardSelect.disabled = true;
        if (!code) { districtSelect.disabled = true; return; }
        const districts = AddressData.getDistricts63 ? AddressData.getDistricts63(code) : [];
        districts.forEach(d => {
          const o = document.createElement('option'); o.value = d.code; o.textContent = d.name; districtSelect.appendChild(o);
        });
        districtSelect.disabled = false;
      });

      districtSelect.addEventListener('change', () => {
        const prov = provinceSelect.value;
        const dist = districtSelect.value;
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
        if (!dist) { wardSelect.disabled = true; return; }
        const wards = AddressData.getWards63 ? AddressData.getWards63(prov, dist) : [];
        wards.forEach(w => {
          const o = document.createElement('option'); o.value = w.code; o.textContent = w.name; wardSelect.appendChild(o);
        });
        wardSelect.disabled = false;
      });
    }

    // Orders -> success map
    function computeSuccessMap(){
      const map = {};
      allOrders.forEach(o => {
        const rid = o.receiver?.receiver_id?.$oid || o.receiver?.receiver_id || o.receiver_id;
        if(!rid) return;
        if(!map[rid]) map[rid] = { total:0, delivered:0 };
        map[rid].total++;
        const code = (o.status?.code || '').toString().toUpperCase();
        if(code === 'DELIVERED') map[rid].delivered++;
      });
      return map;
    }

    // render table
    function renderTable(){
      if(!tbody) return;
      nameColumnHeader.textContent = currentListType === 'senders' ? 'TÊN NGƯỜI GỬI' : 'TÊN NGƯỜI NHẬN';
      successRateHeader.style.display = currentListType === 'senders' ? 'none' : '';

      const source = filteredData || (currentListType === 'senders' ? allSenders : allRecipients) || [];
      if(!source.length){ tbody.innerHTML = `<tr><td colspan="6" class="no-data">Không có bản ghi nào</td></tr>`; updatePagination(1,1,0); return; }

      const total = source.length;
      const pages = Math.max(1, Math.ceil(total/itemsPerPage));
      if(currentPage > pages) currentPage = pages;
      const start = (currentPage - 1) * itemsPerPage;
      const pageItems = source.slice(start, start + itemsPerPage);
      const successMap = computeSuccessMap();

      tbody.innerHTML = '';
      pageItems.forEach((it, idx) => {
        const idxNo = start + idx + 1;
        const addr = it.address || {};
        const detail = addr.detail || addr.other || '';
        // support address fields stored as object or string
        const wardName = (typeof addr.ward === 'object' && addr.ward?.name) ? addr.ward.name : (addr.ward || '');
        const districtName = (typeof addr.district === 'object' && addr.district?.name) ? addr.district.name : (addr.district || '');
        const provinceName = (typeof addr.province === 'object' && addr.province?.name) ? addr.province.name : (addr.province || '');
        const addressStr = [detail, wardName, districtName, provinceName].filter(Boolean).join(', ') || '—';
        const tagsHtml = (it.tags || []).map(t => `<span class="tag">${t.name || t}</span>`).join(' ') || '—';
        let successText = 'N/A';
        let trClass = '';
        if(currentListType !== 'senders'){
          const stat = successMap[it.id] || { total:0, delivered:0 };
          const val = stat.total > 0 ? ((stat.delivered/stat.total)*100) : 0;
          successText = stat.total > 0 ? `${val.toFixed(1)}%` : '0.0%';
          if (val >= 90) trClass = 'rate-high';
        }
        const tr = document.createElement('tr');
        if(trClass) tr.classList.add(trClass);
        tr.innerHTML = `
          <td>${idxNo}</td>
          <td>${escapeHtml(it.name)}</td>
          <td>${tagsHtml}</td>
          <td style="display:${currentListType==='senders'?'none':''};">${successText}</td>
          <td>${escapeHtml(addressStr)}</td>
          <td>
            <button class="btn btn-edit btn-sm" data-id="${it.id}"><i class="fas fa-edit"></i> Sửa</button>
            <button class="btn btn-danger btn-sm btn-delete" data-id="${it.id}"><i class="fas fa-trash-alt"></i> Xoá</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      bindTableActions();
      updatePagination(currentPage, pages, total);
    }

    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function updatePagination(page, pages, total){
      if(paginationInfo) paginationInfo.textContent = `${page} of ${pages} (${total} bản ghi)`;
      if(firstPageBtn) firstPageBtn.style.opacity = page<=1?0.4:1;
      if(prevPageBtn) prevPageBtn.style.opacity = page<=1?0.4:1;
      if(nextPageBtn) nextPageBtn.style.opacity = page>=pages?0.4:1;
      if(lastPageBtn) lastPageBtn.style.opacity = page>=pages?0.4:1;
    }

    function bindTableActions(){
      $$('tbody .btn-delete').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          if(!id) return;
          if(!confirm(`Bạn chắc chắn muốn xoá bản ghi (ID: ${id})?`)) return;
          try { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; await deleteRecipient(id); await reloadData(); }
          catch(err){ alert('Xoá thất bại: ' + (err.message || err)); await reloadData(); }
        };
      });

      $$('tbody .btn-edit').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const arr = currentListType === 'senders' ? allSenders : allRecipients;
          const item = arr.find(x => String(x.id) === String(id));
          if(!item) { alert('Không tìm thấy dữ liệu'); return; }
          openModalForEdit(item);
        };
      });
    }

    // CRUD API
    async function createRecipientAPI(payload){ if(!API_BASE) throw new Error('API base not configured'); return await fetchJson(`${API_BASE}/receivers/insert`, { method:'POST', headers: buildHeaders(), body: JSON.stringify(payload) }); }
    async function updateRecipientAPI(id,payload){ if(!API_BASE) throw new Error('API base not configured'); return await fetchJson(`${API_BASE}/receivers/update/${id}`, { method:'PUT', headers: buildHeaders(), body: JSON.stringify(payload) }); }
    async function deleteRecipientAPI(id){ if(!API_BASE) throw new Error('API base not configured'); return await fetchJson(`${API_BASE}/receivers/delete/${id}`, { method:'DELETE', headers: buildHeaders() }); }

    async function createRecipient(payload){ return await createRecipientAPI(payload); }
    async function updateRecipient(id,payload){ return await updateRecipientAPI(id,payload); }
    async function deleteRecipient(id){ return await deleteRecipientAPI(id); }

    // Modal behaviors: two buttons for address behavior:
    // - "Thay đổi địa chỉ" -> enable selects (keep detail)
    // - "Reset địa chỉ" -> clear detail and selects
    function enableAddressEditing(keepDetail = true) {
      provinceSelect.disabled = false;
      // if province empty keep current selections if they exist; otherwise leave as is
      addressNote.textContent = 'Bạn đang thay đổi địa chỉ — chỉnh Tỉnh/Quận/Xã nếu cần.';
    }
    function resetAddressAll() {
      addressDetailInput.value = '';
      provinceSelect.value = ''; districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>'; districtSelect.disabled = true;
      wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>'; wardSelect.disabled = true;
      addressNote.textContent = 'Đã reset địa chỉ — vui lòng chọn lại Tỉnh/Quận/Xã và nhập số nhà.';
    }

    // open add modal
    function openModalForAdd(){
      editCustomerIdInput.value = '';
      $('#modalTitle').textContent = 'Thêm mới thông tin khách hàng';
      submitCustomerBtn.textContent = 'Thêm mới';
      customerForm.reset();
      // reset tags for new item
      currentEditingTags = [];
      // disable selects initially, user must click change to enable; but for add we enable selects
      provinceSelect.disabled = false;
      districtSelect.disabled = true;
      wardSelect.disabled = true;
      addressNote.textContent = '';
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
      fullNameInput.focus();
    }

    // open edit modal with advanced mapping and fallback
    function openModalForEdit(item){
      // preserve tags of the item being edited so they are sent on update
      currentEditingTags = item.tags || [];
      editCustomerIdInput.value = item.id;
      $('#modalTitle').textContent = 'Cập nhật thông tin khách hàng';
      submitCustomerBtn.textContent = 'Cập nhật';
      customerForm.reset();

      // fill simple fields
      fullNameInput.value = item.name || '';
      phoneInput.value = item.phone || '';
      addressDetailInput.value = item.address?.detail || item.address?.other || '';

      // Attempt to map address names -> codes using AddressData
      const provinces = AddressData.getProvinces63 ? AddressData.getProvinces63() : [];
      const provName = (item.address?.province || '').trim();
      const distName = (item.address?.district || '').trim();
      const wardName = (item.address?.ward || '').trim();

      // Reset selects UI
      provinceSelect.innerHTML = '<option value="">-- Chọn Tỉnh/TP --</option>';
      provinces.forEach(p => { const o=document.createElement('option'); o.value = p.code; o.textContent = p.name; provinceSelect.appendChild(o); });

      // Try find province by exact name then by contains
      let prov = provinces.find(p => (p.name||'').trim() === provName);
      if(!prov && provName) prov = provinces.find(p => (p.name||'').toLowerCase().includes(provName.toLowerCase()));
      if(prov){
        provinceSelect.value = prov.code;
        const districts = AddressData.getDistricts63 ? AddressData.getDistricts63(prov.code) : [];
        districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
        districts.forEach(d => { const o=document.createElement('option'); o.value = d.code; o.textContent = d.name; districtSelect.appendChild(o); });
        // find district
        let dist = districts.find(d => (d.name||'').trim() === distName);
        if(!dist && distName) dist = districts.find(d => (d.name||'').toLowerCase().includes(distName.toLowerCase()));
        if(dist){
          districtSelect.value = dist.code;
          const wards = AddressData.getWards63 ? AddressData.getWards63(prov.code, dist.code) : [];
          wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
          wards.forEach(w => { const o=document.createElement('option'); o.value = w.code; o.textContent = w.name; wardSelect.appendChild(o); });
          let wd = wards.find(w => (w.name||'').trim() === wardName);
          if(!wd && wardName) wd = wards.find(w => (w.name||'').toLowerCase().includes(wardName.toLowerCase()));
          if(wd) wardSelect.value = wd.code;
        } else {
          // district not found - add fallback option showing old district name
          if(distName) {
            districtSelect.innerHTML = `<option value="__OLD_DIST__" selected>Đang lưu: ${escapeHtml(distName)}</option>` + districtSelect.innerHTML;
            districtSelect.disabled = true; // keep disabled until user clicks change
          } else {
            districtSelect.disabled = true;
          }
          wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>'; wardSelect.disabled = true;
        }
      } else {
        // province not found: show fallback option with old province name and keep selects disabled
        if(provName){
          // rebuild province select with fallback top option
          provinceSelect.innerHTML = `<option value="__OLD_PROV__" selected>Đang lưu: ${escapeHtml(provName)}</option>` + provinceSelect.innerHTML;
          provinceSelect.disabled = true;
        } else {
          provinceSelect.disabled = true;
        }
        districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>'; districtSelect.disabled = true;
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>'; wardSelect.disabled = true;
      }

      // By default after opening edit, address selects should be disabled (user must click Thay đổi địa chỉ)
      // Show a note to user and set addressNote
      addressNote.textContent = 'Địa chỉ đang hiển thị theo dữ liệu đã lưu. Nhấn "Thay đổi địa chỉ" để chỉnh sửa (giữ hoặc reset số nhà).';

      // Bind buttons behavior:
      // Thay đổi địa chỉ -> enable selects but keep addressDetail value
      btnEnableChange.onclick = () => {
        // If province currently holds __OLD_PROV__ remove it and keep provinceSelect enabled
        if(provinceSelect.value === '__OLD_PROV__'){ provinceSelect.value = ''; }
        if(districtSelect.value === '__OLD_DIST__'){ districtSelect.value = ''; districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>'; districtSelect.disabled = true; }
        provinceSelect.disabled = false;
        // run change event to populate next
        const ev = new Event('change');
        provinceSelect.dispatchEvent(ev);
        addressNote.textContent = 'Bạn đang thay đổi địa chỉ — các dropdown đã bật. Số nhà được giữ nguyên.';
      };

      // Reset địa chỉ -> clears detail & selects
      btnResetAddress.onclick = () => {
        resetAddressAll();
      };

      // Show modal
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
      fullNameInput.focus();
    }

    function hideModal(){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); customerForm.reset(); editCustomerIdInput.value = ''; addressNote.textContent = ''; }

    // form submit
    async function handleFormSubmit(e){
      e.preventDefault();
      const isEdit = !!editCustomerIdInput.value;
      const id = editCustomerIdInput.value;
      const name = fullNameInput.value.trim();
      const phone = phoneInput.value.trim();
      const detail = addressDetailInput.value.trim();

      if(!name || !phone || !detail){ alert('Vui lòng nhập đầy đủ Họ tên, SĐT và Số nhà / Đường'); return; }
      const phoneRe = /^(0[3|5|7|8|9])[0-9]{8}$/;
      if(!phoneRe.test(phone)){ alert('Số điện thoại không hợp lệ'); return; }

      // Determine address texts to send:
      // If provinceSelect disabled and contains __OLD_PROV__/__OLD_DIST__ fallback, read displayed text
      let provinceText = '', districtText = '', wardText = '';
      if (provinceSelect.disabled && provinceSelect.value && provinceSelect.value.startsWith('__OLD_PROV__')) {
        provinceText = provinceSelect.options[provinceSelect.selectedIndex]?.text?.replace(/^Đang lưu:\s*/, '') || '';
      } else {
        provinceText = provinceSelect.options[provinceSelect.selectedIndex]?.text || '';
      }
      if (districtSelect.disabled && districtSelect.value && districtSelect.value.startsWith('__OLD_DIST__')) {
        districtText = districtSelect.options[districtSelect.selectedIndex]?.text?.replace(/^Đang lưu:\s*/, '') || '';
      } else {
        districtText = districtSelect.options[districtSelect.selectedIndex]?.text || '';
      }
      if (wardSelect.disabled && wardSelect.value && wardSelect.value.startsWith('__OLD_WARD__')) {
        wardText = wardSelect.options[wardSelect.selectedIndex]?.text?.replace(/^Đang lưu:\s*/, '') || '';
      } else {
        wardText = wardSelect.options[wardSelect.selectedIndex]?.text || '';
      }

      const payload = {
        name,
        phone,
        address: {
          detail,
          province: provinceText,
          district: districtText,
          ward: wardText
        },
        tags: Array.isArray(currentEditingTags) ? currentEditingTags : (currentEditingTags ? [currentEditingTags] : [])
      };

      submitCustomerBtn.disabled = true;
      submitCustomerBtn.textContent = isEdit ? 'Đang cập nhật...' : 'Đang thêm...';
      try {
        if (isEdit) {
          await updateRecipient(id, payload);
          alert('Cập nhật thành công');
        } else {
          await createRecipient(payload);
          alert('Thêm mới thành công');
        }
        hideModal();
        await reloadData();
      } catch (err) {
        console.error('Lỗi lưu:', err);
        alert('Lỗi khi lưu dữ liệu: ' + (err.message || err));
      } finally {
        submitCustomerBtn.disabled = false;
        submitCustomerBtn.textContent = isEdit ? 'Cập nhật' : 'Thêm mới';
      }
    }

    // search & pagination helpers
    function doSearch(){
      const q = (searchInput.value || '').trim().toLowerCase();
      filteredData = null;
      if(!q){ filteredData = null; currentPage = 1; renderTable(); return; }
      const src = currentListType === 'senders' ? allSenders : allRecipients;
      filteredData = (src || []).filter(it => {
        const n = (it.name || '').toLowerCase();
        const p = (it.phone || '').toLowerCase();
        return n.includes(q) || p.includes(q);
      });
      currentPage = 1; renderTable();
    }

    // load orders & lists
    async function loadOrders(){ allOrders = []; if(!API_BASE) return; try{ const url = `${API_BASE}/orders/get-all`; const json = await fetchJson(url, { headers: buildHeaders() }); const raw = json.result || json.data || (Array.isArray(json) ? json : []); allOrders = Array.isArray(raw) ? raw : []; } catch(err){ console.warn('Không load orders:', err.message); allOrders = []; } }
    async function loadLists(){ allRecipients = []; allSenders = []; if(!API_BASE) return; try{ const recUrl = `${API_BASE}/receivers/get-all`; const json = await fetchJson(recUrl, { headers: buildHeaders() }); const raw = json.result || json.data || json.receivers || (Array.isArray(json) ? json : []); const arr = Array.isArray(raw) ? raw : []; allRecipients = arr.map(r => ({ id: r._id?.$oid || r._id || r.id, name: r.name || 'N/A', phone: r.phone || r.phone_number || r.phoneNumber || 'N/A', address: r.address || {}, tags: r.tags || [] })); } catch(err){ console.error('Lỗi load receivers:', err.message); allRecipients = []; } try{ const uUrl = `${API_BASE}/users/get-all`; const jsonU = await fetchJson(uUrl, { headers: buildHeaders() }); const rawU = jsonU.result || jsonU.data || (Array.isArray(jsonU) ? jsonU : []); const arrU = Array.isArray(rawU) ? rawU : []; allSenders = arrU.map(u => ({ id: u._id?.$oid || u._id || u.id, name: u.name || u.username || 'N/A', phone: u.phone_number || u.phone || u.phoneNumber || 'N/A', address: u.address || {}, tags: u.tags || [] })); } catch(err){ console.warn('Lỗi load users:', err.message); allSenders = []; } }

    async function reloadData(){ await loadOrders(); await loadLists(); filteredData = null; currentPage = 1; renderTable(); }

    // UI binding
    function bindUI(){
      if(addNewBtn) addNewBtn.addEventListener('click', openModalForAdd);
      if(closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
      if(cancelBtn) cancelBtn.addEventListener('click', hideModal);
      if(modal) modal.addEventListener('click', e => { if(e.target === modal) hideModal(); });
      if(customerForm) customerForm.addEventListener('submit', handleFormSubmit);
      if(searchBtn) searchBtn.addEventListener('click', doSearch);
      if(searchInput) searchInput.addEventListener('keypress', e => { if(e.key === 'Enter') doSearch(); });
      if(listTypeSelect) listTypeSelect.addEventListener('change', () => {
        currentListType = listTypeSelect.value || 'recipients';
        pageTitle.textContent = currentListType === 'senders' ? 'DANH SÁCH NGƯỜI GỬI' : 'DANH SÁCH NGƯỜI NHẬN';
        nameColumnHeader.textContent = currentListType === 'senders' ? 'TÊN NGƯỜI GỬI' : 'TÊN NGƯỜI NHẬN';
        successRateHeader.style.display = currentListType === 'senders' ? 'none' : '';
        filteredData = null; currentPage = 1; renderTable();
      });

      if(itemsPerPageSelect) itemsPerPageSelect.addEventListener('change', ()=> { itemsPerPage = Number(itemsPerPageSelect.value) || 10; currentPage=1; renderTable(); });
      if(firstPageBtn) firstPageBtn.addEventListener('click', ()=>{ currentPage=1; renderTable(); });
      if(prevPageBtn) prevPageBtn.addEventListener('click', ()=>{ currentPage=Math.max(1,currentPage-1); renderTable(); });
      if(nextPageBtn) nextPageBtn.addEventListener('click', ()=> { const total = (filteredData || (currentListType==='senders'?allSenders:allRecipients)).length; const pages = Math.max(1, Math.ceil(total/itemsPerPage)); currentPage = Math.min(pages,currentPage+1); renderTable(); });
      if(lastPageBtn) lastPageBtn.addEventListener('click', ()=> { const total = (filteredData || (currentListType==='senders'?allSenders:allRecipients)).length; const pages = Math.max(1, Math.ceil(total/itemsPerPage)); currentPage = pages; renderTable(); });
    }

    async function init(){
      bindUI();
      try{
        await initAddressSelects();
        await loadOrders();
        await loadLists();
        renderTable();
      }catch(err){
        console.error('Init lỗi:', err);
        renderTable();
      }
    }

    // Expose reload for debugging
    window.RecipientPage = { reload: reloadData };

    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

  })();
  </script>
</body>
</html>