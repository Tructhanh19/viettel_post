<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch Kh√°ch h√†ng - Viettel Post</title>
    <link rel="stylesheet" href="assets/recipients.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
</head>
<body>

    <div class="container">
        <div class="main-content">
            <div class="content-header">
                <h1 class="title" id="pageTitle">DANH S√ÅCH NG∆Ø·ªúI NH·∫¨N</h1>
                <button class="btn btn-primary" id="addNewBtn">
                    <span class="plus-icon">+</span> Th√™m m·ªõi
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="filters">
                        <div class="dropdown-container">
                            <select class="custom-select" id="listTypeSelect">
                                <option value="recipients">Danh s√°ch ng∆∞·ªùi nh·∫≠n</option>
                                <option value="senders">Danh s√°ch ng∆∞·ªùi g·ª≠i</option>
                            </select>
                        </div>
                        <input type="text" class="search-input" id="customerSearchInput" placeholder="Nh·∫≠p t√™n/s·ªë ƒëi·ªán tho·∫°i">
                        <button class="btn btn-search" id="customerSearchBtn">T√¨m ki·∫øm</button>
                    </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th id="nameColumnHeader">T√äN NG∆Ø·ªúI NH·∫¨N</th>
                                    <th>TH·∫∫ TAG</th>
                                    <th id="successRateColumnHeader">T·ª∂ L·ªÜ GIAO TH√ÄNH C√îNG</th>
                                    <th>ƒê·ªäA CH·ªà</th>
                                    <th>THAO T√ÅC</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="no-data">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination">
                        <div class="records-per-page">
                            <span>B·∫£n Ghi M·ªói Trang</span>
                             <div class="dropdown-container small">
                                <select class="custom-select" id="itemsPerPageSelect">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                        </div>
                        <div class="page-info">
                            <span id="paginationInfo">0 of 0</span>
                            <div class="nav-arrows">
                                <span id="firstPageBtn">&lt;&lt;</span>
                                <span id="prevPageBtn">&lt;</span>
                                <span id="nextPageBtn">&gt;</span>
                                <span id="lastPageBtn">&gt;&gt;</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addCustomerModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Th√™m m·ªõi th√¥ng tin kh√°ch h√†ng</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCustomerId" value="">
                <form id="customerForm">
                    <div class="form-group">
                        <label for="fullName" class="required">H·ªç t√™n</label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber" class="required">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required pattern="^(0[3|5|7|8|9])[0-9]{8}$" title="Nh·∫≠p SƒêT Vi·ªát Nam g·ªìm 10 ch·ªØ s·ªë (vd: 0912345678)">
                    </div>
                    <div class="form-group">
                        <label for="addressDetail" class="required">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                        <input type="text" id="addressDetail" name="addressDetail" placeholder="Nh·∫≠p s·ªë nh√†, t√™n ƒë∆∞·ªùng..." required>
                        <small class="form-helper">Ch·ªâ nh·∫≠p s·ªë nh√†/t√™n ƒë∆∞·ªùng. T·ªânh/Huy·ªán/X√£ s·∫Ω ch·ªçn b√™n d∆∞·ªõi.</small>
                    </div>
                     <div class="form-group">
                         <label for="provinceSelect" class="required">T·ªânh/Th√†nh ph·ªë</label>
                         <select id="provinceSelect" required><option value="">-- Ch·ªçn T·ªânh/TP --</option></select>
                     </div>
                      <div class="form-group">
                         <label for="districtSelect" class="required">Qu·∫≠n/Huy·ªán</label>
                         <select id="districtSelect" required disabled><option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option></select>
                     </div>
                      <div class="form-group">
                         <label for="wardSelect" class="required">Ph∆∞·ªùng/X√£</label>
                         <select id="wardSelect" required disabled><option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option></select>
                     </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBtn">Tho√°t</button>
                <button type="submit" form="customerForm" class="btn btn-danger" id="submitCustomerBtn">Th√™m m·ªõi</button>
            </div>
        </div>
    </div>

    <script src="assets/api/config.js"></script>
    <script>
        // --- H√†m showModal ƒë∆∞·ª£c ƒë∆∞a ra ngo√†i ƒë·ªÉ logic S·ª≠a g·ªçi ƒë∆∞·ª£c ---
        function showCustomerModal(isEdit = false, customerData = null) {
            const modal = document.getElementById('addCustomerModal');
            const modalTitle = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitCustomerBtn');
            const editCustomerIdInput = document.getElementById('editCustomerId');
            const customerForm = document.getElementById('customerForm');
            const listTypeSelect = document.getElementById('listTypeSelect');

             // Form fields
            const fullNameInput = document.getElementById("fullName");
            const phoneInput = document.getElementById("phoneNumber");
            const addressDetailInput = document.getElementById("addressDetail");
            const provinceSelect = document.getElementById('provinceSelect');
            const districtSelect = document.getElementById('districtSelect');
            const wardSelect = document.getElementById('wardSelect');

            if (!modal || !modalTitle || !submitBtn || !editCustomerIdInput || !customerForm) {
                console.error("showCustomerModal: Missing modal elements!");
                return;
            }

            editCustomerIdInput.value = isEdit && customerData ? customerData.id : '';
            const currentListType = listTypeSelect ? listTypeSelect.value : 'recipients';
            const actionText = isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi';
            const personTypeText = currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n';
            modalTitle.textContent = `${actionText} th√¥ng tin ${personTypeText}`;
            submitBtn.textContent = actionText;

            customerForm.reset();
            if(districtSelect) { districtSelect.innerHTML = '<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>'; districtSelect.disabled = true; }
            if(wardSelect) { wardSelect.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>'; wardSelect.disabled = true; }

            if (isEdit && customerData) {
                console.log("üìù Populating modal for edit:", customerData);
                if(fullNameInput) fullNameInput.value = customerData.name || '';
                if(phoneInput) phoneInput.value = customerData.phone || '';
                if(addressDetailInput) addressDetailInput.value = customerData.address?.detail || customerData.address?.other || '';

                // --- TODO: Logic ƒëi·ªÅn dropdown ƒë·ªãa ch·ªâ khi s·ª≠a ---
                 console.log("TODO: Pre-select address dropdowns for editing");
                 // V√≠ d·ª• c∆° b·∫£n (c·∫ßn h√†m findProvinceCodeByName, loadDistricts,... nh∆∞ tr∆∞·ªõc):
                 /*
                 if (provinceSelect && customerData.address?.province) {
                     const provinceCode = findProvinceCodeByName(customerData.address.province);
                     if (provinceCode) {
                         provinceSelect.value = provinceCode;
                         loadDistricts(provinceCode).then(() => { // Gi·∫£ ƒë·ªãnh loadDistricts tr·∫£ v·ªÅ Promise
                             const districtCode = findDistrictCodeByName(provinceCode, customerData.address.district);
                             if (districtCode) {
                                 districtSelect.value = districtCode;
                                 loadWards(districtCode).then(() => { // Gi·∫£ ƒë·ªãnh loadWards tr·∫£ v·ªÅ Promise
                                     const wardCode = findWardCodeByName(districtCode, customerData.address.ward);
                                     if (wardCode) wardSelect.value = wardCode;
                                 });
                             }
                         });
                     }
                 }
                 */
                // --- K·∫øt th√∫c TODO ---

            } else {
                 console.log("‚ú® Resetting modal for add new.");
                 editCustomerIdInput.value = '';
                 // TODO: Load provinces if not already loaded and needed
                 // if (provinceSelect && provinceSelect.options.length <= 1) loadProvinces();
            }
            modal.classList.remove('hidden');
        }


        // --- B·ªåC PH·∫¶N C√íN L·∫†I V√Ä LOGIC DATA V√ÄO H√ÄM INIT ---
        function initCustomerListPage() {
            console.log("üöÄ Initializing Customer List Page UI & Data Logic...");

             // --- Ki·ªÉm tra API_CONFIG ---
             if (!window.API_CONFIG) {
                 console.error("‚ùå API_CONFIG ch∆∞a load! Ensure config.js is loaded before this script.");
                 showGenericError("L·ªói c·∫•u h√¨nh h·ªá th·ªëng.");
                 return; // D·ª´ng kh·ªüi t·∫°o n·∫øu thi·∫øu config
             }
             const API_BASE_URL = window.API_CONFIG.BASE_URL;
             const getAccessToken = window.API_CONFIG.getAccessToken;
             // --- K·∫øt th√∫c ki·ªÉm tra ---


            // --- Get Elements ---
            const addNewBtn = document.getElementById('addNewBtn');
            const modal = document.getElementById('addCustomerModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const customerForm = document.getElementById('customerForm');
            const pageTitle = document.getElementById('pageTitle');
            const nameColumnHeader = document.getElementById('nameColumnHeader');
            const successRateHeader = document.getElementById('successRateColumnHeader');
            const listTypeSelect = document.getElementById('listTypeSelect');
            const searchInput = document.getElementById('customerSearchInput');
            const searchBtn = document.getElementById('customerSearchBtn');
            const editCustomerIdInput = document.getElementById('editCustomerId'); // Input ·∫©n ID
            const tbody = document.querySelector(".main-content tbody"); // L·∫•y tbody ·ªü ƒë√¢y

            // Address selectors
            const provinceSelect = document.getElementById('provinceSelect');
            const districtSelect = document.getElementById('districtSelect');
            const wardSelect = document.getElementById('wardSelect');

            let currentData = []; // Store either recipients or senders locally
            let currentListType = 'recipients'; // Default


             // --- Helper: Get Valid Token ---
            function getValidTokenWithBearer() {
                let token = getAccessToken ? getAccessToken() : null;
                if (!token) {
                     console.warn("‚ö†Ô∏è Token kh√¥ng t·ªìn t·∫°i.");
                     // C√≥ th·ªÉ hi·ªÉn th·ªã th√¥ng b√°o l·ªói ho·∫∑c chuy·ªÉn h∆∞·ªõng ƒëƒÉng nh·∫≠p ·ªü ƒë√¢y
                     showAuthWarning(); // Hi·ªÉn th·ªã c·∫£nh b√°o x√°c th·ª±c
                     return null;
                }
                // Lu√¥n ƒë·∫£m b·∫£o c√≥ "Bearer "
                return token.startsWith("Bearer ") ? token : `Bearer ${token}`;
            }

            // --- Helper: Show Error UI ---
            function showGenericError(message, areaSelector = ".table-responsive") {
                const area = document.querySelector(areaSelector);
                if (!area) return;
                const oldError = area.querySelector('.customer-data-error');
                if(oldError) oldError.remove();
                const div = document.createElement("div");
                div.className = "customer-data-error";
                div.style.cssText = "background:#f8d7da; color:#721c24; padding:10px 15px; margin:15px; text-align:center; border:1px solid #f5c6cb; border-radius: 6px; font-size:14px;";
                div.textContent = `‚ùå ${message}`;
                area.prepend(div);
            }
             // --- Helper: Show Auth Warning ---
             function showAuthWarning() {
                 let warningDiv = document.querySelector(".auth-warning");
                 if (!warningDiv) {
                     warningDiv = document.createElement("div");
                     warningDiv.className = "auth-warning";
                     warningDiv.style.cssText = "background:#fff3cd; color:#856404; padding:15px; margin: 20px; text-align:center; border:1px solid #ffeeba; border-radius: 8px; font-weight: bold; position: sticky; top: 70px; z-index: 1001;";
                     warningDiv.textContent = "‚ö†Ô∏è Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.";
                     const mainContent = document.querySelector('.main-content');
                     if(mainContent) mainContent.prepend(warningDiv); else document.body.prepend(warningDiv);
                 }
             }


            // ==========================
            // Load Danh s√°ch (Chung)
            // ==========================
            async function loadData(listType = 'recipients') {
                currentListType = listType;
                console.log(`üì¶ ƒêang t·∫£i danh s√°ch: ${listType}...`);
                if (!tbody) { console.error("‚ùå Kh√¥ng t√¨m th·∫•y tbody!"); return; }

                const token = getValidTokenWithBearer();
                 if (!token) { // D·ª´ng n·∫øu kh√¥ng c√≥ token
                     showGenericError("Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c phi√™n h·∫øt h·∫°n. Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.");
                     tbody.innerHTML = `<tr><td colspan="6" class="no-data">L·ªói x√°c th·ª±c</td></tr>`;
                     return;
                 }
                const headers = { 'Content-Type': 'application/json', "Authorization": token };
                const endpoint = listType === 'senders' ? '/users/get-all' : '/receivers/get-all';
                const url = `${API_BASE_URL}${endpoint}`;

                try {
                    tbody.innerHTML = `<tr><td colspan="6" class="no-data">ƒêang t·∫£i...</td></tr>`;
                    console.log(`üîÑ Fetching ${listType} from:`, url);
                    const res = await fetch(url, { headers });

                    if (res.status === 401) {
                        showAuthWarning();
                        throw new Error("L·ªói 401 - Unauthorized");
                    }
                    if (!res.ok) {
                         const errorText = await res.text();
                         throw new Error(`HTTP ${res.status}: ${errorText || res.statusText}`);
                    }

                    const data = await res.json();
                    const rawData = data.result || data.data || (Array.isArray(data) ? data : []);
                    console.log(`‚úÖ Loaded raw ${listType} data:`, rawData);

                    // Chu·∫©n h√≥a d·ªØ li·ªáu
                    if (listType === 'senders') {
                        currentData = rawData.map(u => ({
                            id: u._id?.$oid || u._id || u.id,
                            name: u.name || "N/A",
                            phone: u.phone_number || u.phoneNumber || "N/A",
                            address: u.address || {},
                            tags: [], success_rate: null
                        }));
                    } else { // recipients
                        currentData = rawData.map(r => ({
                            id: r._id?.$oid || r._id || r.id,
                            name: r.name || "N/A",
                            phone: r.phone || "N/A",
                            address: r.address || {},
                            tags: r.tags || [], success_rate: r.success_rate
                        }));
                    }
                    renderTable(); // C·∫≠p nh·∫≠t UI
                } catch (err) {
                    console.error(`‚ùå L·ªói t·∫£i danh s√°ch ${listType}:`, err);
                    if(tbody) tbody.innerHTML = `<tr><td colspan="6" class="no-data">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu (${err.message})</td></tr>`;
                    showGenericError(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch ${listType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n'}: ${err.message}`);
                }
            }

            // ==========================
            // Render B·∫£ng (Chung)
            // ==========================
            function renderTable() {
                 if (!tbody || !nameColumnHeader || !successRateHeader) return;

                 nameColumnHeader.textContent = currentListType === 'senders' ? 'T√äN NG∆Ø·ªúI G·ª¨I' : 'T√äN NG∆Ø·ªúI NH·∫¨N';
                 successRateHeader.style.display = currentListType === 'senders' ? 'none' : '';

                tbody.innerHTML = "";
                if (!currentData.length) {
                    tbody.innerHTML = `<tr><td colspan="6" class="no-data">Kh√¥ng c√≥ b·∫£n ghi n√†o</td></tr>`;
                    return;
                }

                currentData.forEach((item, i) => {
                    const addressParts = [
                        item.address.detail || item.address.other,
                        item.address.ward, item.address.district, item.address.province
                    ].filter(Boolean);
                    const addressString = addressParts.length > 0 ? addressParts.join(', ') : "‚Äî";
                    const tagHTML = item.tags?.map(t => `<span class="tag">${t.name || 'Tag'}</span>`).join(" ") || "‚Äî";

                    const tr = document.createElement("tr");
                    tr.setAttribute('data-customer-id', item.id);
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${item.name}</td>
                        <td>${tagHTML}</td>
                        <td style="display: ${currentListType === 'senders' ? 'none' : ''};">
                           ${item.success_rate !== undefined && item.success_rate !== null ? Number(item.success_rate).toFixed(1) + '%' : 'N/A'}
                        </td>
                        <td>${addressString}</td>
                        <td>
                            <button class="btn btn-edit btn-sm" data-id="${item.id}"><i class="fas fa-edit"></i> S·ª≠a</button>
                            <button class="btn btn-danger btn-sm btn-delete" data-id="${item.id}"><i class="fas fa-trash-alt"></i> Xo√°</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                 addTableActionListeners();
                 console.log(` B·∫£ng ${currentListType} ƒë√£ ƒë∆∞·ª£c render.`);
            }

            // ==========================
            // G·∫Øn Listeners cho n√∫t S·ª≠a/Xo√°
            // ==========================
            function addTableActionListeners() {
                if (!tbody) return;
                tbody.querySelectorAll('.btn-delete').forEach(button => {
                     button.removeEventListener('click', handleDeleteClick);
                     button.addEventListener('click', handleDeleteClick);
                });
                tbody.querySelectorAll('.btn-edit').forEach(button => {
                    button.removeEventListener('click', handleEditClick);
                    button.addEventListener('click', handleEditClick);
                });
            }

            // Handler Xo√°
            async function handleDeleteClick(event) { /* ... gi·ªØ nguy√™n, g·ªçi deleteCustomer ... */
                const button = event.currentTarget;
                const customerId = button.dataset.id;
                if (!customerId) return;
                const personTypeText = currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n';
                if (confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° ${personTypeText} n√†y (ID: ${customerId})?`)) {
                     button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Loading icon
                     await deleteCustomer(customerId);
                     // N√∫t s·∫Ω t·ª± bi·∫øn m·∫•t khi b·∫£ng render l·∫°i, kh√¥ng c·∫ßn b·∫≠t l·∫°i
                }
            }

             // Handler S·ª≠a (M·ªü modal)
            function handleEditClick(event) { /* ... gi·ªØ nguy√™n, g·ªçi showCustomerModal ... */
                const customerId = event.currentTarget.dataset.id;
                const customer = currentData.find(c => c.id === customerId);
                if (customer) {
                    console.log(`‚úèÔ∏è Edit ${currentListType}:`, customer);
                    showCustomerModal(true, customer); // G·ªçi h√†m global ƒë√£ expose
                } else {
                     console.error(`‚ùå Kh√¥ng t√¨m th·∫•y ${currentListType} v·ªõi ID ${customerId} ƒë·ªÉ s·ª≠a.`);
                     alert("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng.");
                }
            }


            // ==========================
            // Th√™m m·ªõi Kh√°ch h√†ng (Chung)
            // ==========================
            async function createCustomer(customerData) { /* ... gi·ªØ nguy√™n ... */
                console.log(`‚ûï Creating new ${currentListType}...`, customerData);
                const token = getValidTokenWithBearer();
                if (!token) return Promise.reject("Ch∆∞a ƒëƒÉng nh·∫≠p");

                let url, payload = { ...customerData };
                if (currentListType === 'senders') {
                    url = `${API_BASE_URL}/users/insert`; // C·∫¶N X√ÅC NH·∫¨N ENDPOINT N√ÄY
                    // C·∫ßn ƒëi·ªÅu ch·ªânh payload cho API user
                    payload.username = customerData.phone; // Gi·∫£ ƒë·ªãnh
                    payload.password = "123456"; // Gi·∫£ ƒë·ªãnh
                    payload.phone_number = customerData.phone;
                    delete payload.phone; delete payload.tags;
                    console.warn("Payload cho /users/insert C·∫¶N ƒê∆Ø·ª¢C KI·ªÇM TRA!", payload);
                } else { url = `${API_BASE_URL}/receivers/insert`; }

                const headers = { "Content-Type": "application/json", "Authorization": token };

                try {
                    console.log(`üì§ Sending create request to: ${url}`);
                    const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(payload) });
                    if (!res.ok) { const txt = await res.text(); throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`); }
                    const result = await res.json();
                    const createdData = result.result || result.data || result;
                    console.log(`‚úÖ ${currentListType} created:`, createdData);
                    await loadData(currentListType); // T·∫£i l·∫°i
                    alert(`‚úÖ ƒê√£ th√™m ${currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n'} m·ªõi th√†nh c√¥ng!`);
                    return createdData;
                } catch (err) {
                    console.error(`‚ùå L·ªói khi th√™m ${currentListType}:`, err);
                    alert(`‚ö†Ô∏è Th√™m ${currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n'} th·∫•t b·∫°i: ${err.message}`);
                    throw err;
                }
            }

            // ==========================
            // Xo√° Kh√°ch h√†ng (Chung)
            // ==========================
            async function deleteCustomer(id) { /* ... gi·ªØ nguy√™n ... */
                console.log(`‚ûñ Deleting ${currentListType} with ID: ${id}`);
                const token = getValidTokenWithBearer();
                 if (!token) return Promise.reject("Ch∆∞a ƒëƒÉng nh·∫≠p");

                const endpoint = currentListType === 'senders' ? `/users/delete/${id}` : `/receivers/delete/${id}`; // C·∫¶N X√ÅC NH·∫¨N ENDPOINT USER
                const url = `${API_BASE_URL}${endpoint}`;
                const headers = { "Authorization": token };

                try {
                    console.log(`üì§ Sending delete request to: ${url}`);
                    const res = await fetch(url, { method: "DELETE", headers });
                     if (res.status === 401) { showAuthWarning(); throw new Error("L·ªói 401"); }
                    if (!res.ok) { const txt = await res.text(); throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`); }
                    console.log(`‚úÖ ${currentListType} deleted successfully:`, id);
                    await loadData(currentListType); // T·∫£i l·∫°i
                    alert(`‚úÖ ƒê√£ xo√° ${currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n'} (ID: ${id}) th√†nh c√¥ng!`);
                    return true;
                } catch (err) {
                    console.error(`‚ùå L·ªói khi xo√° ${currentListType}:`, err);
                    alert(`‚ö†Ô∏è Xo√° ${currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n'} th·∫•t b·∫°i: ${err.message}`);
                    await loadData(currentListType); // T·∫£i l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o UI ƒë√∫ng
                    throw err;
                }
            }

            // ==========================
            // C·∫≠p nh·∫≠t Kh√°ch h√†ng (Chung)
            // ==========================
            async function updateCustomer(id, customerData) { /* ... gi·ªØ nguy√™n ... */
                 console.log(`üîÑ Updating ${currentListType} with ID: ${id}...`, customerData);
                 const token = getValidTokenWithBearer();
                 if (!token) return Promise.reject("Ch∆∞a ƒëƒÉng nh·∫≠p");

                 let url, payload = { ...customerData };
                  if (currentListType === 'senders') {
                    url = `${API_BASE_URL}/users/update/${id}`; // C·∫¶N X√ÅC NH·∫¨N ENDPOINT USER
                    payload.phone_number = customerData.phone;
                    delete payload.phone; delete payload.tags;
                     console.warn("Payload cho /users/update C·∫¶N ƒê∆Ø·ª¢C KI·ªÇM TRA!", payload);
                 } else { url = `${API_BASE_URL}/receivers/update/${id}`; }

                 const headers = { "Content-Type": "application/json", "Authorization": token };

                 try {
                     console.log(`üì§ Sending update request to: ${url}`);
                     const res = await fetch(url, { method: "PUT", headers, body: JSON.stringify(payload) });
                      if (res.status === 401) { showAuthWarning(); throw new Error("L·ªói 401"); }
                     if (!res.ok) { const txt = await res.text(); throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`); }
                     const result = await res.json();
                     const updatedData = result.result || result.data || result;
                     console.log(`‚úÖ ${currentListType} updated:`, updatedData);
                     await loadData(currentListType); // T·∫£i l·∫°i
                     alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ${currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n'} th√†nh c√¥ng!`);
                      return updatedData;
                 } catch (err) {
                     console.error(`‚ùå L·ªói khi c·∫≠p nh·∫≠t ${currentListType}:`, err);
                     alert(`‚ö†Ô∏è C·∫≠p nh·∫≠t ${currentListType === 'senders' ? 'ng∆∞·ªùi g·ª≠i' : 'ng∆∞·ªùi nh·∫≠n'} th·∫•t b·∫°i: ${err.message}`);
                      throw err;
                 }
            }

            // ==========================
            // T√¨m ki·∫øm (Render l·∫°i b·∫£ng)
            // ==========================
            function searchAndRender(searchTerm) { /* ... gi·ªØ nguy√™n ... */
                 console.log(`üîç Searching ${currentListType} for: "${searchTerm}"`);
                 const lowerCaseTerm = searchTerm.toLowerCase();
                 const filteredData = currentData.filter(item =>
                     (item.name && item.name.toLowerCase().includes(lowerCaseTerm)) ||
                     (item.phone && item.phone.includes(searchTerm))
                 );
                 renderFilteredTable(filteredData); // G·ªçi h√†m render ri√™ng cho d·ªØ li·ªáu l·ªçc
            }

             // Helper render b·∫£ng v·ªõi data l·ªçc (kh√¥ng g·ªçi API)
             function renderFilteredTable(filteredData) { /* ... gi·ªØ nguy√™n ... */
                 if (!tbody || !nameColumnHeader || !successRateHeader) return;
                 nameColumnHeader.textContent = currentListType === 'senders' ? 'T√äN NG∆Ø·ªúI G·ª¨I' : 'T√äN NG∆Ø·ªúI NH·∫¨N';
                 successRateHeader.style.display = currentListType === 'senders' ? 'none' : '';
                 tbody.innerHTML = "";
                 if (!filteredData.length) {
                     tbody.innerHTML = `<tr><td colspan="6" class="no-data">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o</td></tr>`;
                     return;
                 }
                 filteredData.forEach((item, i) => { /* ... t·∫°o HTML d√≤ng gi·ªØ nguy√™n ... */
                    const addressParts = [ item.address.detail || item.address.other, item.address.ward, item.address.district, item.address.province ].filter(Boolean);
                    const addressString = addressParts.length > 0 ? addressParts.join(', ') : "‚Äî";
                    const tagHTML = item.tags?.map(t => `<span class="tag">${t.name || 'Tag'}</span>`).join(" ") || "‚Äî";
                    const tr = document.createElement("tr");
                    tr.setAttribute('data-customer-id', item.id);
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${item.name}</td>
                        <td>${tagHTML}</td>
                        <td style="display: ${currentListType === 'senders' ? 'none' : ''};">
                           ${item.success_rate !== undefined && item.success_rate !== null ? Number(item.success_rate).toFixed(1) + '%' : 'N/A'}
                        </td>
                        <td>${addressString}</td>
                        <td>
                            <button class="btn btn-edit btn-sm" data-id="${item.id}"><i class="fas fa-edit"></i> S·ª≠a</button>
                            <button class="btn btn-danger btn-sm btn-delete" data-id="${item.id}"><i class="fas fa-trash-alt"></i> Xo√°</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                 });
                 addTableActionListeners(); // G·∫Øn l·∫°i listener
                 console.log(` B·∫£ng ${currentListType} ƒë√£ ƒë∆∞·ª£c render v·ªõi ${filteredData.length} k·∫øt qu·∫£ t√¨m ki·∫øm.`);
             }


            // --- Modal Hide Logic (Gi·ªØ nguy√™n) ---
            function hideModal() { /* ... ƒë√£ ƒë·ªãnh nghƒ©a ·ªü tr√™n ... */
                 if (modal) {
                     modal.classList.add('hidden');
                     if (customerForm) customerForm.reset();
                     if (editCustomerIdInput) editCustomerIdInput.value = '';
                }
            }

            // --- Attach Modal Show/Hide Listeners (Gi·ªØ nguy√™n) ---
            if (addNewBtn) { addNewBtn.removeEventListener('click', handleAddNewClick); addNewBtn.addEventListener('click', handleAddNewClick); }
            function handleAddNewClick() { showCustomerModal(false); } // G·ªçi h√†m global
            if (closeModalBtn) { closeModalBtn.removeEventListener('click', hideModal); closeModalBtn.addEventListener('click', hideModal); }
            if (cancelBtn) { cancelBtn.removeEventListener('click', hideModal); cancelBtn.addEventListener('click', hideModal); }
            if (modal) { modal.removeEventListener('click', handleOverlayClick); modal.addEventListener('click', handleOverlayClick); }
            function handleOverlayClick(event) { if (event.target === modal) hideModal(); }


            // --- Attach Form Submit Listener ---
            if (customerForm) {
                customerForm.removeEventListener('submit', handleFormSubmit);
                customerForm.addEventListener('submit', handleFormSubmit);
            }

            async function handleFormSubmit(event) {
                event.preventDefault();
                console.log("Form submitted...");
                const isEdit = !!editCustomerIdInput.value;
                const customerId = editCustomerIdInput.value;
                const submitButton = document.getElementById('submitCustomerBtn');

                // L·∫•y c√°c element form b√™n trong h√†m
                const fullNameInput = document.getElementById("fullName");
                const phoneInput = document.getElementById("phoneNumber");
                const addressDetailInput = document.getElementById("addressDetail");
                const currentProvinceSelect = document.getElementById('provinceSelect');
                const currentDistrictSelect = document.getElementById('districtSelect');
                const currentWardSelect = document.getElementById('wardSelect');

                // --- Validation ---
                if (!fullNameInput?.value || !phoneInput?.value || !addressDetailInput?.value || !currentProvinceSelect?.value || !currentDistrictSelect?.value || !currentWardSelect?.value ) {
                     alert("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin H·ªç t√™n, SƒêT v√† ƒê·ªãa ch·ªâ."); return;
                }
                const phoneRegex = /^(0[3|5|7|8|9])[0-9]{8}$/;
                if (!phoneRegex.test(phoneInput.value)) { alert("‚ö†Ô∏è S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá."); return; }
                // --- End Validation ---

                 // --- L·∫•y t√™n T·ªânh/Huy·ªán/X√£ ---
                const provinceText = currentProvinceSelect.options[currentProvinceSelect.selectedIndex]?.text || '';
                const districtText = currentDistrictSelect.options[currentDistrictSelect.selectedIndex]?.text || '';
                const wardText = currentWardSelect.options[currentWardSelect.selectedIndex]?.text || '';
                // --- K·∫øt th√∫c l·∫•y t√™n ---

                const customerData = {
                    name: fullNameInput.value.trim(),
                    phone: phoneInput.value.trim(),
                    address: {
                        detail: addressDetailInput.value.trim(),
                        province: provinceText.replace(/^(T·ªânh|Th√†nh ph·ªë)\s*/, ''),
                        district: districtText.replace(/^(Qu·∫≠n|Huy·ªán|Th·ªã x√£|Th√†nh ph·ªë)\s*/, ''),
                        ward: wardText.replace(/^(Ph∆∞·ªùng|X√£|Th·ªã tr·∫•n)\s*/, '')
                    },
                    tags: []
                };
                console.log("Data to send:", customerData, "Is Edit:", isEdit, "ID:", customerId);

                if (submitButton) { submitButton.disabled = true; submitButton.textContent = isEdit ? 'ƒêang c·∫≠p nh·∫≠t...' : 'ƒêang th√™m...'; }

                try {
                    let success = false;
                    if (isEdit) {
                        await updateCustomer(customerId, customerData); // G·ªçi h√†m update chung
                        success = true;
                    } else {
                        await createCustomer(customerData); // G·ªçi h√†m create chung
                        success = true;
                    }
                    if (success) hideModal();
                } catch (error) {
                    console.error("Error during form submission API call:", error);
                    // Alert ƒë√£ c√≥ trong h√†m create/updateCustomer
                } finally {
                     if (submitButton) { submitButton.disabled = false; submitButton.textContent = isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'; }
                }
            }


            // --- Attach Search Listeners ---
            if (searchBtn) { searchBtn.removeEventListener('click', handleSearch); searchBtn.addEventListener('click', handleSearch); }
            if (searchInput) { searchInput.removeEventListener('keypress', handleSearchEnter); searchInput.addEventListener('keypress', handleSearchEnter); }

            function handleSearch() {
                const searchTerm = searchInput ? searchInput.value.trim() : '';
                console.log(`üîç Searching for: "${searchTerm}"`);
                searchAndRender(searchTerm); // G·ªçi h√†m search chung
            }
            function handleSearchEnter(event) { if (event.key === 'Enter') handleSearch(); }


            // --- Attach List Type Dropdown Listener ---
            if (listTypeSelect) {
                listTypeSelect.removeEventListener('change', handleListTypeChange);
                listTypeSelect.addEventListener('change', handleListTypeChange);
            }

            function handleListTypeChange() {
                const selectedType = listTypeSelect ? listTypeSelect.value : 'recipients';
                console.log(`üîÑ Changing list type to: ${selectedType}`);

                if (pageTitle && nameColumnHeader && successRateHeader) {
                    pageTitle.textContent = selectedType === 'senders' ? 'DANH S√ÅCH NG∆Ø·ªúI G·ª¨I' : 'DANH S√ÅCH NG∆Ø·ªúI NH·∫¨N';
                    nameColumnHeader.textContent = selectedType === 'senders' ? 'T√äN NG∆Ø·ªúI G·ª¨I' : 'T√äN NG∆Ø·ªúI NH·∫¨N';
                    successRateHeader.style.display = selectedType === 'senders' ? 'none' : '';

                    console.log(`üöÄ Calling loadData('${selectedType}')...`);
                    loadData(selectedType); // G·ªçi h√†m load chung
                } else {
                    console.error("‚ùå Kh√¥ng t√¨m th·∫•y pageTitle, nameColumnHeader ho·∫∑c successRateHeader!");
                }
            }


            // --- TODO: Load Address Data & Attach Listeners ---
             console.log("TODO: Implement address loading (loadProvinces, etc.)");
             console.log("TODO: Attach listeners to address dropdowns.");
             // V√≠ d·ª• g·∫Øn listener c∆° b·∫£n
              if (provinceSelect) provinceSelect.addEventListener('change', () => {
                  const provinceCode = provinceSelect.value;
                  console.log("Province changed:", provinceCode);
                  if (provinceCode) { /* loadDistricts(provinceCode); */ districtSelect.disabled = false; wardSelect.disabled = true; wardSelect.innerHTML='<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';}
                  else { districtSelect.disabled = true; wardSelect.disabled = true; districtSelect.innerHTML='<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>'; wardSelect.innerHTML='<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';}
              });
               if (districtSelect) districtSelect.addEventListener('change', () => {
                  const districtCode = districtSelect.value;
                   console.log("District changed:", districtCode);
                  if (districtCode) { /* loadWards(districtCode); */ wardSelect.disabled = false; }
                  else { wardSelect.disabled = true; wardSelect.innerHTML='<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';}
              });


            // --- TODO: Attach Pagination Listeners ---
            console.log("TODO: Add event listeners for pagination controls.");


            // --- Call function to load initial data (Recipients by default) ---
            handleListTypeChange(); // G·ªçi h√†m n√†y ban ƒë·∫ßu ƒë·ªÉ load recipients

            console.log("‚úÖ Customer List page UI Initialized");
        } // --- End initCustomerListPage ---


        // --- LOGIC KI·ªÇM TRA ƒê·ªÇ G·ªåI H√ÄM INIT ---
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initCustomerListPage);
        } else {
            initCustomerListPage();
        }
    </script>
    </body>
</html>