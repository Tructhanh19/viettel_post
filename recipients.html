<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch ng∆∞·ªùi nh·∫≠n - Viettel Post</title>
    <link rel="stylesheet" href="assets/recipients.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container">
        <div class="main-content">
            <div class="content-header">
                <h1 class="title">DANH S√ÅCH NG∆Ø·ªúI NH·∫¨N</h1>
                <button class="btn btn-primary" id="addNewBtn">
                    <span class="plus-icon">+</span> Th√™m m·ªõi
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="filters">
                        <div class="dropdown-container">
                            <select class="custom-select">
                                <option>Danh s√°ch ng∆∞·ªùi nh·∫≠n</option>
                                <option>Danh s√°ch ng∆∞·ªùi g·ª≠i</option> </select>
                        </div>
                        <input type="text" class="search-input" id="recipientSearchInput" placeholder="Nh·∫≠p t√™n/s·ªë ƒëi·ªán tho·∫°i"> <button class="btn btn-search" id="recipientSearchBtn">T√¨m ki·∫øm</button> </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>T√äN NG∆Ø·ªúI NH·∫¨N</th>
                                    <th>TH·∫∫ TAG</th>
                                    <th>T·ª∂ L·ªÜ GIAO TH√ÄNH C√îNG</th>
                                    <th>ƒê·ªäA CH·ªà</th>
                                    <th>THAO T√ÅC</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="no-data">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination"> <div class="records-per-page">
                            <span>B·∫£n Ghi M·ªói Trang</span>
                             <div class="dropdown-container small">
                                <select class="custom-select" id="itemsPerPageSelect">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                        </div>
                        <div class="page-info">
                            <span id="paginationInfo">0 of 0</span>
                            <div class="nav-arrows">
                                <span id="firstPageBtn">&lt;&lt;</span>
                                <span id="prevPageBtn">&lt;</span>
                                <span id="nextPageBtn">&gt;</span>
                                <span id="lastPageBtn">&gt;&gt;</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addRecipientModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Th√™m m·ªõi th√¥ng tin kh√°ch h√†ng</h2> <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                 <input type="hidden" id="editRecipientId" value="">
                <form id="recipientForm"> <div class="form-group">
                        <label for="fullName" class="required">H·ªç t√™n</label>
                        <input type="text" id="fullName" name="fullName" required> </div>
                    <div class="form-group">
                        <label for="phoneNumber" class="required">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required pattern="^(0[3|5|7|8|9])[0-9]{8}$" title="Nh·∫≠p SƒêT Vi·ªát Nam g·ªìm 10 ch·ªØ s·ªë (vd: 0912345678)"> </div>
                    <div class="form-group">
                        <label for="address" class="required">ƒê·ªãa ch·ªâ chi ti·∫øt</label> <input type="text" id="address" name="address" placeholder="Nh·∫≠p s·ªë nh√†, t√™n ƒë∆∞·ªùng..." required>
                        <small class="form-helper">Ch·ªâ nh·∫≠p s·ªë nh√†/t√™n ƒë∆∞·ªùng. T·ªânh/Huy·ªán/X√£ s·∫Ω ch·ªçn b√™n d∆∞·ªõi.</small>
                    </div>
                     <div class="form-group">
                         <label for="provinceSelect">T·ªânh/Th√†nh ph·ªë</label>
                         <select id="provinceSelect" required><option value="">-- Ch·ªçn T·ªânh/TP --</option></select>
                     </div>
                      <div class="form-group">
                         <label for="districtSelect">Qu·∫≠n/Huy·ªán</label>
                         <select id="districtSelect" required><option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option></select>
                     </div>
                      <div class="form-group">
                         <label for="wardSelect">Ph∆∞·ªùng/X√£</label>
                         <select id="wardSelect" required><option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option></select>
                     </div>
                     </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBtn">Tho√°t</button>
                <button type="submit" form="recipientForm" class="btn btn-danger" id="submitRecipientBtn">Th√™m m·ªõi</button> </div>
        </div>
    </div>

    <script>
        // --- B·ªåC T·∫§T C·∫¢ V√ÄO H√ÄM INIT ---
        function initRecipientsPage() {
            console.log("üöÄ Initializing Recipients Page UI..."); // Th√™m log

            // --- Get Elements (safer inside init) ---
            const addNewBtn = document.getElementById('addNewBtn');
            const modal = document.getElementById('addRecipientModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const submitBtn = document.getElementById('submitRecipientBtn');
            const recipientForm = document.getElementById('recipientForm'); // Get form
            const modalTitle = document.getElementById('modalTitle');
            const editRecipientIdInput = document.getElementById('editRecipientId');

            // Form fields
            const fullNameInput = document.getElementById("fullName");
            const phoneInput = document.getElementById("phoneNumber");
            const addressInput = document.getElementById("address");
             // Address selectors (Add these later when implementing address logic)
            // const provinceSelect = document.getElementById('provinceSelect');
            // const districtSelect = document.getElementById('districtSelect');
            // const wardSelect = document.getElementById('wardSelect');

            // Search elements
            const searchInput = document.getElementById('recipientSearchInput');
            const searchBtn = document.getElementById('recipientSearchBtn');

            // Pagination elements (Add later if implementing pagination)
            // const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
            // const paginationInfo = document.getElementById('paginationInfo');
            // const firstPageBtn = document.getElementById('firstPageBtn');
            // const prevPageBtn = document.getElementById('prevPageBtn');
            // const nextPageBtn = document.getElementById('nextPageBtn');
            // const lastPageBtn = document.getElementById('lastPageBtn');


            // --- Modal Logic ---
            function showModal(isEdit = false, recipientData = null) {
                if (!modal || !modalTitle || !submitBtn || !editRecipientIdInput) return; // Guard clause

                editRecipientIdInput.value = isEdit && recipientData ? recipientData.id : ''; // Set ID for editing
                modalTitle.textContent = isEdit ? 'C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi nh·∫≠n' : 'Th√™m m·ªõi th√¥ng tin ng∆∞·ªùi nh·∫≠n';
                submitBtn.textContent = isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi';

                if (isEdit && recipientData) {
                    // Pre-fill form for editing
                    if(fullNameInput) fullNameInput.value = recipientData.name || '';
                    if(phoneInput) phoneInput.value = recipientData.phone || '';
                    if(addressInput) addressInput.value = recipientData.address?.detail || '';
                    // TODO: Pre-select Province/District/Ward based on recipientData.address
                    console.log("TODO: Pre-select address dropdowns for editing");
                } else {
                    // Reset form for adding new
                    if (recipientForm) recipientForm.reset(); // Reset the form itself
                     editRecipientIdInput.value = ''; // Ensure ID is clear
                    // TODO: Reset address dropdowns
                     console.log("TODO: Reset address dropdowns for adding");
                }
                modal.classList.remove('hidden');
            }

            function hideModal() {
                if (modal) {
                     modal.classList.add('hidden');
                     if (recipientForm) recipientForm.reset(); // Reset form on hide
                     if (editRecipientIdInput) editRecipientIdInput.value = ''; // Clear edit ID
                }
            }

            // --- Attach Modal Listeners ---
            if (addNewBtn) {
                 addNewBtn.removeEventListener('click', handleAddNewClick); // Prevent duplicates
                 addNewBtn.addEventListener('click', handleAddNewClick);
            }
             function handleAddNewClick() { showModal(false); } // Wrapper to call showModal for adding

            if (closeModalBtn) {
                 closeModalBtn.removeEventListener('click', hideModal);
                 closeModalBtn.addEventListener('click', hideModal);
            }
            if (cancelBtn) {
                 cancelBtn.removeEventListener('click', hideModal);
                 cancelBtn.addEventListener('click', hideModal);
            }
            if (modal) {
                // Close modal on overlay click
                 modal.removeEventListener('click', handleOverlayClick);
                 modal.addEventListener('click', handleOverlayClick);
            }
             function handleOverlayClick(event) {
                 if (event.target === modal) {
                     hideModal();
                 }
             }

            // --- Attach Form Submit Listener ---
            if (recipientForm) {
                recipientForm.removeEventListener('submit', handleFormSubmit); // Prevent duplicates
                recipientForm.addEventListener('submit', handleFormSubmit);
            }

            async function handleFormSubmit(event) {
                event.preventDefault(); // Prevent default form submission
                 console.log("Form submitted...");
                const isEdit = !!editRecipientIdInput.value; // Check if it's an edit operation
                const recipientId = editRecipientIdInput.value;

                // --- Basic Validation (HTML5 required should handle most) ---
                if (!fullNameInput?.value || !phoneInput?.value || !addressInput?.value /*|| !provinceSelect?.value || !districtSelect?.value || !wardSelect?.value */) {
                     alert("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc.");
                     return;
                }
                 // Additional JS validation if needed (e.g., phone format again)
                 const phoneRegex = /^(0[3|5|7|8|9])[0-9]{8}$/;
                 if (!phoneRegex.test(phoneInput.value)) {
                     alert("‚ö†Ô∏è S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.");
                     return;
                 }
                // --- End Validation ---


                const recipientData = {
                    name: fullNameInput.value.trim(),
                    phone: phoneInput.value.trim(),
                    address: {
                        detail: addressInput.value.trim(),
                        // --- TODO: Get actual values from address dropdowns ---
                        province: "TP. H·ªì Ch√≠ Minh", // Placeholder provinceSelect.value,
                        district: "Qu·∫≠n 1", // Placeholder districtSelect.value,
                        ward: "Ph∆∞·ªùng B·∫øn Ngh√©" // Placeholder wardSelect.value
                        // --- End TODO ---
                    },
                    tags: [] // Default empty tags for now
                };

                 console.log("Data to send:", recipientData, "Is Edit:", isEdit, "ID:", recipientId);


                 // --- Call API function from RecipientsData module ---
                 if (window.RecipientsData) {
                     try {
                         if (isEdit) {
                             // --- Call Update Function (Needs to be added to RecipientsData module) ---
                             if (typeof window.RecipientsData.updateRecipient === 'function') {
                                 console.log(`üöÄ Calling RecipientsData.updateRecipient(${recipientId})...`);
                                 await window.RecipientsData.updateRecipient(recipientId, recipientData);
                                 hideModal(); // Close modal on success
                             } else {
                                 console.error("‚ùå RecipientsData.updateRecipient function not available!");
                                 alert("L·ªói: Ch·ª©c nƒÉng c·∫≠p nh·∫≠t ch∆∞a s·∫µn s√†ng.");
                             }
                             // --- End Call Update ---
                         } else {
                              // --- Call Create Function ---
                             if (typeof window.RecipientsData.createRecipient === 'function') {
                                 console.log("üöÄ Calling RecipientsData.createRecipient()...");
                                 await window.RecipientsData.createRecipient(recipientData); // Pass data object
                                 hideModal(); // Close modal on success
                             } else {
                                 console.error("‚ùå RecipientsData.createRecipient function not available!");
                                 alert("L·ªói: Ch·ª©c nƒÉng th√™m m·ªõi ch∆∞a s·∫µn s√†ng.");
                             }
                              // --- End Call Create ---
                         }
                     } catch (error) {
                         // Error handling is likely done within the module's functions,
                         // but you could add specific UI feedback here if needed.
                         console.error("Error during form submission:", error);
                     }
                 } else {
                     console.error("‚ùå RecipientsData module not available for form submission!");
                     alert("L·ªói: Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu.");
                 }
            }


             // --- Attach Search Listeners ---
             if (searchBtn) {
                 searchBtn.removeEventListener('click', handleSearch);
                 searchBtn.addEventListener('click', handleSearch);
             }
             if (searchInput) {
                 searchInput.removeEventListener('keypress', handleSearchEnter);
                 searchInput.addEventListener('keypress', handleSearchEnter);
             }

             function handleSearch() {
                 const searchTerm = searchInput ? searchInput.value.trim() : '';
                 console.log(`üîç Searching for: "${searchTerm}"`);
                 // --- TODO: Call filter/search function in RecipientsData and re-render table ---
                 if (window.RecipientsData && typeof window.RecipientsData.searchAndRender === 'function') {
                    // window.RecipientsData.searchAndRender(searchTerm);
                     console.log("TODO: Implement searchAndRender in RecipientsData module");
                     alert(`Ch·ª©c nƒÉng t√¨m ki·∫øm "${searchTerm}" ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t.`);
                 } else {
                      console.error("‚ùå RecipientsData.searchAndRender function not available!");
                 }
             }
             function handleSearchEnter(event) {
                 if (event.key === 'Enter') {
                     handleSearch();
                 }
             }

            // --- TODO: Attach Pagination Listeners ---
            console.log("TODO: Add event listeners for pagination controls.");

            // --- Call function to load initial data ---
            if (window.RecipientsData && typeof window.RecipientsData.loadRecipients === 'function') {
                console.log("üöÄ Calling RecipientsData.loadRecipients() from recipients.html");
                window.RecipientsData.loadRecipients(); // Load data when page initializes
            } else {
                console.error("‚ùå RecipientsData or RecipientsData.loadRecipients not available!");
                const tbody = document.querySelector(".main-content tbody");
                if(tbody) tbody.innerHTML = `<tr><td colspan="6" class="no-data">L·ªói t·∫£i m√¥-ƒëun d·ªØ li·ªáu ng∆∞·ªùi nh·∫≠n.</td></tr>`;
            }

            console.log("‚úÖ Recipients page UI Initialized"); // Th√™m log cu·ªëi
        } // --- End initRecipientsPage ---


        // --- LOGIC KI·ªÇM TRA ƒê·ªÇ G·ªåI H√ÄM INIT ---
        if (document.readyState === "loading") {
            // Ch·∫°y ƒë·ªôc l·∫≠p: ƒê·ª£i DOM load xong
            document.addEventListener("DOMContentLoaded", initRecipientsPage);
        } else {
            // Ch·∫°y qua index.html (DOM ƒë√£ load): Ch·∫°y ngay!
            initRecipientsPage();
        }
    </script>
    <script src="assets/api/config.js"></script>
    <script src="assets/api/recipients-data.js"></script> </body>
</html>