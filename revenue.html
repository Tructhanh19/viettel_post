<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o s·∫£n l∆∞·ª£ng ƒë·ªãa ph∆∞∆°ng</title>
    <link rel="stylesheet" href="assets/revenue.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>B√°o c√°o s·∫£n l∆∞·ª£ng ƒë·ªãa ph∆∞∆°ng th·ªëng k√™ theo doanh thu</h2>
            <div class="filters">
                <div class="filter-control dropdown-wrapper">
                    <select id="filter-region">
                        <option>ƒê·ªãa ph∆∞∆°ng</option>
                        <option>Kho h√†ng</option>
                        <option>Kh√°ch h√†ng</option>
                    </select>
                </div>
                <div class="filter-control date-picker-wrapper">
                    <input type="text" id="date-range-picker" placeholder="Ch·ªçn kho·∫£ng th·ªùi gian">
                    <i class="fa-regular fa-calendar-days calendar-icon"></i>
                </div>
            </div>
        </div>

        <div class="cards">
            <div class="card">
                <h3>T·ªïng s·ªë ƒë∆°n h√†ng</h3>
                <div class="value blue">0</div>
            </div>
            <div class="card">
                <h3>T·ªïng s·ªë t·ªânh</h3>
                <div class="value cyan">0</div>
            </div>
            <div class="card">
                <h3>T·ªïng s·ªë doanh thu</h3>
                <div class="value yellow">0 ‚Ç´</div>
            </div>
        </div>

        <div class="report-content">
            <div class="chart-container">
                <div class="chart-placeholder"></div> </div>
            <div class="table-container">
                <div class="note">* Th√¥ng tin n√†y ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o.</div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n t·ªânh</th>
                            <th>S·ªë ƒë∆°n</th>
                            <th>Doanh thu</th>
                            <th>T·ªâ l·ªá %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="empty-row">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination"> <span>B·∫£n Ghi M·ªói Trang</span>
                    <select class="page-size-select"><option>10</option><option>20</option></select>
                    <span>0 of 0</span>
                    <div class="nav-arrows">
                        <span>&lt;&lt;</span><span>&lt;</span><span>&gt;</span><span>&gt;&gt;</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="chat-button">
        <i class="fa-solid fa-comment-dots"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
    <script>
        // --- B·ªåC T·∫§T C·∫¢ V√ÄO H√ÄM INIT ---
        function initRevenuePage() {
            console.log("üöÄ Initializing Revenue Page UI..."); // Th√™m log

             // Helper function to show errors within this page context
             function showRevenuePageError(message) {
                 const container = document.querySelector('.report-content'); // Target main content area
                 if (!container) return;
                 let errorDiv = container.querySelector('.revenue-page-error');
                 if (!errorDiv) {
                     errorDiv = document.createElement('div');
                     errorDiv.className = 'revenue-page-error'; // Specific class
                     errorDiv.style.cssText = "background:#f8d7da; color:#721c24; padding:10px 15px; margin:15px 0; text-align:center; border:1px solid #f5c6cb; border-radius: 6px; font-size:14px;";
                     container.prepend(errorDiv); // Add to the top
                 }
                 errorDiv.textContent = `‚ùå ${message}`;
             }


            // --- Initialize Flatpickr ---
             if (typeof flatpickr !== 'undefined') {
                flatpickr("#date-range-picker", {
                    mode: "range",
                    dateFormat: "d/m/Y",
                    locale: "vn",
                    defaultDate: ["25/09/2025", "08/10/2025"], // Default range
                    monthSelectorType: 'static',
                    showMonths: 2,
                    onReady: function(selectedDates, dateStr, instance) {
                        console.log("üìÖ Flatpickr #date-range-picker s·∫µn s√†ng.");
                        const shortcuts = document.createElement('div');
                        shortcuts.className = 'flatpickr-shortcuts';
                        const options = ['H√¥m nay', 'H√¥m qua', '7 ng√†y tr∆∞·ªõc', '14 ng√†y tr∆∞·ªõc', '30 ng√†y tr∆∞·ªõc', 'Th√°ng n√†y', 'Th√°ng tr∆∞·ªõc'];

                        options.forEach(optionText => {
                            const btn = document.createElement('button');
                            btn.className = 'shortcut-button';
                            btn.textContent = optionText;
                             // Set initial active based on defaultDate (approx 14 days ago)
                            if(optionText === '14 ng√†y tr∆∞·ªõc') btn.classList.add('active');

                            btn.addEventListener('click', (e) => {
                                e.preventDefault();
                                const now = new Date();
                                let start, end;
                                // ... (switch case for date ranges - keep original logic) ...
                                switch(optionText) {
                                    case 'H√¥m nay': start = new Date(now); end = new Date(now); break;
                                    case 'H√¥m qua': start = new Date(now); start.setDate(now.getDate() - 1); end = new Date(start); break;
                                    case '7 ng√†y tr∆∞·ªõc': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 6); break;
                                    case '14 ng√†y tr∆∞·ªõc': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 13); break;
                                    case '30 ng√†y tr∆∞·ªõc': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 29); break;
                                    case 'Th√°ng n√†y': start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); break;
                                    case 'Th√°ng tr∆∞·ªõc': start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); break;
                                }

                                shortcuts.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active')); // Deactivate others
                                e.target.classList.add('active'); // Activate clicked
                                instance.setDate([start, end], true); // Set date and trigger onChange
                            });
                            shortcuts.appendChild(btn);
                        });

                         // Prepend shortcuts if container exists
                        if(instance.calendarContainer) {
                             instance.calendarContainer.prepend(shortcuts);
                        } else {
                             console.warn("‚ö†Ô∏è calendarContainer kh√¥ng t√¨m th·∫•y ƒë·ªÉ ch√®n shortcuts.");
                        }

                        // --- CALL DATA MODULE FUNCTIONS ---
                        if (window.RevenueData) {
                             console.log("üöÄ Calling RevenueData initialization methods from onReady...");
                             if (typeof window.RevenueData.initializeDatePickerListener === 'function') {
                                 window.RevenueData.initializeDatePickerListener(); // Setup listener for future changes
                             } else {
                                  console.error("‚ùå RevenueData.initializeDatePickerListener not available!");
                                  showRevenuePageError("L·ªói: Kh√¥ng th·ªÉ theo d√µi thay ƒë·ªïi ng√†y.");
                             }
                             if (typeof window.RevenueData.initialLoad === 'function') {
                                 window.RevenueData.initialLoad(); // Load initial data
                             } else {
                                  console.error("‚ùå RevenueData.initialLoad not available!");
                                   showRevenuePageError("L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu doanh thu ban ƒë·∫ßu.");
                             }
                        } else {
                             console.error("‚ùå RevenueData module not available!");
                             showRevenuePageError("L·ªói nghi√™m tr·ªçng: Module d·ªØ li·ªáu doanh thu kh√¥ng t·∫£i ƒë∆∞·ª£c.");
                              // Display error in table as well
                              const tbody = document.querySelector(".table-container tbody");
                              if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="empty-row">L·ªói t·∫£i module d·ªØ li·ªáu</td></tr>`;
                        }
                        // --- END CALL DATA MODULE FUNCTIONS ---

                    }, // end onReady
                    // Add onChange here as well, in case onReady doesn't fire correctly on dynamic load
                     onChange: function(selectedDates, dateStr, instance) {
                         // Check if the listener was already added by initializeDatePickerListener in RevenueData
                         // This simple check prevents double-loading if both run.
                         // A more robust solution might involve flags.
                         const hasRevenueListener = instance.config.onChange.some(fn => fn.name === 'bound loadRevenueStatistics'); // Check if specific listener exists
                         if (!hasRevenueListener && selectedDates.length === 2) {
                              console.warn("‚ö†Ô∏è onChange called before RevenueData listener was attached. Calling initialLoad.");
                              if (window.RevenueData && typeof window.RevenueData.initialLoad === 'function') {
                                 // Call initialLoad directly as a fallback if the main listener wasn't attached yet
                                 window.RevenueData.initialLoad();
                              }
                         } else if (!hasRevenueListener) {
                              console.log("onChange called but RevenueData listener not found or date range incomplete.");
                         }
                         // Deactivate shortcuts when manually selecting dates
                         instance.calendarContainer.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));
                     }
                }); // end flatpickr init
             } else {
                  console.error("‚ùå Th∆∞ vi·ªán Flatpickr ch∆∞a ƒë∆∞·ª£c t·∫£i!");
                  showRevenuePageError("L·ªói: Kh√¥ng th·ªÉ kh·ªüi t·∫°o b·ªô ch·ªçn ng√†y.");
                  const datePickerInput = document.getElementById('date-range-picker');
                  if (datePickerInput) datePickerInput.placeholder = "L·ªói t·∫£i l·ªãch";
             }


            // --- TODO: Initialize other UI elements like filters or pagination listeners ---
             console.log("TODO: Initialize filters and pagination listeners for Revenue page.");


             console.log("‚úÖ Revenue page UI Initialized"); // Log end of UI init
        } // --- End initRevenuePage ---

        // --- LOGIC KI·ªÇM TRA ƒê·ªÇ G·ªåI H√ÄM INIT ---
        if (document.readyState === "loading") {
            // Ch·∫°y ƒë·ªôc l·∫≠p: ƒê·ª£i DOM load xong
            document.addEventListener("DOMContentLoaded", initRevenuePage);
        } else {
            // Ch·∫°y qua index.html (DOM ƒë√£ load): Ch·∫°y ngay!
            initRevenuePage();
        }
    </script>
     <script src="assets/api/config.js"></script>
    <script src="assets/api/revenue-data.js"></script> </body>
</html>