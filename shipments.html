<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω v·∫≠n ƒë∆°n - Viettel Post</title>
    <link rel="stylesheet" href="assets/shipments.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

    <div class="page-container">
        <h1 class="page-title">Qu·∫£n l√Ω v·∫≠n ƒë∆°n</h1>
        <div class="card">
            <div class="card-body">
                <div class="filter-area">
                    <div class="filter-main">
                        <div class="filter-row">
                            <div class="filter-item search-bar"><input type="text" id="shipmentSearchInput" placeholder="T√¨m ƒë∆°n h√†ng, s·ªë ƒëi·ªán tho·∫°i"><button class="search-btn" id="shipmentSearchBtn"><i class="fa-solid fa-magnifying-glass"></i></button></div>
                            <div class="filter-item date-picker-wrapper"><input type="text" id="datePicker" placeholder="Ch·ªçn ng√†y"><i class="fa-regular fa-calendar-days calendar-icon"></i></div>
                            <div class="filter-item"><div class="custom-dropdown" data-placeholder="T·∫•t c·∫£ kho h√†ng"></div></div>
                            <div class="filter-item"><div class="custom-dropdown" data-placeholder="Ng∆∞·ªùi tr·∫£ c∆∞·ªõc"></div></div>
                            <div class="filter-item"><div class="custom-dropdown" data-placeholder="ƒê∆°n h√†ng g·ª≠i"></div></div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-item"><div class="custom-dropdown" data-placeholder="Tr·∫°ng th√°i thanh to√°n COD"></div></div>
                            <div class="filter-item"><div class="custom-dropdown" data-placeholder="Ch·ªçn theo d·ªãch v·ª•"></div></div>
                            <div class="filter-item"><div class="custom-dropdown" data-placeholder="Ch·ªçn t√†i kho·∫£n t·∫°o ƒë∆°n"></div></div>
                            <div class="filter-item" style="visibility: hidden;"></div>
                             <div class="filter-item" style="visibility: hidden;"></div>
                        </div>
                    </div>
                    <div class="add-filter-container">
                         <button id="addFilterBtn" class="add-filter-btn">
                            <svg class="gears-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <path d="M42.2,27.1l-4-1.6c-0.2-0.9-0.5-1.8-0.9-2.6l2.3-3.4c0.4-0.6,0.3-1.4-0.2-1.9l-2.8-2.8c-0.5-0.5-1.4-0.6-1.9-0.2l-3.4,2.3c-0.8-0.4-1.7-0.7-2.6-0.9l-1.6-4c-0.2-0.7-0.8-1.1-1.5-1.1h-4c-0.7,0-1.4,0.5-1.5,1.1l-1.6,4c-0.9,0.2-1.8,0.5-2.6,0.9l-3.4-2.3c-0.6-0.4-1.4-0.3-1.9,0.2l-2.8,2.8c-0.5,0.5-0.6,1.4-0.2,1.9l2.3,3.4c-0.4,0.8-0.7,1.7-0.9,2.6l-4,1.6C5.5,27.3,5,27.9,5,28.7v4c0,0.7,0.5,1.4,1.1,1.5l4,1.6c0.2,0.9,0.5,1.8,0.9,2.6l-2.3,3.4c-0.4,0.6-0.3,1.4,0.2,1.9l2.8,2.8c0.5,0.5,1.4,0.6,1.9,0.2l3.4-2.3c0.8,0.4,1.7,0.7,2.6,0.9l1.6,4c0.2,0.7,0.8,1.1,1.5,1.1h4c0.7,0,1.4-0.5,1.5-1.1l1.6-4c0.9-0.2,1.8-0.5,2.6-0.9l3.4,2.3c0.6,0.4,1.4,0.3,1.9-0.2l2.8-2.8c0.5-0.5,0.6-1.4,0.2-1.9l-2.3-3.4c0.4-0.8,0.7-1.7,0.9-2.6l4-1.6c0.7-0.2,1.1-0.8,1.1-1.5v-4C43.3,27.9,42.8,27.3,42.2,27.1z M24.3,36.7c-4.4,0-8-3.6-8-8s3.6-8,8-8s8,3.6,8,8S28.7,36.7,24.3,36.7z"/>
                                <path d="M23.8,19.3c-2.6,0-4.9,1.7-5.8,4c-0.2-0.9-0.5-1.8-0.9-2.6l-2.3-3.4c-0.4-0.6-0.3-1.4,0.2-1.9L17.8,13c0.5-0.5,1.4-0.6,1.9-0.2l3.4,2.3c0.8-0.4,1.7-0.7,2.6-0.9l1.6-4c0.2-0.7,0.8-1.1,1.5-1.1h4c0.7,0,1.4,0.5,1.5,1.1l1.6,4c0.5,0.1,1,0.3,1.5,0.5c3-1.2,6.4-0.2,8.4,2.4c0.5,0.6,0.4,1.5-0.2,2l-2.4,3.4c-0.3,0.5-0.8,0.8-1.4,0.8c-0.4,0-0.8-0.2-1.1-0.5c-1.3-1.8-3.5-2.6-5.6-2.1c-0.6,0.1-1.2,0.3-1.7,0.6c-0.7-0.2-1.4-0.3-2.1-0.3c-0.1,0-0.2,0-0.3,0C24,19.3,23.9,19.3,23.8,19.3z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                 <div class="update-info"><i class="fa-solid fa-wifi"></i> C·∫≠p nh·∫≠t danh s√°ch l·∫ßn cu·ªëi l√∫c <span id="lastUpdatedTime">--:--</span></div> <div class="actions-toolbar">
                    <div id="mainActions" class="main-actions">
                        </div>
                     </div>

                <div class="summary-stats">
                    <div class="stat-item active" data-status-target="T·∫•t c·∫£"><i class="fa-solid fa-box-archive"></i><span>T·ªïng s·ªë ƒë∆°n</span><b>0 ƒë∆°n</b></div>
                    <div class="stat-item" data-status-target="L·∫•y th√†nh c√¥ng"><i class="fa-solid fa-truck-fast"></i><span>L·∫•y th√†nh c√¥ng</span><b>0 ƒë∆°n</b></div> <div class="stat-item" data-status-target="Ch·ªù l·∫•y"><i class="fa-solid fa-hourglass-half"></i><span>Ch·ªù l·∫•y</span><b>0 ƒë∆°n</b></div>
                    <div class="stat-item" data-status-target="H·ªßy l·∫•y"><i class="fa-solid fa-ban"></i><span>H·ªßy l·∫•y</span><b>0 ƒë∆°n</b></div>
                    <div class="stat-item" data-status-target="ƒê∆°n nh√°p"><i class="fa-solid fa-file-pen"></i><span>ƒê∆°n nh√°p</span><b>0 ƒë∆°n</b></div>
                </div>

                <div class="tabs-container">
                    <button class="tab-scroll-btn left" id="scrollLeftBtn"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="status-tabs" id="statusTabs">
                        <a href="#" class="tab-item active" data-status="T·∫•t c·∫£"><span class="color-box red"></span>T·∫•t c·∫£ (0)</a>
                        <a href="#" class="tab-item" data-status="ƒê√£ ti·∫øp nh·∫≠n"><span class="color-box blue"></span>ƒê√£ ti·∫øp nh·∫≠n (0)</a>
                        <a href="#" class="tab-item" data-status="ƒêang l·∫•y h√†ng"><span class="color-box orange"></span>ƒêang l·∫•y h√†ng (0)</a>
                        <a href="#" class="tab-item" data-status="ƒê√£ l·∫•y h√†ng"><span class="color-box yellow"></span>ƒê√£ l·∫•y h√†ng (0)</a>
                        <a href="#" class="tab-item" data-status="ƒêang v·∫≠n chuy·ªÉn"><span class="color-box purple"></span>ƒêang v·∫≠n chuy·ªÉn (0)</a>
                        <a href="#" class="tab-item" data-status="ƒêang giao h√†ng"><span class="color-box teal"></span>ƒêang giao h√†ng (0)</a>
                        <a href="#" class="tab-item" data-status="Ch·ªù ph√°t l·∫°i"><span class="color-box gray"></span>Ch·ªù ph√°t l·∫°i (0)</a>
                        <a href="#" class="tab-item" data-status="Giao th√†nh c√¥ng"><span class="color-box green"></span>Giao th√†nh c√¥ng (0)</a>
                        <a href="#" class="tab-item" data-status="Ch·ªù x·ª≠ l√Ω"><span class="color-box brown"></span>Ch·ªù x·ª≠ l√Ω (0)</a>
                        <div class="tab-item dropdown" id="otherTabsContainer">
                            Kh√°c <span class="dropdown-arrow"></span>
                            <div class="dropdown-menu" id="otherTabsDropdown">
                                <a href="#" class="dropdown-item" data-status="ƒê∆°n nh√°p"><span class="color-box" style="background-color: #81d4fa;"></span>ƒê∆°n nh√°p (0)</a>
                                <a href="#" class="dropdown-item" data-status="L·∫•y kh√¥ng th√†nh c√¥ng"><span class="color-box" style="background-color: #ef5350;"></span>L·∫•y kh√¥ng th√†nh c√¥ng (0)</a>
                                <a href="#" class="dropdown-item" data-status="ƒê√£ duy·ªát ho√†n"><span class="color-box" style="background-color: #7986cb;"></span>ƒê√£ duy·ªát ho√†n (0)</a>
                                <a href="#" class="dropdown-item" data-status="ƒê√£ tr·∫£"><span class="color-box" style="background-color: #ba68c8;"></span>ƒê√£ tr·∫£ (0)</a>
                                <a href="#" class="dropdown-item" data-status="ƒê√£ h·ªßy giao"><span class="color-box" style="background-color: #d7ccc8;"></span>ƒê√£ h·ªßy giao (0)</a>
                                <a href="#" class="dropdown-item" data-status="ƒêang chuy·ªÉn ho√†n"><span class="color-box" style="background-color: #7986cb;"></span>ƒêang chuy·ªÉn ho√†n (0)</a>
                                <a href="#" class="dropdown-item" data-status="Ph√°t ti·∫øp"><span class="color-box" style="background-color: #aed581;"></span>Ph√°t ti·∫øp (0)</a>
                                <a href="#" class="dropdown-item" data-status="VTP h·ªßy l·∫•y"><span class="color-box" style="background-color: #ef5350;"></span>VTP h·ªßy l·∫•y (0)</a>
                                 </div>
                        </div>
                    </div>
                    <button class="tab-scroll-btn right" id="scrollRightBtn"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="table-area"><p style="text-align: center; padding: 40px; color: #888;">ƒêang t·∫£i d·ªØ li·ªáu...</p></div> <div class="pagination"> <div class="records-per-page"><span>B·∫£n Ghi M·ªói Trang</span><div class="custom-dropdown small" data-placeholder="10"></div></div>
                    <div class="page-info"><span id="paginationInfo">0 of 0</span><div class="nav-arrows"><span>&lt;&lt;</span><span>&lt;</span><span>&gt;</span><span>&gt;&gt;</span></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ch·ªçn th√™m ƒëi·ªÅu ki·ªán l·ªçc</h2>
                <button class="close-btn" id="closeFilterModalBtn">&times;</button> </div>
            <div class="modal-body">
                <div class="checkbox-grid">
                    <label class="custom-checkbox"><input type="checkbox" checked> Ch·ªçn t·∫•t c·∫£</label>
                    <label class="custom-checkbox"><input type="checkbox" checked> Kho h√†ng</label>
                    <label class="custom-checkbox"><input type="checkbox" checked> Ng∆∞·ªùi tr·∫£ c∆∞·ªõc</label>
                    <label class="custom-checkbox"><input type="checkbox" checked> Tr·∫°ng th√°i thanh to√°n COD</label>
                    <label class="custom-checkbox"><input type="checkbox" checked> D·ªãch v·ª•</label>
                    <label class="custom-checkbox"><input type="checkbox" checked> T√†i kho·∫£n t·∫°o ƒë∆°n</label>
                     </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="cancelFilterBtn">H·ªßy b·ªè</button>
                <button class="btn btn-save" id="saveFilterBtn">L∆∞u</button>
            </div>
        </div>
    </div>

     <div class="modal-overlay hidden" id="statusModal">
      <div class="modal-content" style="max-width: 400px;"> <div class="modal-header">
          <h2 id="statusModalTitle">C·∫≠p nh·∫≠t tr·∫°ng th√°i</h2> <button class="close-btn" id="closeStatusModalBtn">&times;</button> </div>
        <div class="modal-body">
          <p>Ch·ªçn tr·∫°ng th√°i m·ªõi cho ƒë∆°n h√†ng <strong id="statusModalOrderCode"></strong>:</p>
          <select id="statusSelect" style="width: 100%; padding: 8px; margin-top: 10px;">
             <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
            <option value="ƒê√£ ti·∫øp nh·∫≠n">ƒê√£ ti·∫øp nh·∫≠n</option>
            <option value="ƒêang l·∫•y h√†ng">ƒêang l·∫•y h√†ng</option>
            <option value="ƒê√£ l·∫•y h√†ng">ƒê√£ l·∫•y h√†ng</option>
            <option value="ƒêang v·∫≠n chuy·ªÉn">ƒêang v·∫≠n chuy·ªÉn</option>
            <option value="ƒêang giao h√†ng">ƒêang giao h√†ng</option>
            <option value="Ch·ªù ph√°t l·∫°i">Ch·ªù ph√°t l·∫°i</option>
            <option value="Giao th√†nh c√¥ng">Giao th√†nh c√¥ng</option>
            <option value="Ch·ªù x·ª≠ l√Ω">Ch·ªù x·ª≠ l√Ω</option>
             <option value="ƒê∆°n nh√°p">ƒê∆°n nh√°p</option>
             <option value="L·∫•y kh√¥ng th√†nh c√¥ng">L·∫•y kh√¥ng th√†nh c√¥ng</option>
             <option value="ƒê√£ duy·ªát ho√†n">ƒê√£ duy·ªát ho√†n</option>
             <option value="ƒê√£ tr·∫£">ƒê√£ tr·∫£</option>
             <option value="ƒê√£ h·ªßy giao">ƒê√£ h·ªßy giao</option>
             <option value="ƒêang chuy·ªÉn ho√†n">ƒêang chuy·ªÉn ho√†n</option>
             <option value="Ph√°t ti·∫øp">Ph√°t ti·∫øp</option>
             <option value="H·ªßy l·∫•y">H·ªßy l·∫•y</option> <option value="VTP h·ªßy l·∫•y">VTP h·ªßy l·∫•y</option>
             </select>
        </div>
        <div class="modal-footer">
           <button class="btn btn-cancel" id="cancelStatusBtn">H·ªßy</button> <button class="btn btn-save" id="confirmStatusBtn">X√°c nh·∫≠n</button> </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
    <script>
    // --- B·ªåC T·∫§T C·∫¢ V√ÄO H√ÄM INIT ---
    function initShipmentsPage() {
        console.log("üöÄ Initializing Shipments Page UI..."); // Th√™m log

         // Helper function to show errors within this page context
         function showShipmentsPageError(message, areaSelector = ".table-area") {
            const area = document.querySelector(areaSelector);
            if (!area) return;
            let errorDiv = area.querySelector('.shipments-page-error');
             if (!errorDiv) {
                 errorDiv = document.createElement('div');
                 errorDiv.className = 'shipments-page-error';
                 errorDiv.style.cssText = "background:#f8d7da; color:#721c24; padding:10px 15px; margin:15px 0; text-align:center; border:1px solid #f5c6cb; border-radius: 6px; font-size:14px;";
                 // Prepend error within the specific area
                 if (area.firstChild) {
                    area.insertBefore(errorDiv, area.firstChild);
                 } else {
                     area.appendChild(errorDiv);
                 }
            }
            errorDiv.textContent = `‚ùå ${message}`;
        }


        // --- C·∫•u h√¨nh Date Picker ---
         if (typeof flatpickr !== 'undefined') {
            flatpickr("#datePicker", {
                mode: "range", dateFormat: "d/m/Y", locale: "vn",
                defaultDate: ["08/10/2025", "08/10/2025"], // Keep original default
                 // --- Add onChange for Date Picker ---
                 onChange: function(selectedDates, dateStr, instance) {
                     if (selectedDates.length === 2) {
                         const from = selectedDates[0].toISOString();
                         const to = selectedDates[1].toISOString();
                         console.log(`üóìÔ∏è Date range changed: ${from} to ${to}. TODO: Implement date range filtering.`);
                         // TODO: Call a filtering function in ShipmentsData module, passing the date range
                         // if (window.ShipmentsData && typeof window.ShipmentsData.filterOrders === 'function') {
                         //    window.ShipmentsData.filterOrders({ dateFrom: from, dateTo: to });
                         // }
                         alert(`Ch·ª©c nƒÉng l·ªçc theo ng√†y ${dateStr} ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t.`);
                     }
                 }
                 // --- End onChange ---
            });
         } else {
              console.error("‚ùå Th∆∞ vi·ªán Flatpickr ch∆∞a ƒë∆∞·ª£c t·∫£i!");
              showShipmentsPageError("L·ªói: Kh√¥ng th·ªÉ kh·ªüi t·∫°o b·ªô ch·ªçn ng√†y.", ".filter-main"); // Show error near date picker
               const dpInput = document.getElementById('datePicker');
               if(dpInput) dpInput.placeholder = "L·ªói t·∫£i l·ªãch";
         }


        // --- D·ªØ li·ªáu v√† T·∫°o Combobox (Gi·ªØ nguy√™n logic t·∫°o) ---
        const dropdownData = {
            "T·∫•t c·∫£ kho h√†ng": { type: 'search-select', options: ["T·∫•t c·∫£ kho h√†ng", "Kho Royal City", "Kho Times City"] },
            "Ng∆∞·ªùi tr·∫£ c∆∞·ªõc": { type: 'select', options: ["Ng∆∞·ªùi tr·∫£ c∆∞·ªõc", "Ng∆∞·ªùi g·ª≠i", "Ng∆∞·ªùi nh·∫≠n"] },
            "ƒê∆°n h√†ng g·ª≠i": { type: 'select', options: ["ƒê∆°n h√†ng g·ª≠i", "ƒê∆°n h√†ng nh·∫≠n", "ƒê∆°n s√†n", "Y√™u c·∫ßu k√Ω g·ª≠i qu·ªëc t·∫ø"] },
            "Tr·∫°ng th√°i thanh to√°n COD": { type: 'search-select', options: ["Tr·∫°ng th√°i thanh to√°n COD", "Kh√¥ng c√≥ COD", "Ch∆∞a ƒë·ªëi so√°t COD", "Ch·ªù nh·∫≠n COD", "ƒê√£ nh·∫≠n COD"] },
            "Ch·ªçn theo d·ªãch v·ª•": { type: 'radio-select', options: ["Ch·ªçn theo d·ªãch v·ª•", "Giao 1 ph·∫ßn", "L∆∞u kho", "Giao ngay n·ªôi t·ªânh"] },
            "Ch·ªçn t√†i kho·∫£n t·∫°o ƒë∆°n": { type: 'search-select', options: ["Ch·ªçn t√†i kho·∫£n t·∫°o ƒë∆°n", "T·∫•t c·∫£", "ƒê·ªó Hu·ª≥nh Gi√°p"] },
            "10": { type: 'select', options: ["10", "20", "50"] } // For pagination dropdown
        };

        document.querySelectorAll('.custom-dropdown').forEach(container => {
            const placeholder = container.dataset.placeholder;
            const data = dropdownData[placeholder];
            if (!data) return;

            // ... (Ph·∫ßn code HTML generation v√† event listener cho dropdown gi·ªØ nguy√™n nh∆∞ b·∫£n g·ªëc b·∫°n cung c·∫•p) ...
             const initialText = data.options[0];
            const optionsList = data.type === 'radio-select' ? data.options.slice(1) : data.options;
            let optionsHtml;

            if (data.type === 'radio-select') {
                optionsHtml = `<div class="dropdown-header"><button class="clear-btn">B·ªè ch·ªçn</button></div><ul>${optionsList.map(opt => `<li><label><input type="radio" name="${placeholder}"> ${opt}</label></li>`).join('')}</ul>`;
            } else {
                optionsHtml = `<ul>${optionsList.map(opt => `<li class="${opt === initialText ? 'active' : ''}">${opt}</li>`).join('')}</ul>`;
            }

            const searchHtml = (data.type === 'search-select') ? `<div class="dropdown-search"><input type="text" placeholder="T√¨m ki·∫øm..."></div>` : '';
            container.innerHTML = `<div class="dropdown-selected"><span>${initialText}</span><i class="fa-solid fa-caret-down"></i></div><div class="dropdown-options">${searchHtml}${optionsHtml}</div>`;

            const selected = container.querySelector('.dropdown-selected');
            const optionsContainer = container.querySelector('.dropdown-options');
            const allOptions = optionsContainer.querySelectorAll('li');
            const span = selected.querySelector('span');
             const clearBtn = optionsContainer.querySelector('.clear-btn'); // Get clear button if exists

            selected.addEventListener('click', e => {
                e.stopPropagation();
                const isShown = optionsContainer.classList.contains('show');
                // Close all other dropdowns first
                document.querySelectorAll('.custom-dropdown .dropdown-options.show').forEach(otherOpt => {
                     if (otherOpt !== optionsContainer) otherOpt.classList.remove('show');
                });
                // Toggle current dropdown
                optionsContainer.classList.toggle('show');
            });

             // Add listener for clear button in radio-select
             if (clearBtn) {
                 clearBtn.addEventListener('click', (e) => {
                     e.stopPropagation(); // Prevent dropdown closing
                     const radios = optionsContainer.querySelectorAll('input[type="radio"]');
                     radios.forEach(radio => radio.checked = false);
                     span.textContent = initialText; // Reset display text
                     optionsContainer.classList.remove('show'); // Close dropdown
                      console.log(`Dropdown cleared: ${placeholder}`);
                     // TODO: Trigger filter update after clearing
                 });
             }


            allOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                     const selectedValue = opt.textContent.trim();
                     span.textContent = selectedValue;
                    if (data.type !== 'radio-select') {
                        allOptions.forEach(o => o.classList.remove('active'));
                        opt.classList.add('active');
                    } else {
                         // Ensure radio button is checked visually (if not already handled by label click)
                         const radio = opt.querySelector('input[type="radio"]');
                         if (radio) radio.checked = true;
                    }
                    optionsContainer.classList.remove('show'); // Close dropdown after selection
                     console.log(`Dropdown selected: ${placeholder} = ${selectedValue}`);
                    // --- TODO: Trigger filter update ---
                     // if (window.ShipmentsData && typeof window.ShipmentsData.filterOrders === 'function') {
                     //     let filterCriteria = {};
                     //     filterCriteria[placeholder] = selectedValue; // Need a mapping for placeholder to API field
                     //     window.ShipmentsData.filterOrders(filterCriteria);
                     // }
                     alert(`Ch·ª©c nƒÉng l·ªçc theo "${placeholder} = ${selectedValue}" ch∆∞a c√†i ƒë·∫∑t.`);
                });
            });
        });
        // Global click listener to close dropdowns
         window.removeEventListener('click', closeAllDropdowns); // Remove first
         window.addEventListener('click', closeAllDropdowns);
         function closeAllDropdowns() {
             document.querySelectorAll('.custom-dropdown .dropdown-options.show').forEach(opt => opt.classList.remove('show'));
         }


        // --- X·ª≠ l√Ω Action Buttons d·ª±a tr√™n Tab ---
        const mainActionsContainer = document.getElementById('mainActions');
        const allTabs = document.querySelectorAll('.tab-item, .dropdown-item');
        // L∆∞u tr·ªØ HTML n√∫t c∆° b·∫£n ban ƒë·∫ßu
        const baseButtonsHtml = `
            <button class="btn btn-print"><i class="fa-solid fa-print"></i> IN ƒê∆†N</button>
            <button class="btn btn-export-excel"><i class="fa-solid fa-file-excel"></i> XU·∫§T EXCEL</button>
            <button class="btn btn-import-excel"><i class="fa-solid fa-upload"></i> NH·∫¨P EXCEL</button>
        `;
         // Initialize with base buttons
         if (mainActionsContainer) mainActionsContainer.innerHTML = baseButtonsHtml;

        function updateActionButtons(status) {
            let dynamicButtons = '';
            switch (status) {
                case 'ƒê√£ ti·∫øp nh·∫≠n':
                case 'ƒêang l·∫•y h√†ng':
                    dynamicButtons = `<button class="btn btn-cancel-order"><i class="fa-solid fa-trash-can"></i> H·ª¶Y ƒê∆†N</button>`;
                    break;
                case 'ƒêang giao h√†ng':
                case 'Ch·ªù ph√°t l·∫°i':
                    dynamicButtons = `<button class="btn btn-store-package"><i class="fa-solid fa-warehouse"></i> L∆ØU KHO</button>`;
                    break;
                case 'Ch·ªù x·ª≠ l√Ω':
                    dynamicButtons = `<button class="btn btn-approve-return"><i class="fa-solid fa-check"></i> DUY·ªÜT HO√ÄN</button><button class="btn btn-store-package"><i class="fa-solid fa-warehouse"></i> L∆ØU KHO</button>`;
                    break;
                 // Add cases for other statuses if they have specific actions
            }
            if (mainActionsContainer) {
                mainActionsContainer.innerHTML = baseButtonsHtml + dynamicButtons;
                 console.log(` N√∫t Action ƒë∆∞·ª£c c·∫≠p nh·∫≠t cho tr·∫°ng th√°i: ${status}`);
            } else {
                 console.error("‚ùå mainActionsContainer kh√¥ng t√¨m th·∫•y ƒë·ªÉ c·∫≠p nh·∫≠t n√∫t!");
            }
        }

        allTabs.forEach(tab => {
             // Remove old listener
             tab.removeEventListener('click', handleTabClick);
             // Add new listener
            tab.addEventListener('click', handleTabClick);
        });

        function handleTabClick(e) {
            e.preventDefault(); e.stopPropagation();
            allTabs.forEach(t => t.classList.remove('active'));
            e.currentTarget.classList.add('active'); // Use currentTarget
            const otherTabsDropdown = document.getElementById('otherTabsDropdown');
            if (e.currentTarget.classList.contains('dropdown-item') && otherTabsDropdown) {
                otherTabsDropdown.classList.remove('show');
            }
            const newStatus = e.currentTarget.dataset.status;
            console.log(` M·ªü tab: ${newStatus}`);
            updateActionButtons(newStatus);

            // --- G·ªåI RENDER TABLE T·ª™ MODULE ---
            if (window.ShipmentsData && typeof window.ShipmentsData.renderTable === 'function') {
                window.ShipmentsData.renderTable(newStatus);
            } else {
                console.error("‚ùå ShipmentsData.renderTable is not available!");
                 showShipmentsPageError("L·ªói: Kh√¥ng th·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu cho tab n√†y.");
            }
        }


        // --- X·ª≠ l√Ω dropdown "Kh√°c" ---
        const otherTabsContainer = document.getElementById('otherTabsContainer');
        if (otherTabsContainer) {
             otherTabsContainer.removeEventListener('click', handleOtherTabsClick); // Remove old
            otherTabsContainer.addEventListener('click', handleOtherTabsClick); // Add new
        }
        function handleOtherTabsClick(e) {
             // Let clicks on items inside bubble up to the item's own listener
             if (e.target.closest('.dropdown-item')) return;
             e.stopPropagation(); // Prevent window click listener from closing it immediately
             const otherTabsDropdown = document.getElementById('otherTabsDropdown');
             if (otherTabsDropdown) otherTabsDropdown.classList.toggle('show');
        }


        // --- X·ª≠ l√Ω cu·ªôn ngang cho c√°c tab ---
        const scrollContainer = document.getElementById('statusTabs');
        const scrollLeftBtn = document.getElementById('scrollLeftBtn');
        const scrollRightBtn = document.getElementById('scrollRightBtn');
        if (scrollContainer && scrollLeftBtn && scrollRightBtn) {
             scrollLeftBtn.removeEventListener('click', scrollTabsLeft);
             scrollLeftBtn.addEventListener('click', scrollTabsLeft);
             scrollRightBtn.removeEventListener('click', scrollTabsRight);
             scrollRightBtn.addEventListener('click', scrollTabsRight);
        }
        function scrollTabsLeft() { scrollContainer.scrollBy({ left: -200, behavior: 'smooth' }); }
        function scrollTabsRight() { scrollContainer.scrollBy({ left: 200, behavior: 'smooth' }); }


        // --- X·ª≠ l√Ω ch·ªçn m·ª•c th·ªëng k√™ (Stat Items) ---
        document.querySelectorAll('.summary-stats .stat-item').forEach(item => {
             item.removeEventListener('click', handleStatItemClick); // Remove old
            item.addEventListener('click', handleStatItemClick); // Add new
        });
        function handleStatItemClick(e) {
            document.querySelectorAll('.summary-stats .stat-item').forEach(i => i.classList.remove('active'));
            e.currentTarget.classList.add('active'); // Use currentTarget
            const newStatusFilter = e.currentTarget.dataset.statusTarget; // Get filter value
            console.log(`üìä Stat item clicked, filtering by: ${newStatusFilter}`);

             // Also activate the corresponding tab if it exists
             const correspondingTab = document.querySelector(`.tab-item[data-status="${newStatusFilter}"], .dropdown-item[data-status="${newStatusFilter}"]`);
             if (correspondingTab) {
                 allTabs.forEach(t => t.classList.remove('active'));
                 correspondingTab.classList.add('active');
                 updateActionButtons(newStatusFilter); // Update actions based on the new status

                 // If the corresponding tab is inside the 'Kh√°c' dropdown, ensure dropdown is closed
                 const otherTabsDropdown = document.getElementById('otherTabsDropdown');
                 if (correspondingTab.classList.contains('dropdown-item') && otherTabsDropdown) {
                     otherTabsDropdown.classList.remove('show');
                 }
             } else {
                  console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tab t∆∞∆°ng ·ª©ng cho stat item: ${newStatusFilter}`);
             }


            // --- G·ªåI RENDER TABLE T·ª™ MODULE ---
            if (window.ShipmentsData && typeof window.ShipmentsData.renderTable === 'function') {
                window.ShipmentsData.renderTable(newStatusFilter); // Use the filter value
            } else {
                console.error("‚ùå ShipmentsData.renderTable is not available!");
                 showShipmentsPageError("L·ªói: Kh√¥ng th·ªÉ l·ªçc d·ªØ li·ªáu theo th·ªëng k√™.");
            }
        }


        // --- X·ª≠ l√Ω modal "Th√™m b·ªô l·ªçc" (Filter Modal) ---
        const addFilterBtn = document.getElementById('addFilterBtn');
        const filterModal = document.getElementById('filterModal');
        const closeFilterModalBtn = document.getElementById('closeFilterModalBtn'); // Corrected ID
        const cancelFilterBtn = document.getElementById('cancelFilterBtn');
        const saveFilterBtn = document.getElementById('saveFilterBtn');

        if (addFilterBtn && filterModal && closeFilterModalBtn && cancelFilterBtn && saveFilterBtn) {
            const showFilterModal = () => filterModal.classList.remove('hidden');
            const hideFilterModal = () => filterModal.classList.add('hidden');

             addFilterBtn.removeEventListener('click', showFilterModal);
            addFilterBtn.addEventListener('click', showFilterModal);

             closeFilterModalBtn.removeEventListener('click', hideFilterModal);
            closeFilterModalBtn.addEventListener('click', hideFilterModal);

             cancelFilterBtn.removeEventListener('click', hideFilterModal);
            cancelFilterBtn.addEventListener('click', hideFilterModal);

             saveFilterBtn.removeEventListener('click', handleSaveFilter); // Use specific handler
             saveFilterBtn.addEventListener('click', handleSaveFilter);

             // Close on overlay click
             filterModal.removeEventListener('click', handleFilterOverlayClick);
             filterModal.addEventListener('click', handleFilterOverlayClick);

             function handleSaveFilter() {
                 console.log("üíæ Filter settings saved (TODO: Apply filters).");
                 // TODO: Get selected filter values from checkboxes/inputs inside modal
                 // TODO: Call ShipmentsData.filterOrders with the collected criteria
                 alert("Ch·ª©c nƒÉng l∆∞u b·ªô l·ªçc ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t.");
                 hideFilterModal();
             }
             function handleFilterOverlayClick(e) { if (e.target === filterModal) hideFilterModal(); }

        } else {
             console.warn("‚ö†Ô∏è Thi·∫øu m·ªôt ho·∫∑c nhi·ªÅu element c·ªßa Filter Modal.");
        }


        // --- X·ª≠ l√Ω modal "C·∫≠p nh·∫≠t tr·∫°ng th√°i" (Status Modal) ---
        const statusModal = document.getElementById('statusModal');
        const closeStatusModalBtn = document.getElementById('closeStatusModalBtn'); // Corrected ID
        const cancelStatusBtn = document.getElementById('cancelStatusBtn');
        const confirmStatusBtn = document.getElementById('confirmStatusBtn');
        const statusModalTitle = document.getElementById('statusModalTitle');
        const statusModalOrderCode = document.getElementById('statusModalOrderCode');

        if (statusModal && closeStatusModalBtn && cancelStatusBtn && confirmStatusBtn && statusModalTitle && statusModalOrderCode) {
            // Attach listeners to call functions from ShipmentsData module
             closeStatusModalBtn.removeEventListener('click', handleCloseStatusModal);
            closeStatusModalBtn.addEventListener('click', handleCloseStatusModal);

             cancelStatusBtn.removeEventListener('click', handleCloseStatusModal);
            cancelStatusBtn.addEventListener('click', handleCloseStatusModal);

             confirmStatusBtn.removeEventListener('click', handleConfirmUpdateStatus);
            confirmStatusBtn.addEventListener('click', handleConfirmUpdateStatus);

             // Close on overlay click
             statusModal.removeEventListener('click', handleStatusOverlayClick);
             statusModal.addEventListener('click', handleStatusOverlayClick);

        } else {
             console.warn("‚ö†Ô∏è Thi·∫øu m·ªôt ho·∫∑c nhi·ªÅu element c·ªßa Status Modal.");
             // Disable update buttons in the table if modal is broken
             document.querySelectorAll('.btn-update').forEach(btn => btn.disabled = true);
        }


        // --- G·ªåI H√ÄM T·∫¢I D·ªÆ LI·ªÜU BAN ƒê·∫¶U ---
        if (window.ShipmentsData && typeof window.ShipmentsData.loadOrders === 'function') {
            console.log("üöÄ Calling ShipmentsData.loadOrders() from shipments.html init...");
            window.ShipmentsData.loadOrders();
        } else {
            console.error("‚ùå ShipmentsData or ShipmentsData.loadOrders not available!");
            showShipmentsPageError("L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ t·∫£i module d·ªØ li·ªáu v·∫≠n ƒë∆°n.");
        }
         // --- K·∫æT TH√öC G·ªåI H√ÄM T·∫¢I D·ªÆ LI·ªÜU ---

        // --- Th√™m n√∫t Refresh ---
        const mainActions = document.getElementById('mainActions');
        if (mainActions && !mainActions.querySelector('.btn-refresh')) { // Check if not already added
            const refreshBtn = document.createElement("button");
            refreshBtn.className = "btn btn-refresh"; // Use appropriate classes
            refreshBtn.style.backgroundColor = '#6c757d'; // Example style
            refreshBtn.style.color = 'white';
            refreshBtn.innerHTML = `<i class="fa-solid fa-rotate"></i> L√†m m·ªõi`;
            refreshBtn.removeEventListener('click', handleRefreshClick); // Prevent duplicates
            refreshBtn.addEventListener("click", handleRefreshClick);
            mainActions.appendChild(refreshBtn);
            console.log("üîß N√∫t L√†m m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.");
        }


        console.log("‚úÖ Shipments page UI Initialized"); // Log end of UI init
    } // --- End initShipmentsPage ---


    // --- Named Handlers for Modal Buttons and Refresh ---
    // (These call functions exposed by ShipmentsData module)
    function handleCloseStatusModal() {
        console.log("Listener: Closing status modal...");
        if (window.ShipmentsData && typeof window.ShipmentsData.closeStatusModal === 'function') {
            window.ShipmentsData.closeStatusModal();
        } else { console.error("ShipmentsData.closeStatusModal is not available"); }
    }

    function handleConfirmUpdateStatus() {
         console.log("Listener: Confirming status update...");
        if (window.ShipmentsData && typeof window.ShipmentsData.updateOrderStatus === 'function') {
            window.ShipmentsData.updateOrderStatus();
        } else { console.error("ShipmentsData.updateOrderStatus is not available"); }
    }
     function handleStatusOverlayClick(event) {
         const statusModal = document.getElementById('statusModal');
         if (event.target === statusModal) { // Check if click is on the overlay itself
             handleCloseStatusModal();
         }
     }
      function handleRefreshClick() {
         if (window.ShipmentsData && typeof window.ShipmentsData.loadOrders === 'function') {
             console.log("üîÑ Refresh button clicked, reloading orders...");
             window.ShipmentsData.loadOrders();
         } else { console.error("ShipmentsData.loadOrders is not available for refresh"); }
     }


    // --- LOGIC KI·ªÇM TRA ƒê·ªÇ G·ªåI H√ÄM INIT (gi·ªØ nguy√™n) ---
    if (document.readyState === "loading") {
        // Ch·∫°y ƒë·ªôc l·∫≠p: ƒê·ª£i DOM load xong
        document.addEventListener("DOMContentLoaded", initShipmentsPage);
    } else {
        // Ch·∫°y qua index.html (DOM ƒë√£ load): Ch·∫°y ngay!
        initShipmentsPage();
    }
    </script>
    <script src="assets/api/config.js"></script>
    <script src="assets/api/shipments-data.js"></script> </body>
</html>