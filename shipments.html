<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω v·∫≠n ƒë∆°n - Viettel Post</title>
    <link rel="stylesheet" href="assets/shipments.css"> <!-- Link CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

    <div class="page-container">
        <h1 class="page-title">Qu·∫£n l√Ω v·∫≠n ƒë∆°n</h1>
        <div class="card">
            <div class="card-body">
                <!-- 3.1. Thanh t√¨m ki·∫øm & b·ªô l·ªçc -->
                <div class="filter-area">
                    <div class="filter-main">
                        <!-- Primary Filter Row -->
                        <div class="filter-row primary-filters">
                            <!-- Search Input -->
                            <div class="filter-item search-bar">
                                <input type="text" id="shipmentSearchInput" placeholder="T√¨m m√£ ƒë∆°n h√†ng, SƒêT ng∆∞·ªùi g·ª≠i/nh·∫≠n">
                                <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
                            </div>
                            <!-- Date Picker -->
                            <div class="filter-item date-picker-wrapper">
                                <input type="text" id="dateRangePicker" placeholder="Ng√†y t·∫°o ƒë∆°n">
                                <i class="fa-regular fa-calendar-days calendar-icon"></i>
                            </div>
                            <!-- Kho H√†ng Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="warehouseFilter">
                                     <option value="">Kho h√†ng (T·∫•t c·∫£)</option>
                                     <!-- Options will be loaded dynamically -->
                                 </select>
                             </div>
                             <!-- Ng∆∞·ªùi Tr·∫£ C∆∞·ªõc Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="payerFilter">
                                     <option value="">Ng∆∞·ªùi tr·∫£ c∆∞·ªõc</option>
                                     <option value="sender">Ng∆∞·ªùi g·ª≠i tr·∫£</option>
                                     <option value="receiver">Ng∆∞·ªùi nh·∫≠n tr·∫£</option>
                                     <!-- <option value="third_party">B√™n th·ª© ba</option> -->
                                 </select>
                             </div>
                            <!-- Add Filter Button -->
                            <div class="filter-item add-filter-container">
                                <button class="add-filter-btn action-btn" id="addFilterBtn" title="Th√™m b·ªô l·ªçc">
                                     <i class="fas fa-filter"></i> Th√™m b·ªô l·ªçc
                                </button>
                            </div>
                        </div>
                        <!-- Secondary Filter Row (Initially Hidden) -->
                        <div class="filter-row secondary-filters hidden" id="secondaryFilters">
                             <!-- Lo·∫°i ƒê∆°n Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="orderTypeFilter">
                                     <option value="">Lo·∫°i ƒë∆°n</option>
                                     <option value="sent">ƒê∆°n h√†ng g·ª≠i</option>
                                     <option value="received">ƒê∆°n h√†ng nh·∫≠n</option>
                                 </select>
                             </div>
                            <!-- Tr·∫°ng Th√°i Thanh To√°n Dropdown -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="paymentStatusFilter">
                                    <option value="">Tr·∫°ng th√°i thanh to√°n</option>
                                    <option value="cod">COD</option>
                                    <option value="paid">ƒê√£ thanh to√°n</option>
                                    <option value="unpaid">Ch∆∞a thanh to√°n</option>
                                </select>
                             </div>
                            <!-- D·ªãch v·ª• Dropdown -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="serviceFilter">
                                    <option value="">D·ªãch v·ª•</option>
                                    <!-- Options populated from shipping_service.json -->
                                </select>
                             </div>
                             <!-- Lo·∫°i H√†ng Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="packageTypeFilter">
                                     <option value="">Lo·∫°i h√†ng</option>
                                     <!-- Options populated from package_type.json -->
                                 </select>
                             </div>
                            <!-- Tr·∫°ng th√°i ƒë·ªëi so√°t COD -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="codStatusFilter">
                                    <option value="">Tr·∫°ng th√°i ƒë·ªëi so√°t COD</option>
                                    <option value="reconciled">ƒê√£ ƒë·ªëi so√°t</option>
                                    <option value="pending">Ch·ªù ƒë·ªëi so√°t</option>
                                    <option value="failed">ƒê·ªëi so√°t l·ªói</option>
                                </select>
                            </div>
                             <!-- Lo·∫°i ƒë∆°n h√†ng (Category) -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="orderCategoryFilter">
                                    <option value="">Lo·∫°i ƒë∆°n h√†ng</option>
                                    <option value="ecommerce">TMƒêT</option>
                                    <option value="retail">B√°n l·∫ª</option>
                                    <option value="personal">C√° nh√¢n</option>
                                    <!-- Add more as needed -->
                                </select>
                            </div>
                            <!-- Nh√≥m kh√°ch h√†ng -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="customerGroupFilter">
                                     <option value="">Nh√≥m kh√°ch h√†ng</option>
                                      <option value="vip">VIP</option>
                                      <option value="close">Th√¢n thi·∫øt</option> <!-- Use code 'CLOSE' -->
                                      <option value="new">M·ªõi</option>
                                      <!-- Add more as needed -->
                                 </select>
                             </div>
                            <!-- T√†i kho·∫£n t·∫°o ƒë∆°n Dropdown (Optional) -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="accountFilter" disabled>
                                    <option value="">T√†i kho·∫£n t·∫°o ƒë∆°n (T·∫•t c·∫£)</option>
                                    <!-- Options populated if user has sub-accounts -->
                                </select>
                            </div>
                        </div>
                    </div>
                     <!-- 3.2. H√†nh ƒë·ªông ch√≠nh -->
                    <div class="filter-actions">
                        <button class="action-btn" id="printBtn"><i class="fas fa-print"></i> IN ƒê∆†N</button>
                        <button class="action-btn" id="exportExcelBtn"><i class="fas fa-file-excel"></i> XU·∫§T EXCEL</button>
                        <button class="action-btn" id="importExcelBtn"><i class="fas fa-file-upload"></i> NH·∫¨P EXCEL</button>
                        <button class="action-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> L√ÄM M·ªöI</button>
                    </div>
                </div>

                 <!-- Last Updated Time -->
                 <div class="last-updated">
                     C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lastUpdatedTime">--:--</span>
                 </div>

                <!-- 3.3. B·ªô ƒë·∫øm & tab tr·∫°ng th√°i -->
                <div class="status-tabs" id="statusTabsContainer">
                    <!-- Tabs will be generated by JS -->
                    <div class="tab-item active" data-status-code="">
                        T·∫•t c·∫£ (<span class="count">0</span>)
                    </div>
                </div>

                <!-- 3.4. B·∫£ng d·ªØ li·ªáu v·∫≠n ƒë∆°n -->
                <div class="table-area">
                    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
                         <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
                    </div>
                    <div class="no-results" id="noResults" style="display: none;">
                        Kh√¥ng t√¨m th·∫•y v·∫≠n ƒë∆°n n√†o ph√π h·ª£p.
                    </div>
                    <div class="table-responsive">
                        <table>
                           <thead>
                            <tr>
                                <th>STT</th>
                                <th>M√£ ƒë∆°n</th>
                                <th>Ng∆∞·ªùi g·ª≠i</th>
                                <th>Ng∆∞·ªùi nh·∫≠n</th>
                                <th>ƒê·ªãa ch·ªâ nh·∫≠n</th>
                                <th>Lo·∫°i h√†ng</th>
                                <th>D·ªãch v·ª•</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>COD</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                            <tbody id="shipmentsTableBody">
                                <!-- Table rows will be generated by JS -->
                                <tr><td colspan="8" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                 <!-- Pagination -->
                <div class="pagination" id="paginationControls">
                    <div class="records-per-page">
                        <span>B·∫£n Ghi M·ªói Trang</span>
                        <select id="itemsPerPageSelect">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="page-info">
                        <span id="paginationInfo">Hi·ªÉn th·ªã 0 - 0 c·ªßa 0</span>
                        <div class="nav-arrows">
                            <button id="firstPageBtn" disabled>&lt;&lt;</button>
                            <button id="prevPageBtn" disabled>&lt;</button>
                            <button id="nextPageBtn" disabled>&gt;</button>
                            <button id="lastPageBtn" disabled>&gt;&gt;</button>
                        </div>
                    </div>
                </div>

                 <!-- 10. B·ªï sung th√¥ng tin th·ªëng k√™ ·ªü cu·ªëi trang -->
                 <div class="summary-footer" id="summaryFooter">
                      <div class="summary-item">
                          <span class="summary-label">T·ªïng ƒë∆°n h√†ng:</span>
                          <strong class="summary-value" id="totalOrdersSummary">0</strong>
                      </div>
                      <div class="summary-item">
                          <span class="summary-label">T·ªïng thu h·ªô (COD):</span>
                          <strong class="summary-value" id="totalCodSummary">0 ‚Ç´</strong>
                      </div>
                      <div class="summary-item">
                          <span class="summary-label">T·ªïng c∆∞·ªõc:</span>
                          <strong class="summary-value" id="totalShippingCostSummary">0 ‚Ç´</strong>
                      </div>
                  </div>

            </div>
        </div>
    </div>

    <!-- Edit Order Info Modal -->
<div id="editOrderInfoModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="editModalTitle">C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editOrderForm">
                <input type="hidden" id="editingOrderId" name="orderId">
                
                <div class="form-group">
                    <label for="editOrderIdDisplay">M√£ ƒë∆°n h√†ng:</label>
                    <span id="editOrderId" class="order-id-display"></span>
                </div>

                <div class="form-group">
                    <label for="editStatusSelect">Tr·∫°ng th√°i m·ªõi <span class="required">*</span></label>
                    <select id="editStatusSelect" name="statusCode" required>
                        <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                        <!-- Options s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                    </select>
                </div>

                <div id="editModalError" class="error-message hidden"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="ShipmentsData.closeEditModal()">H·ªßy</button>
            <button type="button" id="saveEditBtn" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
        </div>
    </div>
</div>


    <!-- Include necessary JS files -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
    <script src="assets/api/config.js"></script> <!-- Load config first -->
    <script src="assets/fetchData/address.js"></script> <!-- Load AddressData -->
    <script src="assets/api/shipments-data.js"></script> <!-- Load data logic -->

    <script>
    // --- B·ªåC T·∫§T C·∫¢ V√ÄO H√ÄM INIT ---
    function initShipmentsPage() {
        console.log("üöÄ Initializing Shipments Page UI...");

        // --- Helper function to show errors ---
         function showShipmentsPageError(message) {
             const errorDiv = document.querySelector('.table-area .no-results'); // Use existing no-results div
             if (errorDiv) {
                 errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> L·ªói: ${message}`; // Use innerHTML
                 errorDiv.style.display = 'block';
                 errorDiv.classList.add('error'); // Use class for styling
             } else { console.error("L·ªñI HI·ªÇN TH·ªä:", message); }
             const spinner = document.getElementById('loadingSpinner');
             if (spinner) spinner.style.display = 'none';
         }
         // Function to hide error message
         function hideShipmentsPageError() {
              const errorDiv = document.querySelector('.table-area .no-results.error');
              if (errorDiv) {
                  errorDiv.textContent = 'Kh√¥ng t√¨m th·∫•y v·∫≠n ƒë∆°n n√†o ph√π h·ª£p.'; // Reset default text
                  errorDiv.style.display = 'none'; // Hide
                  errorDiv.classList.remove('error'); // Remove error class
              }
          }


        // --- Initialize Flatpickr ---
        if (typeof flatpickr !== 'undefined') {
            flatpickr("#dateRangePicker", {
                mode: "range", dateFormat: "d/m/Y", locale: "vn",
                monthSelectorType: 'static', showMonths: 2,
                onReady: function(selectedDates, dateStr, instance) {
                    console.log("üìÖ Flatpickr #dateRangePicker s·∫µn s√†ng.");
                    const shortcuts = document.createElement('div');
                    shortcuts.className = 'flatpickr-shortcuts';
                    const options = ['H√¥m nay', 'H√¥m qua', '7 ng√†y tr∆∞·ªõc', '14 ng√†y tr∆∞·ªõc', '30 ng√†y tr∆∞·ªõc', 'Th√°ng n√†y', 'Th√°ng tr∆∞·ªõc'];

                    options.forEach(optionText => {
                        const btn = document.createElement('button');
                        btn.className = 'shortcut-button';
                        btn.textContent = optionText;
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const now = new Date(); let start, end;
                            switch(optionText) {
                                case 'H√¥m nay': start = new Date(now); end = new Date(now); break;
                                case 'H√¥m qua': start = new Date(now); start.setDate(now.getDate() - 1); end = new Date(start); break;
                                case '7 ng√†y tr∆∞·ªõc': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 6); break;
                                case '14 ng√†y tr∆∞·ªõc': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 13); break;
                                case '30 ng√†y tr∆∞·ªõc': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 29); break;
                                case 'Th√°ng n√†y': start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); break;
                                case 'Th√°ng tr∆∞·ªõc': start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); break;
                            }
                            shortcuts.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            instance.setDate([start, end], true); // Set date and trigger onChange
                        });
                        shortcuts.appendChild(btn);
                    });
                     if(instance.calendarContainer) instance.calendarContainer.prepend(shortcuts);
                },
                onChange: function(selectedDates, dateStr, instance) {
                     console.log('üóìÔ∏è Date range changed:', dateStr);
                     instance.calendarContainer?.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));
                     // Trigger data reload in ShipmentsData
                     if (window.ShipmentsData?.handleFilterChange) {
                         window.ShipmentsData.handleFilterChange();
                     }
                }
            });
        } else {
            console.error("‚ùå Th∆∞ vi·ªán Flatpickr ch∆∞a ƒë∆∞·ª£c t·∫£i!");
            showShipmentsPageError("Kh√¥ng th·ªÉ kh·ªüi t·∫°o b·ªô ch·ªçn ng√†y.");
            const datePickerInput = document.getElementById('dateRangePicker');
            if (datePickerInput) datePickerInput.placeholder = "L·ªói t·∫£i l·ªãch";
        }


        // --- Initialize ShipmentsData module ---
         hideShipmentsPageError(); // Hide any previous error
         if (window.ShipmentsData?.init) {
             console.log("üöÄ Calling ShipmentsData.init()...");
             window.ShipmentsData.init(); // G·ªçi init c·ªßa module data
         } else {
             console.error("‚ùå ShipmentsData module or init function not found!");
             showShipmentsPageError("L·ªói t·∫£i module d·ªØ li·ªáu v·∫≠n ƒë∆°n.");
             const tbody = document.getElementById("shipmentsTableBody");
             if (tbody) tbody.innerHTML = `<tr><td colspan="8" class="no-data">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
         }

        // --- Bind Event Listeners for Filters and Actions ---
        const searchInput = document.getElementById('shipmentSearchInput');
        const searchBtn = document.getElementById('searchBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const addFilterBtn = document.getElementById('addFilterBtn');
        const secondaryFilters = document.getElementById('secondaryFilters');
        const statusTabsContainer = document.getElementById('statusTabsContainer');
        const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        // Filter selects
        const primaryFilters = document.querySelectorAll('.primary-filters select'); // Select only primary selects
        const allSecondaryFilters = document.querySelectorAll('.secondary-filters select');

        const triggerFilter = () => {
             if (window.ShipmentsData?.handleFilterChange) {
                 window.ShipmentsData.handleFilterChange();
             } else { console.warn("ShipmentsData.handleFilterChange not available"); }
         };

        if (searchBtn) searchBtn.addEventListener('click', triggerFilter);
        if (searchInput) searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') triggerFilter(); });
        if (refreshBtn) refreshBtn.addEventListener('click', () => {
             // Let ShipmentsData handle reset logic internally via handleFilterChange(true)
             if (window.ShipmentsData?.handleFilterChange) {
                 console.log("üîÑ Refresh button clicked, calling handleFilterChange(true)...");
                 window.ShipmentsData.handleFilterChange(true); // Pass true for full reset
             } else { console.error("ShipmentsData.handleFilterChange is not available for refresh"); }
         });

        // Add listeners for ALL filter selects (primary and secondary)
         primaryFilters.forEach(select => {
             if (select) select.addEventListener('change', triggerFilter);
         });
         allSecondaryFilters.forEach(select => {
            if (select) select.addEventListener('change', triggerFilter);
         });

        // Toggle secondary filters
        if (addFilterBtn && secondaryFilters) {
            addFilterBtn.addEventListener('click', () => {
                secondaryFilters.classList.toggle('hidden');
                addFilterBtn.classList.toggle('active');
                 // Change icon based on state
                const icon = addFilterBtn.querySelector('i');
                if(icon) {
                    icon.className = secondaryFilters.classList.contains('hidden') ? 'fas fa-filter' : 'fas fa-times';
                }
                // Reset secondary filters when hiding
                if (secondaryFilters.classList.contains('hidden') && window.ShipmentsData?.resetSecondaryFilters) {
                     window.ShipmentsData.resetSecondaryFilters(); // Reset state
                     triggerFilter(); // Re-apply primary filters
                 }
            });
        }


        // --- FIXED: Status Tab clicks (delegation) ---
        if (statusTabsContainer) {
            statusTabsContainer.addEventListener('click', (event) => {
                const tab = event.target.closest('.tab-item'); // Find the clicked tab item
                if (tab && !tab.classList.contains('active')) { // Check if it's a tab and not already active
                    const statusCode = tab.dataset.statusCode;
                    console.log(`Tab clicked: ${statusCode || 'T·∫•t c·∫£'}`);

                    // Call the data module handler
                    if (window.ShipmentsData?.handleStatusFilterChange) {
                        window.ShipmentsData.handleStatusFilterChange(statusCode);
                         // Visual update is now handled INSIDE handleStatusFilterChange
                    } else {
                        console.warn("ShipmentsData.handleStatusFilterChange not available");
                    }
                }
            });
        } else { console.warn("Status tabs container not found for event listener."); }

        // Pagination listeners
        if (itemsPerPageSelect) {
             itemsPerPageSelect.addEventListener('change', (e) => {
                 if (window.ShipmentsData?.handleItemsPerPageChange) {
                     window.ShipmentsData.handleItemsPerPageChange(parseInt(e.target.value, 10));
                 }
             });
        }
         const setupPaginationButton = (buttonId, action) => {
             const btn = document.getElementById(buttonId);
             if (btn) {
                 btn.addEventListener('click', () => {
                     if (!btn.disabled && window.ShipmentsData?.handlePageChange) {
                         window.ShipmentsData.handlePageChange(action);
                     }
                 });
             }
         };
         setupPaginationButton('firstPageBtn', 'first');
         setupPaginationButton('prevPageBtn', 'prev');
         setupPaginationButton('nextPageBtn', 'next');
         setupPaginationButton('lastPageBtn', 'last');


        // --- Placeholder listeners for Action Buttons ---
         const printBtn = document.getElementById('printBtn');
         const exportExcelBtn = document.getElementById('exportExcelBtn');
         const importExcelBtn = document.getElementById('importExcelBtn');

         if(printBtn) printBtn.addEventListener('click', () => { console.log('TODO: Implement Print Action'); alert('Ch·ª©c nƒÉng In ƒë∆°n ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai.'); });
         if(exportExcelBtn) exportExcelBtn.addEventListener('click', () => { console.log('TODO: Implement Export Excel Action'); alert('Ch·ª©c nƒÉng Xu·∫•t Excel ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai.'); });
         if(importExcelBtn) importExcelBtn.addEventListener('click', () => { console.log('TODO: Implement Import Excel Action'); alert('Ch·ª©c nƒÉng Nh·∫≠p Excel ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai.'); });

         // --- FIXED: Edit Button listener (delegation) ---
         const tableBody = document.getElementById('shipmentsTableBody');
         if (tableBody) {
             tableBody.addEventListener('click', (event) => {
                 const editButton = event.target.closest('button.btn-edit'); // Find the clicked edit button
                 if (editButton && !editButton.disabled) {
                     const orderId = editButton.dataset.orderId;
                     console.log(`Edit button listener triggered for order: ${orderId}`);
                     if (orderId && window.ShipmentsData?.openEditModal) {
                         window.ShipmentsData.openEditModal(orderId); // Call the function from ShipmentsData
                     } else {
                          console.warn("Could not open edit modal - orderId or function missing", orderId);
                     }
                 }
             });
         } else { console.warn("Table body not found for edit button listener."); }

         // --- FIXED: Edit Modal Listeners ---
         const editModal = document.getElementById('editOrderInfoModal');
         const editForm = document.getElementById('editOrderForm');
         if (editModal) {
             // Close buttons
             editModal.querySelectorAll('[data-action="close-edit-modal"]').forEach(btn => {
                  btn.addEventListener('click', () => {
                      if(window.ShipmentsData?.closeEditModal) window.ShipmentsData.closeEditModal();
                  });
             });
             // Close on overlay click
             editModal.addEventListener('click', (event) => {
                 if (event.target === editModal) { // Clicked on the overlay itself
                      if(window.ShipmentsData?.closeEditModal) window.ShipmentsData.closeEditModal();
                 }
             });
         }
         if (editForm) {
    // Form submission - s·ª≠a th√†nh click event cho button
    const saveEditBtn = document.getElementById('saveEditBtn');
    if (saveEditBtn) {
        saveEditBtn.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default browser submission
            if(window.ShipmentsData?.handleSaveEdit) {
                window.ShipmentsData.handleSaveEdit(); // G·ªçi kh√¥ng c√≥ tham s·ªë
            } else {
                 console.warn("Save handler (ShipmentsData.handleSaveEdit) not found.");
            }
        });
    }
}


        console.log("‚úÖ Shipments Page UI Initialized and event listeners bound.");
    } // --- End initShipmentsPage ---


    // --- LOGIC KI·ªÇM TRA ƒê·ªÇ G·ªåI H√ÄM INIT ---
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initShipmentsPage);
    } else {
        // If loaded dynamically after DOM is ready, call directly
        initShipmentsPage();
    }
    </script>
</body>
</html>

