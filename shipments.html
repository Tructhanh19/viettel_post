<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý vận đơn - Viettel Post</title>
    <link rel="stylesheet" href="assets/shipments.css"> <!-- Link CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

    <div class="page-container">
        <h1 class="page-title">Quản lý vận đơn</h1>
        <div class="card">
            <div class="card-body">
                <!-- 3.1. Thanh tìm kiếm & bộ lọc -->
                <div class="filter-area">
                    <div class="filter-main">
                        <!-- Primary Filter Row -->
                        <div class="filter-row primary-filters">
                            <!-- Search Input -->
                            <div class="filter-item search-bar">
                                <input type="text" id="shipmentSearchInput" placeholder="Tìm mã đơn hàng, SĐT người gửi/nhận">
                                <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
                            </div>
                            <!-- Date Picker -->
                            <div class="filter-item date-picker-wrapper">
                                <input type="text" id="dateRangePicker" placeholder="Ngày tạo đơn">
                                <i class="fa-regular fa-calendar-days calendar-icon"></i>
                            </div>
                            <!-- Kho Hàng Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="warehouseFilter">
                                     <option value="">Kho hàng (Tất cả)</option>
                                     <!-- Options will be loaded dynamically -->
                                 </select>
                             </div>
                             <!-- Người Trả Cước Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="payerFilter">
                                     <option value="">Người trả cước</option>
                                     <option value="sender">Người gửi trả</option>
                                     <option value="receiver">Người nhận trả</option>
                                     <!-- <option value="third_party">Bên thứ ba</option> -->
                                 </select>
                             </div>
                            <!-- Add Filter Button -->
                            <div class="filter-item add-filter-container">
                                <button class="add-filter-btn action-btn" id="addFilterBtn" title="Thêm bộ lọc">
                                     <i class="fas fa-filter"></i> Thêm bộ lọc
                                </button>
                            </div>
                        </div>
                        <!-- Secondary Filter Row (Initially Hidden) -->
                        <div class="filter-row secondary-filters hidden" id="secondaryFilters">
                             <!-- Loại Đơn Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="orderTypeFilter">
                                     <option value="">Loại đơn</option>
                                     <option value="sent">Đơn hàng gửi</option>
                                     <option value="received">Đơn hàng nhận</option>
                                 </select>
                             </div>
                            <!-- Trạng Thái Thanh Toán Dropdown -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="paymentStatusFilter">
                                    <option value="">Trạng thái thanh toán</option>
                                    <option value="cod">COD</option>
                                    <option value="paid">Đã thanh toán</option>
                                    <option value="unpaid">Chưa thanh toán</option>
                                </select>
                             </div>
                            <!-- Dịch vụ Dropdown -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="serviceFilter">
                                    <option value="">Dịch vụ</option>
                                    <!-- Options populated from shipping_service.json -->
                                </select>
                             </div>
                             <!-- Loại Hàng Dropdown -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="packageTypeFilter">
                                     <option value="">Loại hàng</option>
                                     <!-- Options populated from package_type.json -->
                                 </select>
                             </div>
                            <!-- Trạng thái đối soát COD -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="codStatusFilter">
                                    <option value="">Trạng thái đối soát COD</option>
                                    <option value="reconciled">Đã đối soát</option>
                                    <option value="pending">Chờ đối soát</option>
                                    <option value="failed">Đối soát lỗi</option>
                                </select>
                            </div>
                             <!-- Loại đơn hàng (Category) -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="orderCategoryFilter">
                                    <option value="">Loại đơn hàng</option>
                                    <option value="ecommerce">TMĐT</option>
                                    <option value="retail">Bán lẻ</option>
                                    <option value="personal">Cá nhân</option>
                                    <!-- Add more as needed -->
                                </select>
                            </div>
                            <!-- Nhóm khách hàng -->
                             <div class="filter-item dropdown-wrapper">
                                 <select id="customerGroupFilter">
                                     <option value="">Nhóm khách hàng</option>
                                      <option value="vip">VIP</option>
                                      <option value="close">Thân thiết</option> <!-- Use code 'CLOSE' -->
                                      <option value="new">Mới</option>
                                      <!-- Add more as needed -->
                                 </select>
                             </div>
                            <!-- Tài khoản tạo đơn Dropdown (Optional) -->
                            <div class="filter-item dropdown-wrapper">
                                <select id="accountFilter" disabled>
                                    <option value="">Tài khoản tạo đơn (Tất cả)</option>
                                    <!-- Options populated if user has sub-accounts -->
                                </select>
                            </div>
                        </div>
                    </div>
                     <!-- 3.2. Hành động chính -->
                    <div class="filter-actions">
                        <button class="action-btn" id="printBtn"><i class="fas fa-print"></i> IN ĐƠN</button>
                        <button class="action-btn" id="exportExcelBtn"><i class="fas fa-file-excel"></i> XUẤT EXCEL</button>
                        <button class="action-btn" id="importExcelBtn"><i class="fas fa-file-upload"></i> NHẬP EXCEL</button>
                        <button class="action-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> LÀM MỚI</button>
                    </div>
                </div>

                 <!-- Last Updated Time -->
                 <div class="last-updated">
                     Cập nhật lần cuối: <span id="lastUpdatedTime">--:--</span>
                 </div>

                <!-- 3.3. Bộ đếm & tab trạng thái -->
                <div class="status-tabs" id="statusTabsContainer">
                    <!-- Tabs will be generated by JS -->
                    <div class="tab-item active" data-status-code="">
                        Tất cả (<span class="count">0</span>)
                    </div>
                </div>

                <!-- 3.4. Bảng dữ liệu vận đơn -->
                <div class="table-area">
                    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
                         <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                    </div>
                    <div class="no-results" id="noResults" style="display: none;">
                        Không tìm thấy vận đơn nào phù hợp.
                    </div>
                    <div class="table-responsive">
                        <table>
                           <thead>
                            <tr>
                                <th>STT</th>
                                <th>Mã đơn</th>
                                <th>Người gửi</th>
                                <th>Người nhận</th>
                                <th>Địa chỉ nhận</th>
                                <th>Loại hàng</th>
                                <th>Dịch vụ</th>
                                <th>Trạng thái</th>
                                <th>COD</th>
                                <th>Tổng tiền</th>
                                <th>Ngày tạo</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                            <tbody id="shipmentsTableBody">
                                <!-- Table rows will be generated by JS -->
                                <tr><td colspan="8" class="no-data">Chưa có dữ liệu</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                 <!-- Pagination -->
                <div class="pagination" id="paginationControls">
                    <div class="records-per-page">
                        <span>Bản Ghi Mỗi Trang</span>
                        <select id="itemsPerPageSelect">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="page-info">
                        <span id="paginationInfo">Hiển thị 0 - 0 của 0</span>
                        <div class="nav-arrows">
                            <button id="firstPageBtn" disabled>&lt;&lt;</button>
                            <button id="prevPageBtn" disabled>&lt;</button>
                            <button id="nextPageBtn" disabled>&gt;</button>
                            <button id="lastPageBtn" disabled>&gt;&gt;</button>
                        </div>
                    </div>
                </div>

                 <!-- 10. Bổ sung thông tin thống kê ở cuối trang -->
                 <div class="summary-footer" id="summaryFooter">
                      <div class="summary-item">
                          <span class="summary-label">Tổng đơn hàng:</span>
                          <strong class="summary-value" id="totalOrdersSummary">0</strong>
                      </div>
                      <div class="summary-item">
                          <span class="summary-label">Tổng thu hộ (COD):</span>
                          <strong class="summary-value" id="totalCodSummary">0 ₫</strong>
                      </div>
                      <div class="summary-item">
                          <span class="summary-label">Tổng cước:</span>
                          <strong class="summary-value" id="totalShippingCostSummary">0 ₫</strong>
                      </div>
                  </div>

            </div>
        </div>
    </div>

    <!-- Edit Order Info Modal -->
<div id="editOrderInfoModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="editModalTitle">Cập nhật trạng thái đơn hàng</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editOrderForm">
                <input type="hidden" id="editingOrderId" name="orderId">
                
                <div class="form-group">
                    <label for="editOrderIdDisplay">Mã đơn hàng:</label>
                    <span id="editOrderId" class="order-id-display"></span>
                </div>

                <div class="form-group">
                    <label for="editStatusSelect">Trạng thái mới <span class="required">*</span></label>
                    <select id="editStatusSelect" name="statusCode" required>
                        <option value="">-- Chọn trạng thái --</option>
                        <!-- Options sẽ được điền bằng JavaScript -->
                    </select>
                </div>

                <div id="editModalError" class="error-message hidden"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="ShipmentsData.closeEditModal()">Hủy</button>
            <button type="button" id="saveEditBtn" class="btn btn-primary">Lưu thay đổi</button>
        </div>
    </div>
</div>


    <!-- Include necessary JS files -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
    <script src="assets/api/config.js"></script> <!-- Load config first -->
    <script src="assets/fetchData/address.js"></script> <!-- Load AddressData -->
    <script src="assets/api/shipments-data.js"></script> <!-- Load data logic -->

    <script>
    // --- BỌC TẤT CẢ VÀO HÀM INIT ---
    function initShipmentsPage() {
        console.log("🚀 Initializing Shipments Page UI...");

        // --- Helper function to show errors ---
         function showShipmentsPageError(message) {
             const errorDiv = document.querySelector('.table-area .no-results'); // Use existing no-results div
             if (errorDiv) {
                 errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Lỗi: ${message}`; // Use innerHTML
                 errorDiv.style.display = 'block';
                 errorDiv.classList.add('error'); // Use class for styling
             } else { console.error("LỖI HIỂN THỊ:", message); }
             const spinner = document.getElementById('loadingSpinner');
             if (spinner) spinner.style.display = 'none';
         }
         // Function to hide error message
         function hideShipmentsPageError() {
              const errorDiv = document.querySelector('.table-area .no-results.error');
              if (errorDiv) {
                  errorDiv.textContent = 'Không tìm thấy vận đơn nào phù hợp.'; // Reset default text
                  errorDiv.style.display = 'none'; // Hide
                  errorDiv.classList.remove('error'); // Remove error class
              }
          }


        // --- Initialize Flatpickr ---
        if (typeof flatpickr !== 'undefined') {
            flatpickr("#dateRangePicker", {
                mode: "range", dateFormat: "d/m/Y", locale: "vn",
                monthSelectorType: 'static', showMonths: 2,
                onReady: function(selectedDates, dateStr, instance) {
                    console.log("📅 Flatpickr #dateRangePicker sẵn sàng.");
                    const shortcuts = document.createElement('div');
                    shortcuts.className = 'flatpickr-shortcuts';
                    const options = ['Hôm nay', 'Hôm qua', '7 ngày trước', '14 ngày trước', '30 ngày trước', 'Tháng này', 'Tháng trước'];

                    options.forEach(optionText => {
                        const btn = document.createElement('button');
                        btn.className = 'shortcut-button';
                        btn.textContent = optionText;
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const now = new Date(); let start, end;
                            switch(optionText) {
                                case 'Hôm nay': start = new Date(now); end = new Date(now); break;
                                case 'Hôm qua': start = new Date(now); start.setDate(now.getDate() - 1); end = new Date(start); break;
                                case '7 ngày trước': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 6); break;
                                case '14 ngày trước': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 13); break;
                                case '30 ngày trước': end = new Date(now); start = new Date(now); start.setDate(now.getDate() - 29); break;
                                case 'Tháng này': start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); break;
                                case 'Tháng trước': start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); break;
                            }
                            shortcuts.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            instance.setDate([start, end], true); // Set date and trigger onChange
                        });
                        shortcuts.appendChild(btn);
                    });
                     if(instance.calendarContainer) instance.calendarContainer.prepend(shortcuts);
                },
                onChange: function(selectedDates, dateStr, instance) {
                     console.log('🗓️ Date range changed:', dateStr);
                     instance.calendarContainer?.querySelectorAll('.shortcut-button').forEach(b => b.classList.remove('active'));
                     // Trigger data reload in ShipmentsData
                     if (window.ShipmentsData?.handleFilterChange) {
                         window.ShipmentsData.handleFilterChange();
                     }
                }
            });
        } else {
            console.error("❌ Thư viện Flatpickr chưa được tải!");
            showShipmentsPageError("Không thể khởi tạo bộ chọn ngày.");
            const datePickerInput = document.getElementById('dateRangePicker');
            if (datePickerInput) datePickerInput.placeholder = "Lỗi tải lịch";
        }


        // --- Initialize ShipmentsData module ---
         hideShipmentsPageError(); // Hide any previous error
         if (window.ShipmentsData?.init) {
             console.log("🚀 Calling ShipmentsData.init()...");
             window.ShipmentsData.init(); // Gọi init của module data
         } else {
             console.error("❌ ShipmentsData module or init function not found!");
             showShipmentsPageError("Lỗi tải module dữ liệu vận đơn.");
             const tbody = document.getElementById("shipmentsTableBody");
             if (tbody) tbody.innerHTML = `<tr><td colspan="8" class="no-data">Lỗi tải dữ liệu</td></tr>`;
         }

        // --- Bind Event Listeners for Filters and Actions ---
        const searchInput = document.getElementById('shipmentSearchInput');
        const searchBtn = document.getElementById('searchBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const addFilterBtn = document.getElementById('addFilterBtn');
        const secondaryFilters = document.getElementById('secondaryFilters');
        const statusTabsContainer = document.getElementById('statusTabsContainer');
        const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        // Filter selects
        const primaryFilters = document.querySelectorAll('.primary-filters select'); // Select only primary selects
        const allSecondaryFilters = document.querySelectorAll('.secondary-filters select');

        const triggerFilter = () => {
             if (window.ShipmentsData?.handleFilterChange) {
                 window.ShipmentsData.handleFilterChange();
             } else { console.warn("ShipmentsData.handleFilterChange not available"); }
         };

        if (searchBtn) searchBtn.addEventListener('click', triggerFilter);
        if (searchInput) searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') triggerFilter(); });
        if (refreshBtn) refreshBtn.addEventListener('click', () => {
             // Let ShipmentsData handle reset logic internally via handleFilterChange(true)
             if (window.ShipmentsData?.handleFilterChange) {
                 console.log("🔄 Refresh button clicked, calling handleFilterChange(true)...");
                 window.ShipmentsData.handleFilterChange(true); // Pass true for full reset
             } else { console.error("ShipmentsData.handleFilterChange is not available for refresh"); }
         });

        // Add listeners for ALL filter selects (primary and secondary)
         primaryFilters.forEach(select => {
             if (select) select.addEventListener('change', triggerFilter);
         });
         allSecondaryFilters.forEach(select => {
            if (select) select.addEventListener('change', triggerFilter);
         });

        // Toggle secondary filters
        if (addFilterBtn && secondaryFilters) {
            addFilterBtn.addEventListener('click', () => {
                secondaryFilters.classList.toggle('hidden');
                addFilterBtn.classList.toggle('active');
                 // Change icon based on state
                const icon = addFilterBtn.querySelector('i');
                if(icon) {
                    icon.className = secondaryFilters.classList.contains('hidden') ? 'fas fa-filter' : 'fas fa-times';
                }
                // Reset secondary filters when hiding
                if (secondaryFilters.classList.contains('hidden') && window.ShipmentsData?.resetSecondaryFilters) {
                     window.ShipmentsData.resetSecondaryFilters(); // Reset state
                     triggerFilter(); // Re-apply primary filters
                 }
            });
        }


        // --- FIXED: Status Tab clicks (delegation) ---
        if (statusTabsContainer) {
            statusTabsContainer.addEventListener('click', (event) => {
                const tab = event.target.closest('.tab-item'); // Find the clicked tab item
                if (tab && !tab.classList.contains('active')) { // Check if it's a tab and not already active
                    const statusCode = tab.dataset.statusCode;
                    console.log(`Tab clicked: ${statusCode || 'Tất cả'}`);

                    // Call the data module handler
                    if (window.ShipmentsData?.handleStatusFilterChange) {
                        window.ShipmentsData.handleStatusFilterChange(statusCode);
                         // Visual update is now handled INSIDE handleStatusFilterChange
                    } else {
                        console.warn("ShipmentsData.handleStatusFilterChange not available");
                    }
                }
            });
        } else { console.warn("Status tabs container not found for event listener."); }

        // Pagination listeners
        if (itemsPerPageSelect) {
             itemsPerPageSelect.addEventListener('change', (e) => {
                 if (window.ShipmentsData?.handleItemsPerPageChange) {
                     window.ShipmentsData.handleItemsPerPageChange(parseInt(e.target.value, 10));
                 }
             });
        }
         const setupPaginationButton = (buttonId, action) => {
             const btn = document.getElementById(buttonId);
             if (btn) {
                 btn.addEventListener('click', () => {
                     if (!btn.disabled && window.ShipmentsData?.handlePageChange) {
                         window.ShipmentsData.handlePageChange(action);
                     }
                 });
             }
         };
         setupPaginationButton('firstPageBtn', 'first');
         setupPaginationButton('prevPageBtn', 'prev');
         setupPaginationButton('nextPageBtn', 'next');
         setupPaginationButton('lastPageBtn', 'last');


        // --- Placeholder listeners for Action Buttons ---
         const printBtn = document.getElementById('printBtn');
         const exportExcelBtn = document.getElementById('exportExcelBtn');
         const importExcelBtn = document.getElementById('importExcelBtn');

         if(printBtn) printBtn.addEventListener('click', () => { console.log('TODO: Implement Print Action'); alert('Chức năng In đơn chưa được triển khai.'); });
         if(exportExcelBtn) exportExcelBtn.addEventListener('click', () => { console.log('TODO: Implement Export Excel Action'); alert('Chức năng Xuất Excel chưa được triển khai.'); });
         if(importExcelBtn) importExcelBtn.addEventListener('click', () => { console.log('TODO: Implement Import Excel Action'); alert('Chức năng Nhập Excel chưa được triển khai.'); });

         // --- FIXED: Edit Button listener (delegation) ---
         const tableBody = document.getElementById('shipmentsTableBody');
         if (tableBody) {
             tableBody.addEventListener('click', (event) => {
                 const editButton = event.target.closest('button.btn-edit'); // Find the clicked edit button
                 if (editButton && !editButton.disabled) {
                     const orderId = editButton.dataset.orderId;
                     console.log(`Edit button listener triggered for order: ${orderId}`);
                     if (orderId && window.ShipmentsData?.openEditModal) {
                         window.ShipmentsData.openEditModal(orderId); // Call the function from ShipmentsData
                     } else {
                          console.warn("Could not open edit modal - orderId or function missing", orderId);
                     }
                 }
             });
         } else { console.warn("Table body not found for edit button listener."); }

         // --- FIXED: Edit Modal Listeners ---
         const editModal = document.getElementById('editOrderInfoModal');
         const editForm = document.getElementById('editOrderForm');
         if (editModal) {
             // Close buttons
             editModal.querySelectorAll('[data-action="close-edit-modal"]').forEach(btn => {
                  btn.addEventListener('click', () => {
                      if(window.ShipmentsData?.closeEditModal) window.ShipmentsData.closeEditModal();
                  });
             });
             // Close on overlay click
             editModal.addEventListener('click', (event) => {
                 if (event.target === editModal) { // Clicked on the overlay itself
                      if(window.ShipmentsData?.closeEditModal) window.ShipmentsData.closeEditModal();
                 }
             });
         }
         if (editForm) {
    // Form submission - sửa thành click event cho button
    const saveEditBtn = document.getElementById('saveEditBtn');
    if (saveEditBtn) {
        saveEditBtn.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default browser submission
            if(window.ShipmentsData?.handleSaveEdit) {
                window.ShipmentsData.handleSaveEdit(); // Gọi không có tham số
            } else {
                 console.warn("Save handler (ShipmentsData.handleSaveEdit) not found.");
            }
        });
    }
}


        console.log("✅ Shipments Page UI Initialized and event listeners bound.");
    } // --- End initShipmentsPage ---


    // --- LOGIC KIỂM TRA ĐỂ GỌI HÀM INIT ---
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initShipmentsPage);
    } else {
        // If loaded dynamically after DOM is ready, call directly
        initShipmentsPage();
    }
    </script>
</body>
</html>

